C*MODULE RSM_SDDINT  *DECK RSM_CLVDUM
C>
C>    @brief   compute electrostatic interaction between the ABS and
C>             solvent site 
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   NRAD: the number of grid points
C>             NATB: the numebr of solvent site
C>             QV: the atomic charges of solvent site
C>             RLN: grid points
C>             V: electrostatic interaction
C> 
      SUBROUTINE RSM_CLVDUM(NRAD,NATB,QV,RLN,V)
C
      USE RISM_MOD, ONLY : RSM_ISTIEND, GOPARR
      USE ABSMOD,   ONLY : TQ, NQMT0A, NSHEL0A

      IMPLICIT NONE
C
      INTEGER,          INTENT(IN   ) :: NRAD, NATB
      DOUBLE PRECISION, INTENT(IN   ) :: QV(*), RLN(NRAD)
      DOUBLE PRECISION, INTENT(  OUT) :: V(NRAD,NATB,*)
C
      INTEGER              :: ISTRT, IEND, IDUMMY, IATB, IRAD, II, JJ

      DOUBLE PRECISION                :: XAB(3), E02X, R1, VAL
      DOUBLE PRECISION, ALLOCATABLE   :: DUM(:), WRK(:,:,:)
C
      CALL RSM_ISTIEND(NSHEL0A,ISTRT,IEND,IDUMMY)
C
      ALLOCATE(DUM(NSHEL0A),WRK(NSHEL0A,NRAD,NATB))
C
C    
C
      DUM = 1.0D+00
      WRK = 0.0D+00
      DO IATB=1,NATB
        DO IRAD=1,NRAD
          R1 = RLN(IRAD)
C
          XAB(1) = 0.0D+00
          XAB(2) = 0.0D+00
          XAB(3) = R1
          DO II=ISTRT,IEND
C
C         ----- ENE02
C
            E02X  = 0.0D+00
            CALL RSM_INT02X(II,II,XAB,DUM,QV(IATB),E02X)
C
C         ----- TOTAL
C

            WRK(II,IRAD,IATB) = -E02X

          ENDDO
        ENDDO 
      ENDDO
C
      IF(GOPARR) CALL RSM_GSUMF(10013,WRK,NRAD*NATB*NSHEL0A)
C
      DO IATB=1,NATB
        DO IRAD=1,NRAD
          DO II=1,NQMT0A
            VAL = 0.0D+00
            DO JJ=1,NSHEL0A
              VAL = VAL + TQ(JJ,II)*WRK(JJ,IRAD,IATB)
            ENDDO
            V(IRAD,IATB,II) = VAL
          ENDDO
        ENDDO
      ENDDO
C
      DEALLOCATE(DUM,WRK)
C
      END
C*MODULE RSM_SDDINT  *DECK RSM_INT02X
C>
C>    @brief   integral for electrostatic interaction 
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   IST0A: starting point in parallel calculation 
C>             IEN0A: ending point in parallel calculation
C>             XAB: distance from the center of atom to the grid point
C>             DMT0A: all-ones vector
C>             ZANB: the atomic charge of solvent site
C>             E02X: electrostatic interaction
C>
      SUBROUTINE RSM_INT02X(IST0A,IEN0A,XAB,DMT0A,ZANB,E02X)
C
      USE ABSMOD, ONLY : KTYP0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, EX0A, 
     *                   COF0A, TRN3
C
      IMPLICIT NONE

      INTEGER,          INTENT(IN   ) :: IST0A, IEN0A
      DOUBLE PRECISION, INTENT(IN   ) :: XAB(*), DMT0A(*), ZANB
      DOUBLE PRECISION, INTENT(  OUT) :: E02X
C
      INTEGER                :: IJX(36),IJY(36),IJZ(36),
     *                          IX(10),IY(10),IZ(10),
     *                          JX(10),JY(10),JZ(10)
      DOUBLE PRECISION       :: XIN(343),YIN(343),ZIN(343),VBLK(36)
C
      INTEGER          :: NROOTS
      DOUBLE PRECISION :: XX, U, W
      COMMON /ROOT  / XX,U(13),W(13),NROOTS

      INTEGER          :: NI,NJ
      DOUBLE PRECISION :: XINT,YINT,ZINT,TAA,X0,Y0,Z0,XI,YI,ZI,XJ,YJ,ZJ
      COMMON /RSSTV / XINT,YINT,ZINT,TAA,X0,Y0,Z0,
     *                XI,YI,ZI,XJ,YJ,ZJ,NI,NJ
C
      DOUBLE PRECISION, PARAMETER :: PI212=1.1283791670955D+00
C
      DATA JX /0, 1, 0 ,0, 2, 0, 0, 1, 1, 0/
      DATA JY /0, 0, 1 ,0, 0, 2, 0, 1, 0, 1/
      DATA JZ /0, 0, 0 ,1, 0, 0, 2, 0, 1, 1/

      DATA IX /1, 4, 1, 1, 7, 1, 1, 4, 4, 1/
      DATA IY /1, 1, 4, 1, 1, 7, 1, 4, 1, 4/
      DATA IZ /1, 1, 1, 4, 1, 1, 7, 1, 4, 4/
C
      INTEGER :: LIT, LJT, I1, I2, J1, J2, MINI, MAXI, MINJ, MAXJ, INDX,
     *           I, J, K, IJ, II, IG, JG, NX, NY, NZ, IN, JN, NN, MM

      DOUBLE PRECISION :: AI, AJ, AA, AA1, COFI, COFJ, CX, CY, CZ, 
     *                    AAX, AAY, AAZ, VAL, UU, TT, DUM, ZNUC, WW, DIJ
C
C     ----- I SHELL -----
C
      CX = XAB(1)
      CY = XAB(2)
      CZ = XAB(3)

      DO II = IST0A,IEN0A
        XI   = 0.0D+00
        YI   = 0.0D+00
        ZI   = 0.0D+00
        XJ   = XI
        YJ   = YI
        ZJ   = ZI

        LIT  = KTYP0A(II)
        LJT  = LIT

        I1   = KSTRT0A(II)
        I2   = I1 + KNG0A(II) - 1

        J1   = I1
        J2   = I2

        MINI = KMIN0A(II)
        MAXI = KMAX0A(II)
        MINJ = MINI
        MAXJ = MAXI
C
        NROOTS = (LIT+LJT-2)/2+1
C
C     ----- PREPARE INDICES FOR PAIRS OF (I,J) FUNCTIONS
C
        IJ = 0
        DO I = MINI,MAXI
          NX = IX(I)
          NY = IY(I)
          NZ = IZ(I)
          DO J=MINI,MAXI
            IJ = IJ + 1

            IJX(IJ) = NX+JX(J)
            IJY(IJ) = NY+JY(J)
            IJZ(IJ) = NZ+JZ(J)
          ENDDO
        ENDDO
C
        VBLK = 0.0D+00
        DO IG=I1,I2
          AI   = EX0A(IG)
          COFI = COF0A(IG)

          DO JG =J1,J2
            AJ   = EX0A(JG)
            COFJ = COF0A(JG)

            AA  = AI + AJ
            AA1 = 1.0D+00/AA
C
C     ----- DENSITY FACTOR
C
            DIJ=COFI*COFJ*PI212*AA1
C
C     ----- NUCLEAR ATTRACTION
C
            AAX = AA*XI
            AAY = AA*YI
            AAZ = AA*ZI
C
            ZNUC = -ZANB

            XX = AA*((XI-CX)**2+(YI-CY)**2+(ZI-CZ)**2)

            IF (NROOTS.LE.3) CALL RT123

            MM = 0
            DO K = 1,NROOTS
              UU = AA*U(K)
              WW = W(K)*ZNUC
              TT = 1.0D+00/(AA+UU)
              TAA = SQRT(TT)
              X0 = (AAX+UU*CX)*TT
              Y0 = (AAY+UU*CY)*TT
              Z0 = (AAZ+UU*CZ)*TT
              IN = -3+MM
              DO I = 1,LIT
                IN = IN+3
                NI = I
                DO J = 1,LIT
                  JN = IN+J
                  NJ = J
                  CALL RSM_STVINT
                  XIN(JN) = XINT
                  YIN(JN) = YINT
                  ZIN(JN) = ZINT*WW
                ENDDO
              ENDDO
              MM = MM+9
            ENDDO

            INDX = 0
            DO I = MINI,MAXI
              DO J=MINJ,MAXJ
                INDX = INDX + 1

                NX = IJX(INDX)
                NY = IJY(INDX)
                NZ = IJZ(INDX)
                DUM = 0.0D+00
                MM = 0
                DO K = 1,NROOTS
                  DUM = DUM+XIN(NX+MM)*YIN(NY+MM)*ZIN(NZ+MM)
                  MM = MM+9
                ENDDO
                VBLK(INDX) = VBLK(INDX) + DUM*DIJ
              ENDDO
            ENDDO
C
C     ----- END OF PRIMITIVE LOOPS -----
C
          ENDDO
        ENDDO

        NN = 0
        VAL = 0.0D+00
        DO I = MINI,MAXI
          DO J=MINJ,MAXJ
            NN = NN + 1
 
            VAL = VAL + TRN3(J,I)*VBLK(NN)
          ENDDO
        ENDDO

        E02X = E02X + DMT0A(II)*VAL
C
C     ----- END OF SHELL LOOPS -----
C
      ENDDO

      RETURN
C
      END

C*MODULE RSM_SDDINT  *DECK RSM_STVINT
C>
C>    @brief   Gauss-Hermite quadrature using minimum point formula
C>
C>    @author  Daisuke Yokogawa
C>
      SUBROUTINE RSM_STVINT
C
      USE RISM_MOD, ONLY : MASWRK
      USE RISM_IO,  ONLY : IW
      USE RSMSED,   ONLY : H, W
C
      IMPLICIT NONE
C
      INTEGER          :: MIN(10),MAX(10)
C
      INTEGER          :: NI, NJ
      DOUBLE PRECISION :: XINT,YINT,ZINT,T,X0,Y0,Z0,XI,YI,ZI,XJ,YJ,ZJ
      COMMON /RSSTV / XINT,YINT,ZINT,T,X0,Y0,Z0,XI,YI,ZI,XJ,YJ,ZJ,NI,NJ
C
      DOUBLE PRECISION, PARAMETER :: ZERO=0.0D+00
C
      DATA MIN /1,2,4, 7,11,16,22,29,37,46/
      DATA MAX /1,3,6,10,15,21,28,36,45,55/
C
      INTEGER          :: NPTS, IMIN, IMAX, I
      DOUBLE PRECISION :: DUM, PX, PY, PZ, AX, AY, AZ, BX, BY, BZ
C
C     ----- GAUSS-HERMITE QUADRATURE USING MINIMUM POINT FORMULA -----
C     USE OF I FUNCTIONS WILL LET NI RUN UP TO 7 (S=1, P=2, ..., I=7)
C     USE OF I FUNCTIONS WILL LET NJ RUN UP TO 9 (FOR K.E. INTS)
C     USE OF I FUNCTIONS REQUIRES NPTS=8 TO DO KINETIC ENERGY INTEGRALS.
C
      IF(NI.GT.7  .OR.  NJ.GT.9) THEN
         IF(MASWRK) WRITE(IW,8000) NI,NJ
         CALL ABRT
      END IF
 8000 FORMAT(1X,'STVINT: EXCEEDED LIMITATIONS, WITH NI,NJ=',2I5)
C
      XINT = ZERO
      YINT = ZERO
      ZINT = ZERO
C
      NPTS = (NI+NJ-2)/2+1
      IMIN = MIN(NPTS)
      IMAX = MAX(NPTS)
C
      DO 400 I = IMIN,IMAX
         DUM = W(I)
         PX = DUM
         PY = DUM
         PZ = DUM
         DUM = H(I)*T
         IF(NI.GT.1) THEN
            AX = DUM+X0-XI
            AY = DUM+Y0-YI
            AZ = DUM+Z0-ZI
            GO TO (110,120,130,140,150,160,170), NI
  170       PX = PX*AX
            PY = PY*AY
            PZ = PZ*AZ
  160       PX = PX*AX
            PY = PY*AY
            PZ = PZ*AZ
  150       PX = PX*AX
            PY = PY*AY
            PZ = PZ*AZ
  140       PX = PX*AX
            PY = PY*AY
            PZ = PZ*AZ
  130       PX = PX*AX
            PY = PY*AY
            PZ = PZ*AZ
  120       PX = PX*AX
            PY = PY*AY
            PZ = PZ*AZ
  110       CONTINUE
         END IF
C
         IF(NJ.GT.1) THEN
            BX = DUM+X0-XJ
            BY = DUM+Y0-YJ
            BZ = DUM+Z0-ZJ
            GO TO (210,220,230,240,250,260,270,280,290), NJ
  290       PX = PX*BX
            PY = PY*BY
            PZ = PZ*BZ
  280       PX = PX*BX
            PY = PY*BY
            PZ = PZ*BZ
  270       PX = PX*BX
            PY = PY*BY
            PZ = PZ*BZ
  260       PX = PX*BX
            PY = PY*BY
            PZ = PZ*BZ
  250       PX = PX*BX
            PY = PY*BY
            PZ = PZ*BZ
  240       PX = PX*BX
            PY = PY*BY
            PZ = PZ*BZ
  230       PX = PX*BX
            PY = PY*BY
            PZ = PZ*BZ
  220       PX = PX*BX
            PY = PY*BY
            PZ = PZ*BZ
  210       CONTINUE
         END IF
C
         XINT = XINT + PX
         YINT = YINT + PY
         ZINT = ZINT + PZ
  400 CONTINUE
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_VINT
C>
C>    @brief   Gauss-Hermite quadrature using minimum point formula
C>             used for gradient calculation
C>
C>    @author  Daisuke Yokogawa
C>
      SUBROUTINE RSM_VINT
C
      USE RSMSED,   ONLY : H, W
C
      IMPLICIT NONE
C
      INTEGER          :: MIN(7),MAX(7)
C
      DOUBLE PRECISION :: XINT,YINT,ZINT,T,X0,Y0,Z0,XI,YI,ZI,
     *                    XJ,YJ,ZJ,CX,CY,CZ
      INTEGER          :: NI, NJ
      COMMON /RSDSTV/ XINT,YINT,ZINT,T,X0,Y0,Z0,XI,YI,ZI,
     *                XJ,YJ,ZJ,NI,NJ,CX,CY,CZ

      DOUBLE PRECISION, PARAMETER :: ZERO=0.0D+00
C
      DATA MIN /1,2,4,7,11,16,22/
      DATA MAX /1,3,6,10,15,21,28/
C
      INTEGER          :: NPTS, IMIN, IMAX, I
      DOUBLE PRECISION :: DUM,PX,PY,PZ,PTX,PTY,PTZ,AX,AY,AZ,BX,BY,BZ
C
C     ----- GAUSS-HERMITE QUADRATURE USING MINIMUM POINT FORMULA -----
C
      XINT = ZERO
      YINT = ZERO
      ZINT = ZERO
      NPTS = (NI+NJ-2)/2+1
      IMIN = MIN(NPTS)
      IMAX = MAX(NPTS)
      DO 340 I = IMIN,IMAX
         DUM = W(I)
         PX = DUM
         PY = DUM
         PZ = DUM
         DUM = H(I)*T
         PTX = DUM+X0
         PTY = DUM+Y0
         PTZ = DUM+Z0
         AX = PTX-XI
         AY = PTY-YI
         AZ = PTZ-ZI
         BX = PTX-XJ
         BY = PTY-YJ
         BZ = PTZ-ZJ
         IF(PX+AX .EQ. PX) AX = ZERO
         IF(PY+AY .EQ. PY) AY = ZERO
         IF(PZ+AZ .EQ. PZ) AZ = ZERO
         IF(PX+BX .EQ. PX) BX = ZERO
         IF(PY+BY .EQ. PY) BY = ZERO
         IF(PZ+BZ .EQ. PZ) BZ = ZERO
         GO TO (180,164, 162, 160,140,120,100),NI
C
  100    PX = PX*AX
         PY = PY*AY
         PZ = PZ*AZ
  120    PX = PX*AX
         PY = PY*AY
         PZ = PZ*AZ
  140    PX = PX*AX
         PY = PY*AY
         PZ = PZ*AZ
  160    PX = PX*AX
         PY = PY*AY
         PZ = PZ*AZ
  162    PX = PX*AX
         PY = PY*AY
         PZ = PZ*AZ
  164    PX = PX*AX
         PY = PY*AY
         PZ = PZ*AZ
  180    GO TO (320,310,300,280,260,240,220,200),NJ
C
  200    PX = PX*BX
         PY = PY*BY
         PZ = PZ*BZ
  220    PX = PX*BX
         PY = PY*BY
         PZ = PZ*BZ
  240    PX = PX*BX
         PY = PY*BY
         PZ = PZ*BZ
  260    PX = PX*BX
         PY = PY*BY
         PZ = PZ*BZ
  280    PX = PX*BX
         PY = PY*BY
         PZ = PZ*BZ
  300    PX = PX*BX
         PY = PY*BY
         PZ = PZ*BZ
  310    PX = PX*BX
         PY = PY*BY
         PZ = PZ*BZ
  320    CONTINUE
         XINT = XINT+PX
         YINT = YINT+PY
         ZINT = ZINT+PZ
  340 CONTINUE
      RETURN
      END

C*MODULE RSM_SDDINT  *DECK RSM_ESPZRO
C>
C>    @brief   compute Z-matrix used in the ESP fitting 
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   ZMAT: Z-matrix
C>
      SUBROUTINE RSM_ESPZRO(ZMAT)
C
      USE ABSMOD, ONLY : EX0A,COF0A,KSTRT0A,KATM0A,KTYP0A,KNG0A,KLOC0A,
     *                   KMIN0A,KMAX0A,NSHEL0A,TQ,NQMT0A,TRN3
      USE RSMSED, ONLY : C
C
      IMPLICIT NONE
C
      DOUBLE PRECISION, INTENT(  OUT) :: ZMAT(*)
C
      DOUBLE PRECISION :: SBLK(36),DIJ(36),XIN(9),YIN(9),ZIN(9)
      INTEGER          :: IJX(36),IJY(36),IJZ(36),
     *                    IX(10),IY(10),IZ(10),JX(10),JY(10),JZ(10)
C
      INTEGER :: NI, NJ
      DOUBLE PRECISION :: XINT,YINT,ZINT,TAA,X0,Y0,Z0, XI,YI,ZI,XJ,YJ,ZJ
      COMMON /RSSTV / XINT,YINT,ZINT,TAA,X0,Y0,Z0,
     *                XI,YI,ZI,XJ,YJ,ZJ,NI,NJ
C
      DOUBLE PRECISION :: WRK1(10,10),WRK2(10,10)
C
      DOUBLE PRECISION, ALLOCATABLE :: WRK3(:)
C
      DOUBLE PRECISION, PARAMETER   :: ZERO=0.0D+00, PT5=0.5D+00, 
     *                                 ONE=1.0D+00, TWO=2.0D+00,
     *                     PI212=1.1283791670955D+00, RLN10=2.30258D+00
C
      DATA JX / 0, 1, 0, 0, 2, 0, 0, 1, 1, 0/
      DATA JY / 0, 0, 1, 0, 0, 2, 0, 1, 0, 1/
      DATA JZ / 0, 0, 0, 1, 0, 0, 2, 0, 1, 1/
      DATA IX / 1, 4, 1, 1, 7, 1, 1, 4, 4, 1/
      DATA IY / 1, 1, 4, 1, 1, 7, 1, 4, 1, 4/
      DATA IZ / 1, 1, 1, 4, 1, 1, 7, 1, 4, 4/
C
      INTEGER :: II, JJ, IATM, LIT, LJT, MINI, MAXI, MINJ, MAXJ, I1, I2,
     *           J1, J2, IG, JG, I, J, IN, JN, IJ, NN, 
     *           NX, NY, NZ

      DOUBLE PRECISION :: COFI, COFJ, RR, AXI, AYI, AZI, AX, AY, AZ, AI,
     *                    AJ, AA, AA1, ARRI, DUM, DUM1, DUM2, VAL, FAC
C
      ALLOCATE(WRK3(NSHEL0A))
C
C     ----- I SHELL -----
C
      DO II = 1,NSHEL0A
        IATM = KATM0A(II)
        XI   = C(1,IATM)
        YI   = C(2,IATM)
        ZI   = C(3,IATM)
        I1   = KSTRT0A(II)
        I2   = I1+KNG0A(II)-1
        LIT  = KTYP0A(II)
        MINI = KMIN0A(II)
        MAXI = KMAX0A(II)
C
C     ----- J SHELL -----
C
        XJ  = XI
        YJ  = YI
        ZJ  = ZI
        J1  = I1
        J2  = I2
        LJT = LIT
        MINJ = MINI
        MAXJ = MAXI

        RR   = 0.0D+00
C
C     ----- PREPARE INDICES FOR PAIRS OF (I,J) FUNCTIONS
C
        IJ = 0
        DO I = MINI,MAXI
          NX = IX(I)
          NY = IY(I)
          NZ = IZ(I)
          DO J = MINJ,MAXJ
            IJ = IJ+1
            IJX(IJ) = NX+JX(J)
            IJY(IJ) = NY+JY(J)
            IJZ(IJ) = NZ+JZ(J)
          ENDDO
        ENDDO
C
        CALL VCLR( SBLK,1,IJ)
C
C     ----- I PRIMITIVE
C
        DO IG = I1,I2
          AI = EX0A(IG)
          ARRI = AI*RR
          AXI = AI*XI
          AYI = AI*YI
          AZI = AI*ZI

          COFI = COF0A(IG)
C
C     ----- J PRIMITIVE
C
          DO JG = J1,J2
            AJ = EX0A(JG)
            AA = AI+AJ
            AA1 = 1.0D+00/AA
            DUM = AJ*ARRI*AA1
            FAC = EXP(-DUM)

            COFJ = COF0A(JG)

            AX = (AXI+AJ*XJ)*AA1
            AY = (AYI+AJ*YJ)*AA1
            AZ = (AZI+AJ*ZJ)*AA1
C
C     ----- DENSITY FACTOR
C
            NN = 0
            DO I = MINI,MAXI
              DUM1 = COFI*FAC
              DO J=MINJ,MAXJ
                DUM2 = DUM1*COFJ

                NN = NN + 1
                DIJ(NN)=DUM2
              ENDDO
            ENDDO
C
C     ----- OVERLAP AND KINETIC ENERGY
C
            TAA = SQRT(AA1)
            X0 = AX
            Y0 = AY
            Z0 = AZ
            IN = -3
            DO I = 1,LIT
              IN = IN+3
              NI = I
              DO J = 1,LJT
                JN = IN+J
                NJ = J
                CALL RSM_STVINT
                XIN(JN) = XINT*TAA
                YIN(JN) = YINT*TAA
                ZIN(JN) = ZINT*TAA
              ENDDO
            ENDDO

!             if(lit == 2.and. ljt ==2) print *,ij
            DO I = 1,IJ

              NX = IJX(I)
              NY = IJY(I)
              NZ = IJZ(I)
              DUM= XIN(NX)*YIN(NY)*ZIN(NZ)
              SBLK(I) = SBLK(I) + DIJ(I)* DUM

            ENDDO
C
C     ----- END OF PRIMITIVE LOOPS -----
C
          ENDDO
        ENDDO
C
C     ----- COPY BLOCK INTO H-CORE, OVERLAP, AND KINETIC ENERGY MATRICES
C
        NN = 0
        VAL = 0.0D+00
        DO I=MINI,MAXI
          DO J=MINJ,MAXJ
            NN = NN + 1

            VAL = VAL + TRN3(J,I)*SBLK(NN)
          ENDDO
        ENDDO
C
C     ----- END OF SHELL LOOPS -----
C
        WRK3(II) = VAL
!          print *,ii,val
      ENDDO
C
C
C
      DO II=1,NQMT0A
        VAL = 0.0D+00
        DO JJ=1,NSHEL0A
          VAL = VAL + TQ(JJ,II)*WRK3(JJ)
        ENDDO

        ZMAT(II) = VAL
      ENDDO

      DEALLOCATE(WRK3)

      RETURN
      END

C*MODULE RSM_SDDINT  *DECK RSM_ESPONE
C>
C>    @brief   compute X-matrix used in the ESP fitting
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   XMAT: X-matrix
C>
      SUBROUTINE RSM_ESPONE(XMAT)
C
      USE ABSMOD, ONLY : EX0A,COF0A,KSTRT0A,KATM0A,KTYP0A,KNG0A,KLOC0A,
     *                   KMIN0A,KMAX0A,NSHEL0A,TQ,NQMT0A,TRN3
      USE RSMSED, ONLY : C
C
      IMPLICIT NONE
C
      DOUBLE PRECISION, INTENT(  OUT) :: XMAT(NQMT0A,NQMT0A)
C
      DOUBLE PRECISION     :: GTMP(196000),XVAL(100,100),
     *                        XI, YI, ZI, CSI, ZETA,  
     *                        XJ, YJ, ZJ, 
     *                        XK, YK, ZK, CSK, ETA, 
     *                        XL, YL, ZL,
     *                        VAL, VAL1, VAL2, DIK
      DOUBLE PRECISION, ALLOCATABLE :: WRK1(:),WRK2(:,:)

      INTEGER              :: II, IATM, MINI, MAXI, I1, I2, IG, I, IJ,
     *                        JJ,       MINJ, MAXJ, J1, J2, JG, J, 
     *                        KK, KATM, MINK, MAXK, K1, K2, KG, K, KL,
     *                                  MINL, MAXL, L1, L2, LG, L,
     *                        NN
C
      ALLOCATE(WRK1(NSHEL0A),WRK2(NSHEL0A,NSHEL0A))
C
C     ----- I SHELL -----
C
      DO II = 1,NSHEL0A
        IATM = KATM0A(II)
        XI   = C(1,IATM)
        YI   = C(2,IATM)
        ZI   = C(3,IATM)

        XJ   = XI
        YJ   = YI
        ZJ   = ZI

        MINI = KMIN0A(II)
        MAXI = KMAX0A(II)

        MINJ = MINI
        MAXJ = MAXI

        I1   = KSTRT0A(II)
        I2   = I1 + KNG0A(II) - 1

        J1   = I1
        J2   = I2
C
C        ----- K SHELL -----
C
        DO KK = 1,NSHEL0A
          KATM  = KATM0A(KK)
          XK    = C(1,KATM)
          YK    = C(2,KATM)
          ZK    = C(3,KATM)

          XL    = XK
          YL    = YK
          ZL    = ZK

          MINK  = KMIN0A(KK)
          MAXK  = KMAX0A(KK)

          MINL  = MINK
          MAXL  = MAXK

          K1    = KSTRT0A(KK)
          K2    = K1 + KNG0A(KK) - 1

          L1    = K1
          L2    = K2
C
C         PRIMITIVE
C
          XVAL = 0.0D+00

          DO IG=I1,I2
            DO JG=J1,J2
              ZETA = EX0A(IG)  + EX0A(JG)
              CSI  = COF0A(IG) * COF0A(JG)
 
              DO KG=K1,K2
                DO LG=L1,L2
                  ETA = EX0A(KG)  + EX0A(LG)
                  CSK = COF0A(KG) * COF0A(LG)
C
C                 ----- DENSITY FACTOR
C
                  DIK = CSI * CSK
C
                  GTMP = 0.0D+00
                  CALL RSM_OSINT1(.FALSE.,MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                          MINL,MAXL,ZETA,ETA,XI,YI,ZI,XK,YK,ZK,XI,
     *                          YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,
     *                          1.0D+00,1.0D+00,GTMP)

                  NN = 0
                  IJ = 0
                  DO I=MINI,MAXI
                    DO J=MINJ,MAXJ
                      IJ = IJ + 1
                      KL = 0
                      DO K=MINK,MAXK
                        DO L=MINL,MAXL
                          KL = KL + 1
                          NN = NN + 1

                          XVAL(KL,IJ)=XVAL(KL,IJ)+GTMP(NN)*DIK
                        ENDDO
                      ENDDO
                    ENDDO
                  ENDDO
                ENDDO
              ENDDO
            ENDDO
          ENDDO

          IJ=0
          VAL1 = 0.0D+00
          DO I=MINI,MAXI
            DO J=MINJ,MAXJ
              IJ = IJ + 1

              KL = 0
              VAL2 = 0.0D+00
              DO K=MINK,MAXK
                DO L=MINL,MAXL
                  KL = KL + 1

                  VAL2 = VAL2 + TRN3(L,K)*XVAL(KL,IJ)
                ENDDO
              ENDDO
              VAL1 = VAL1 + TRN3(J,I)*VAL2
            ENDDO
          ENDDO

          WRK2(II,KK)=VAL1
        ENDDO
      ENDDO
C
      DO JJ=1,NQMT0A
        DO II=1,NSHEL0A
          VAL = 0.0D+00
          DO KK=1,NSHEL0A
            VAL = VAL + TQ(KK,JJ)*WRK2(KK,II)
          ENDDO
          WRK1(II) = VAL
        ENDDO

        DO II=1,NQMT0A
          VAL = 0.0D+00
          DO KK=1,NSHEL0A
            VAL = VAL + TQ(KK,II)*WRK1(KK)
          ENDDO
          XMAT(II,JJ) = VAL
        ENDDO
      ENDDO
C
      DEALLOCATE(WRK1,WRK2)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_ESPONE
C>
C>    @brief   compute Y-matrix used in the ESP fitting
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   IRSSQF: the file number of sequential file
C>
      SUBROUTINE RSM_ESPTWO(IRSSQF)
C
      USE RISM_MOD, ONLY : GOPARR, MASWRK, RSM_ISTIEND
      USE ABSMOD,   ONLY : EX0A,COF0A,KSTRT0A,KATM0A,KTYP0A,KNG0A,
     *                     KLOC0A,KMIN0A,KMAX0A,NSHEL0A,TQ,NQMT0A,TRN3
      USE RSMSED,   ONLY : NUM, C
      USE RSM_BSMOD,ONLY : NSHELL,KSTART,KATOM,KTYPE,KNG,KLOC,KMIN,KMAX,
     *                     EX,CS,CP,CD,CF,CG,NORM, nprim
C
      IMPLICIT NONE
C
      INTEGER, INTENT(IN   ) :: IRSSQF
C
      DOUBLE PRECISION,  PARAMETER     :: PI212=1.1283791670955D+00, 
     *                                    SQRT3=1.73205080756888D+00,
     *                                    SQRT5=2.23606797749979D+00, 
     *                                    SQRT7=2.64575131106459D+00,
     *                                    RLN10=2.30258D+00
C
      LOGICAL              :: IANDJ,DOUBLE
      DOUBLE PRECISION     :: DIJ(225),G(100,225),GTMP(196000),
     *                        XI, YI, ZI, CSI, CPI, CDI, CFI, CGI, AI,
     *                        XJ, YJ, ZJ, CSJ, CPJ, CDJ, CFJ, CGJ, AJ,
     *                        XK, YK, ZK, CSK, XL, YL, ZL, DKL,
     *                        AXI, AYI, AZI, PX, PY, PZ, ZETA, ZETA1,
     *                        SAB, DUM, DUM1, DUM2, VAL, RR, ARRI, ETA
      INTEGER              :: II, I, I1, I2, LIT, MINI, MAXI, LOCI, IG,
     *                        JJ, J, J1, J2, LJT, MINJ, MAXJ, LOCJ, JG,
     *                        KK, K, K1, K2,      MINK, MAXK,       KG,
     *                        LL, L, L1, L2,      MINL, MAXL,       LG,
     *                        NN, LI, LJ, ISTRT, IEND, NDIM0A, IJ, KL,
     *                        MM, MAX, JGMAX

      INTEGER, ALLOCATABLE          :: IC(:,:)
      DOUBLE PRECISION, ALLOCATABLE :: WRK(:,:)
C
      ALLOCATE(IC(NUM,NUM),WRK(NSHEL0A,225))
C
C     NORM = .TRUE.
C
      NN = 0
      DO I=1,NUM
        DO J=1,I
          NN = NN + 1
          IC(I,J) = NN
          IC(J,I) = NN
        ENDDO
      ENDDO
C
      CALL RSM_ISTIEND(NSHEL0A,ISTRT,IEND,NDIM0A)
C
C     ----- I SHELL -----
C
      DO II = 1,NSHELL
        I = KATOM(II)
        XI = C(1,I)
        YI = C(2,I)
        ZI = C(3,I)
        I1 = KSTART(II)
        I2 = I1+KNG(II)-1
        LIT = KTYPE(II)
        MINI = KMIN(II)
        MAXI = KMAX(II)
        LOCI = KLOC(II)-MINI
C
C     ----- J SHELL -----
C
        DO JJ = 1,II
          J = KATOM(JJ)
          XJ = C(1,J)
          YJ = C(2,J)
          ZJ = C(3,J)
          J1 = KSTART(JJ)
          J2 = J1+KNG(JJ)-1
          LJT = KTYPE(JJ)
          MINJ = KMIN(JJ)
          MAXJ = KMAX(JJ)
          LOCJ = KLOC(JJ)-MINJ

          RR = (XI-XJ)**2+(YI-YJ)**2+(ZI-ZJ)**2
          IANDJ = II .EQ. JJ

          IJ = 0
          MAX = MAXJ
          DO I = MINI,MAXI
            IF (IANDJ) MAX = I
            DO J = MINJ,MAX
              IJ = IJ+1
            ENDDO
          ENDDO
C
C         ----- K SHELL
C
          WRK = 0.0D+00
          DO KK=ISTRT,IEND
            K    = KATM0A(KK)
            XK   = C(1,K)
            YK   = C(2,K)
            ZK   = C(3,K)
            MINK = KMIN0A(KK)
            MAXK = KMAX0A(KK)

            XL   = XK
            YL   = YK
            ZL   = ZK
            MINL = MINK
            MAXL = MAXK

            K1   = KSTRT0A(KK)
            K2   = K1 + KNG0A(KK) - 1

            L1   = K1
            L2   = K2

            G=0.0D+00
C
C     ----- I PRIMITIVE
C
            JGMAX = J2
            DO IG = I1,I2
              AI   = EX(IG)
              ARRI = AI*RR
              AXI  = AI*XI
              AYI  = AI*YI
              AZI  = AI*ZI
              CSI  = CS(IG)
              CPI  = CP(IG)
              CDI  = CD(IG)
              CFI  = CF(IG)
              CGI  = CG(IG)
C
C     ----- J PRIMITIVE
C
              IF (IANDJ) JGMAX = IG
              DO JG = J1,JGMAX
                AJ    = EX(JG)
                ZETA  = AI+AJ
                ZETA1 = 1.0D+00/ZETA
                DUM   = AJ*ARRI*ZETA1
                SAB = EXP(-DUM)
                CSJ = CS(JG)
                CPJ = CP(JG)
                CDJ = CD(JG)
                CFJ = CF(JG)
                CGJ = CG(JG)
                PX = (AXI+AJ*XJ)*ZETA1
                PY = (AYI+AJ*YJ)*ZETA1
                PZ = (AZI+AJ*ZJ)*ZETA1
C
C     ----- DENSITY FACTOR
C
                DOUBLE=IANDJ.AND.IG.NE.JG
                MAX = MAXJ
                NN = 0
                DUM1 = 0.0D+00
                DUM2 = 0.0D+00
                DO I = MINI,MAXI
                  IF (I.EQ.1) DUM1=CSI
                  IF (I.EQ.2) DUM1=CPI
                  IF (I.EQ.5) DUM1=CDI
                  IF ((I.EQ. 8).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.11) DUM1=CFI
                  IF ((I.EQ.14).AND.NORM) DUM1=DUM1*SQRT5
                  IF ((I.EQ.20).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.21) DUM1=CGI
                  IF ((I.EQ.24).AND.NORM) DUM1=DUM1*SQRT7
                  IF ((I.EQ.30).AND.NORM) DUM1=DUM1*SQRT5/SQRT3
                  IF ((I.EQ.33).AND.NORM) DUM1=DUM1*SQRT3
                  IF (IANDJ) MAX = I
                  DO J = MINJ,MAX
                    IF (J.EQ.1) THEN
                      DUM2=DUM1*CSJ
                      IF (DOUBLE) THEN
                        IF (I.LE.1) THEN
                          DUM2=DUM2+DUM2
                        ELSE
                          DUM2=DUM2+CSI*CPJ
                        END IF
                      END IF
                    ELSE IF (J.EQ.2) THEN
                      DUM2=DUM1*CPJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF (J.EQ.5) THEN
                      DUM2=DUM1*CDJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF ((J.EQ.8).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.11) THEN
                      DUM2=DUM1*CFJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF ((J.EQ.14).AND.NORM) THEN
                      DUM2=DUM2*SQRT5
                    ELSE IF ((J.EQ.20).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.21) THEN
                      DUM2=DUM1*CGJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF ((J.EQ.24).AND.NORM) THEN
                      DUM2=DUM2*SQRT7
                    ELSE IF ((J.EQ.30).AND.NORM) THEN
                      DUM2=DUM2*SQRT5/SQRT3
                    ELSE IF ((J.EQ.33).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    END IF
                    NN = NN+1
                    DIJ(NN) = DUM2
                  ENDDO
                ENDDO
  
                DO KG=K1,K2
                  DO LG=L1,L2
                    ETA = EX0A(KG) + EX0A(LG)
                    CSK = COF0A(KG) * COF0A(LG)

                    DKL = CSK
 
                    GTMP = 0.0D+00
                    CALL RSM_OSINT2(IANDJ,MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                          MINL,MAXL,ZETA,ETA,PX,PY,PZ,XK,YK,ZK,XI,
     *                          YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,SAB,
     *                          1.0D+00,GTMP)

                    NN = 0
                    DO I=1,IJ
                      KL = 0
                      DO K=MINK,MAXK
                        DO L=MINL,MAXL
                          KL = KL + 1
                          NN = NN + 1
                          G(KL,I)=G(KL,I)+GTMP(NN)*DIJ(I)*DKL
!                        print *,gtmp(nn),dij(i),dkl
                        ENDDO
                      ENDDO
                    ENDDO
C
C     ----- END OF PRIMITIVE LOOPS -----
C
                  ENDDO
                ENDDO
              ENDDO
            ENDDO
C
            DO I=1,IJ
              VAL = 0.0D+00
              MM = 0
              DO K=MINK,MAXK
                DO L=MINL,MAXL
                  MM = MM + 1

                  VAL = VAL + TRN3(L,K)*G(MM,I)
!                 print *,TRN3(L,K),G(MM,I)
                ENDDO
              ENDDO
              WRK(KK,I) = VAL
            ENDDO
          ENDDO

          IF(GOPARR) CALL RSM_GSUMF(10000,WRK,NSHEL0A*IJ)
C
C     ----- Write B-Matrix into Disk -----
C
          NN = 0
          MAX=MAXJ
          DO I=MINI,MAXI
            LI=LOCI+I
            IF (IANDJ) MAX = I
            DO J=MINJ,MAX
              LJ=LOCJ+J
              NN = NN + 1

              DO KK=1,NQMT0A
                VAL = 0.0D+00
                DO LL=1,NSHEL0A
                  VAL = VAL + TQ(LL,KK)*WRK(LL,NN)
                ENDDO

                IF(MASWRK .and. ABS(VAL) > 1.0D-14) THEN
                  WRITE(IRSSQF) LI,LJ,KK,VAL
                ENDIF
              ENDDO
            ENDDO
          ENDDO

C
C     ----- END OF SHELL LOOPS -----
C
        ENDDO
      ENDDO

!             DO KK=1,NQMT0A
!               DO LL=1,NSHEL0A
!                 print *,tq(ll,kk)
!               ENDDO
!             ENDDO
!
!      call abrt_gms
C
      DEALLOCATE(IC,WRK)
C
      RETURN
      END

C*MODULE RSM_SDDINT  *DECK RSM_OSINT1
C>
C>    @brief   integration using Obara-Saika recursion relation
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   IANDJ: I is equal to J, or not
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             ZETA: = AI + AJ, where AI and AJ are the contraction coefs 
C>             ETA: = AK + AL, where AK and AL are the contraction coefs
C>             PX, PY, PZ: position of the centroid of the new Gaussian
C>                         formed from the product of two Gaussians (I and J)
C>             QX, QY, QZ: position of the centroid of the new Gaussian
C>                         formed from the product of two Gaussians (K and L)
C>             XI, YI, ZI: the position of the Gaussian I
C>             XJ, YJ, ZJ: the position of the Gaussian J
C>             XK, YK, ZK: the position of the Gaussian K
C>             XL, YL, ZL: the position of the Gaussian L
C>             SAB: the overlap between the Gaussians I and J
C>             SCD: the overlap between the Gaussians K and L
C>             GTMP: working array
C>
      SUBROUTINE RSM_OSINT1(IANDJ,MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,
     *                  MAXL,
     *                  ZETA,ETA,PX,PY,PZ,QX,QY,QZ,XI,YI,ZI,XJ,YJ,ZJ,
     *                  XK,YK,ZK,XL,YL,ZL,SAB,SCD,GTMP)
      IMPLICIT NONE
C
      LOGICAL,           INTENT(IN   ) :: IANDJ
      INTEGER,           INTENT(IN   ) :: MINI, MAXI, MINJ, MAXJ,
     *                                    MINK, MAXK, MINL, MAXL
      DOUBLE PRECISION,  INTENT(IN   ) :: ZETA,ETA,PX,PY,PZ,QX,QY,QZ, 
     *                                    XI,YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,
     *                                    XL,YL,ZL,SAB,SCD
      DOUBLE PRECISION,  INTENT(  OUT) :: GTMP(196000)
C
      DOUBLE PRECISION, PARAMETER      :: PI=3.141592653589793D+00
      DOUBLE PRECISION                 :: FFTMP(17), PA(3),PB(3),
     *                                    QC(3),QD(3),PQ(3)
      INTEGER                :: IM(3,0:34),NIN(3,0:34),IORG(34),
     *                          INDXL(35),N1(0:4),N2(0:4)
C
      DOUBLE PRECISION, ALLOCATABLE :: XIM(:,:,:,:,:)
C
      DATA IM/ 0, 0, 0, !S
     *         0, 0, 0, !P
     *         0, 0, 0,
     *         0, 0, 0,
     *         1, 0, 0, !D
     *         0, 2, 0,
     *         0, 0, 3,
     *         2, 1, 0,
     *         3, 0, 1,
     *         0, 3, 2,
     *         4, 0, 0, ! F
     *         0, 5, 0,
     *         0, 0, 6,
     *         7, 4, 0,
     *         8, 0, 4,
     *         5, 7, 0,
     *         0, 9, 5,
     *         6, 0, 8,
     *         0, 6, 9,
     *         9, 8, 7,
     *        10, 0, 0, ! G
     *         0,11, 0,
     *         0, 0,12,
     *        13,10, 0,
     *        14, 0,10,
     *        11,15, 0,
     *         0,16,11,
     *        12, 0,17,
     *         0,12,18,
     *        15,13, 0,
     *        17, 0,14,
     *         0,18,16,
     *        19,14,13,
     *        16,19,15,
     *        18,17,19/
      DATA NIN/0,0,0, !S
     *         1,0,0, !P
     *         0,1,0,
     *         0,0,1,
     *         2,0,0, !D
     *         0,2,0,
     *         0,0,2,
     *         1,1,0,
     *         1,0,1,
     *         0,1,1,
     *         3,0,0, !F
     *         0,3,0,
     *         0,0,3,
     *         2,1,0,
     *         2,0,1,
     *         1,2,0,
     *         0,2,1,
     *         1,0,2,
     *         0,1,2,
     *         1,1,1,
     *         4,0,0, !G
     *         0,4,0,
     *         0,0,4,
     *         3,1,0,
     *         3,0,1,
     *         1,3,0,
     *         0,3,1,
     *         1,0,3,
     *         0,1,3,
     *         2,2,0,
     *         2,0,2,
     *         0,2,2,
     *         2,1,1,
     *         1,2,1,
     *         1,1,2/
      DATA IORG/1,2,3, 1,2,3,1,3,2, 1,2,3,1,1,2,2,3,3,1,
     *          1,2,3,1,1,2,2,3,3,1,3,2,1,2,3/
      DATA INDXL/0, 1,1,1, 2,2,2,2,2,2, 3,3,3,3,3,3,3,3,3,3,
     *           4,4,4,4,4,4,4,4,4,4,4,4,4,4,4/
      DATA N1/0,1,4,10,20/
      DATA N2/0,3,9,19,34/
C
      INTEGER :: MA1, MB1, MC1, MD1, MA2, MB2, MC2, MD2, MCD, MBCD,
     *           MABCD, NA, NB, NC, ND, IX, NN, JMAX,
     *           I, J, K, L, M, IM1, IM2, JM1, JM2, KM1, KM2, LM1, LM2
      DOUBLE PRECISION :: AA1, RHO, RZ, RE, HZ, HE, FACT1, FACT2, FACT, 
     *                    T, RM, TMP
C
      ALLOCATE(XIM(0:12,0: 9,0: 9,0:34,0:34))
C
      MA1=INDXL(MINI)
      MB1=INDXL(MINJ)
      MC1=INDXL(MINK)
      MD1=INDXL(MINL)

      MA2=INDXL(MAXI)
      MB2=INDXL(MAXJ)
      MC2=INDXL(MAXK)
      MD2=INDXL(MAXL)

      MCD  =MC2+MD2
      MBCD =MB2+MCD
      MABCD=MA2+MBCD

      PA(1)=PX-XI
      PA(2)=PY-YI
      PA(3)=PZ-ZI
      PB(1)=PX-XJ
      PB(2)=PY-YJ
      PB(3)=PZ-ZJ
      QC(1)=QX-XK
      QC(2)=QY-YK
      QC(3)=QZ-ZK
      QD(1)=QX-XL
      QD(2)=QY-YL
      QD(3)=QZ-ZL
      PQ(1)=PX-QX
      PQ(2)=PY-QY
      PQ(3)=PZ-QZ

      AA1  =1.0D+00/(ETA+ZETA)
      RHO  =ETA*ZETA*AA1
      RZ   =RHO/ZETA
      RE   =RHO/ETA
      HZ   =0.5D+00/ZETA
      HE   =0.5D+00/ETA

      FACT1=PI*AA1*SQRT(PI*AA1)
      FACT2=2.0D+00*PI/RHO/RHO
      FACT =FACT1*SAB*SCD*FACT2

      T=RHO*(PQ(1)*PQ(1)+PQ(2)*PQ(2)+PQ(3)*PQ(3))

      CALL RSM_FFUNC(T,MABCD+3,FFTMP)
C
C     (ssss)
C
      XIM(0,0,0,0,0)=FACT*((1.0D+00+T)*FFTMP(1)-T*FFTMP(2))

      DO M=1,MABCD
        RM=DFLOAT(M)
        TMP=-T*FFTMP(M+2)+(RM+1.0D+00+T)*FFTMP(M+1)-RM*FFTMP(M)
        XIM(M,0,0,0,0)=FACT*TMP
      ENDDO
C
C     (xsss)
C
      DO NA=1,MA2
        DO I=N1(NA),N2(NA)
          IX =IORG(I)
          IM1=IM(IX,I)     !  I - 1
          IM2=IM(IX,IM1)   !  I - 2
          DO M=0,(MABCD-NA)
            XIM(M,0,0,0,I)=                   PA(IX)*XIM(M  ,0,0,0,IM1)
     *                                    -RZ*PQ(IX)*XIM(M+1,0,0,0,IM1)
     *                +HZ*DFLOAT(NIN(IX,IM1))*(      XIM(M  ,0,0,0,IM2)
     *                                           -RZ*XIM(M+1,0,0,0,IM2))
          ENDDO
        ENDDO
      ENDDO
C
C     (xxss)
C
!     write(*,'(7i5)') mb2,ma2,N1(NA),N2(NA),N1(NB),N2(NB),MBCD
      DO NB=1,MB2
        DO NA=0,MA2
          DO I=N1(NA),N2(NA)
            DO J=N1(NB),N2(NB)
              IX=IORG(J)
              JM1=IM(IX,J)
              JM2=IM(IX,JM1)
              IM1=IM(IX,I)
              DO M=0,(MBCD-NB)
                XIM(M,0,0,J,I)=             PB(IX)*XIM(M  ,0,0,JM1,I  )
     *                                  -RZ*PQ(IX)*XIM(M+1,0,0,JM1,I  )
     *          +HZ*DFLOAT(NIN(IX,JM1))*(          XIM(M  ,0,0,JM2,I  )
     *                                         -RZ*XIM(M+1,0,0,JM2,I  ))
     *          +HZ*DFLOAT(NIN(IX,  I))*(          XIM(M  ,0,0,JM1,IM1)
     *                                         -RZ*XIM(M+1,0,0,JM1,IM1))
              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
C        (xxxs)
C
      DO NC=1,MC2
        DO NB=0,MB2
          DO NA=0,MA2

            DO I=N1(NA),N2(NA)
              DO J=N1(NB),N2(NB)
                DO K=N1(NC),N2(NC)
                  IX=IORG(K)
                  KM1=IM(IX,K)
                  KM2=IM(IX,KM1)
                  IM1=IM(IX,I)
                  JM1=IM(IX,J)

                  DO M=0,MCD-NC
                    XIM(M,0,K,J,I)=         QC(IX)*XIM(M  ,0,KM1,J,I  )
     *                                  +RE*PQ(IX)*XIM(M+1,0,KM1,J,I  )
     *                +HE*REAL(NIN(IX,KM1),8)*(    XIM(M  ,0,KM2,J,I  )
     *                                         -RE*XIM(M+1,0,KM2,J,I  ))
     *         +0.5D+00*AA1   *(REAL(NIN(IX,I),8)*XIM(M+1,0,KM1,J  ,IM1)
     *                        +REAL(NIN(IX,J),8)*XIM(M+1,0,KM1,JM1,I  ))
                  ENDDO
                ENDDO
              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
C        (xxxx)
C
      DO ND=1,MD2
        DO NC=0,MC2
          DO NB=0,MB2
            DO NA=0,MA2
              DO I=N1(NA),N2(NA)
                DO J=N1(NB),N2(NB)
                  DO K=N1(NC),N2(NC)
                    DO L=N1(ND),N2(ND)
                      IX=IORG(L)
                      LM1=IM(IX,L)
                      LM2=IM(IX,LM1)
                      IM1=IM(IX,I)
                      JM1=IM(IX,J)
                      KM1=IM(IX,K)
                      DO M=0,(MD2-ND)
                        XIM(M,L,K,J,I)=   QD(IX)*XIM(M  ,LM1,K,J,I)
     *                                +RE*PQ(IX)*XIM(M+1,LM1,K,J,I)
     *              +HE*REAL(NIN(IX,LM1),8)*(    XIM(M  ,LM2,K  ,J,I)
     *                                      -RE*XIM(M+1,LM2,K  ,J,I))
     *              +HE*REAL(NIN(IX,K  ),8)*(    XIM(M  ,LM1,KM1,J,I)
     *                                      -RE*XIM(M+1,LM1,KM1,J,I))
     *        +0.5D+00*AA1*( REAL(NIN(IX,I),8)*XIM(M+1,LM1,K,J  ,IM1)
     *                      +REAL(NIN(IX,J),8)*XIM(M+1,LM1,K,JM1,I  ))
                      ENDDO
                    ENDDO
                  ENDDO
                ENDDO
              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO

      NN = 0
      JMAX = MAXJ
      DO I=MINI,MAXI
        IF(IANDJ) JMAX = I
        DO J=MINJ,JMAX
          DO K=MINK,MAXK
            DO L=MINL,MAXL
              NN=NN+1
              GTMP(NN)=XIM(0,L-1,K-1,J-1,I-1)
!             print *,'AA',NN,GTMP(NN)
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
      DEALLOCATE(XIM)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_OSINT2
C>
C>    @brief   integration using Obara-Saika recursion relation
C>             (new version of RSM_OSINT1)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   IANDJ: I is equal to J, or not
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             ZETA: = AI + AJ, where AI and AJ are the contraction coefs
C>             ETA: = AK + AL, where AK and AL are the contraction coefs
C>             PX, PY, PZ: position of the centroid of the new Gaussian
C>                         formed from the product of two Gaussians (I and J)
C>             QX, QY, QZ: position of the centroid of the new Gaussian
C>                         formed from the product of two Gaussians (K and L)
C>             XI, YI, ZI: the position of the Gaussian I
C>             XJ, YJ, ZJ: the position of the Gaussian J
C>             XK, YK, ZK: the position of the Gaussian K
C>             XL, YL, ZL: the position of the Gaussian L
C>             SAB: the overlap between the Gaussians I and J
C>             SCD: the overlap between the Gaussians K and L
C>             GTMP: working array
C>
      SUBROUTINE RSM_OSINT2(IANDJ,MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,
     *                  MAXL,
     *                  ZETA,ETA,PX,PY,PZ,QX,QY,QZ,XI,YI,ZI,XJ,YJ,ZJ,
     *                  XK,YK,ZK,XL,YL,ZL,SAB,SCD,GTMP)
      IMPLICIT NONE
C
      LOGICAL,          INTENT(IN   ) :: IANDJ
      INTEGER,          INTENT(IN   ) :: MINI, MAXI, MINJ, MAXJ, 
     *                                   MINK, MAXK, MINL, MAXL
      DOUBLE PRECISION, INTENT(IN   ) :: ZETA,ETA,PX,PY,PZ,QX,QY,QZ,
     *                                   XI,YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,
     *                                   XL,YL,ZL,SAB,SCD
      DOUBLE PRECISION, INTENT(  OUT) :: GTMP(196000)
C
      DOUBLE PRECISION, PARAMETER      :: PI=3.141592653589793D+00
      DOUBLE PRECISION                 :: FFTMP(26),PB(3),QD(3),PQ(3),
     *                                    BA(3),DC(3)
      INTEGER                :: IM(3,0:83),NIN(3,0:83),IORG(83),
     *                          INDXL(84),N1(0:8),N2(0:8),IP(3,0:119)
C
      DOUBLE PRECISION,ALLOCATABLE :: XIM(:,:,:),YIM(:,:,:),ZIM(:,:,:,:)
C
      DATA IM/ 0, 0, 0, !S
     *         0, 0, 0, !P
     *         0, 0, 0,
     *         0, 0, 0,
     *         1, 0, 0, !D
     *         0, 2, 0,
     *         0, 0, 3,
     *         2, 1, 0,
     *         3, 0, 1,
     *         0, 3, 2,
     *         4, 0, 0, ! F
     *         0, 5, 0,
     *         0, 0, 6,
     *         7, 4, 0,
     *         8, 0, 4,
     *         5, 7, 0,
     *         0, 9, 5,
     *         6, 0, 8,
     *         0, 6, 9,
     *         9, 8, 7,
     *        10, 0, 0, ! G
     *         0,11, 0,
     *         0, 0,12,
     *        13,10, 0,
     *        14, 0,10,
     *        11,15, 0,
     *         0,16,11,
     *        12, 0,17,
     *         0,12,18,
     *        15,13, 0,
     *        17, 0,14,
     *         0,18,16,
     *        19,14,13,
     *        16,19,15,
     *        18,17,19,
     *        20, 0, 0, ! H
     *         0,21, 0,
     *         0, 0,22,
     *        23,20, 0,
     *        24, 0,20,
     *        21,25, 0,
     *         0,26,21,
     *        22, 0,27,
     *         0,22,28,
     *        29,23, 0,
     *        30, 0,24,
     *        25,29, 0,
     *         0,31,26,
     *        27, 0,30,
     *         0,28,31,
     *        32,24,23,
     *        26,33,25,
     *        28,27,34,
     *        33,32,29,
     *        34,30,32,
     *        31,34,33,
     *        35, 0, 0,! I
     *         0,36, 0,
     *         0, 0,37,
     *        38,35, 0,
     *        39, 0,35,
     *        36,40, 0,
     *         0,41,36,
     *        37, 0,42,
     *         0,37,43,
     *        44,38, 0,
     *        45, 0,39,
     *        40,46, 0,
     *         0,47,41,
     *        42, 0,48,
     *         0,43,49,
     *        50,39,38,
     *        41,51,40,
     *        43,42,52,
     *        46,44, 0,
     *        48, 0,45,
     *         0,49,47,
     *        53,50,44,
     *        54,45,50,
     *        51,53,46,
     *        47,55,51,
     *        52,48,54,
     *        49,52,55,
     *        55,54,53/
      DATA IP/ 1, 2, 3, ! S
     *         4, 7, 8, ! P
     *         7, 5, 9,
     *         8, 9, 6, 
     *        10,13,14, ! D
     *        15,11,16,
     *        17,18,12,
     *        13,15,19,
     *        14,19,17,
     *        19,16,18,
     *        20,23,24, ! F
     *        25,21,26,
     *        27,28,22,
     *        23,29,32,
     *        24,32,30, 
     *        29,25,33,
     *        33,26,31,
     *        30,34,27,
     *        34,31,28,
     *        32,33,34,
     *        35,38,39, ! G
     *        40,36,41,
     *        42,43,37,
     *        38,44,50,
     *        39,50,45,
     *        46,40,51,
     *        51,41,47,
     *        48,52,42,
     *        52,49,43,
     *        44,46,53, 
     *        45,54,48,
     *        55,47,49,
     *        50,53,54,
     *        53,51,55,
     *        54,55,52,
     *        56,59,60, ! H
     *        61,57,62,
     *        63,64,58,
     *        59,65,71,
     *        60,71,66,
     *        67,61,72,
     *        72,62,68,
     *        69,73,63,
     *        73,70,64,
     *        65,74,77,
     *        66,78,75,
     *        74,67,79,
     *        80,68,76,
     *        75,81,69,
     *        82,76,70,
     *        71,77,78,
     *        79,72,80,
     *        81,82,73,
     *        77,79,83,
     *        78,83,81,
     *        83,80,82,
     *        85,88,89, ! I
     *        90,86,91,
     *        92,93,87,
     *        88,94,100,
     *        89,100,95,
     *        96,90,101,
     *        101,91,97,
     *        98,102,92,
     *        102,99,93,
     *        94,103,109,
     *        95,110,104,
     *        105,96,111,
     *        112,97,106,
     *        107,113,98,
     *        114,108,99,
     *        100,109,110,
     *        111,101,112,
     *        113,114,102,
     *        103,105,115,
     *        104,116,107,
     *        117,106,108,
     *        109,115,118,
     *        110,118,116,
     *        115,111,119,
     *        119,112,117,
     *        116,120,113,
     *        120,117,114,
     *        118,119,120,
     *        121,124,125, ! J
     *        126,122,127,
     *        128,129,123,
     *        124,130,136,
     *        125,136,131,
     *        132,126,137,
     *        137,127,133,
     *        134,138,128,
     *        138,135,129,
     *        130,139,145,
     *        131,146,140,
     *        141,132,147,
     *        148,133,142,
     *        143,149,134,
     *        150,144,135,
     *        136,145,146,
     *        147,137,148,
     *        149,150,138,
     *        139,151,154,
     *        140,155,152,
     *        151,141,156,
     *        157,142,153,
     *        152,158,143,
     *        159,153,144,
     *        145,154,160,
     *        146,160,155,
     *        156,147,161,
     *        161,148,157,
     *        158,162,149,
     *        162,159,150,
     *        154,156,163,
     *        155,164,158,
     *        165,157,159,
     *        160,163,164,
     *        163,161,165,
     *        164,165,162/
      DATA NIN/0,0,0, !S
     *         1,0,0, !P
     *         0,1,0,
     *         0,0,1,
     *         2,0,0, !D
     *         0,2,0,
     *         0,0,2,
     *         1,1,0,
     *         1,0,1,
     *         0,1,1,
     *         3,0,0, !F
     *         0,3,0,
     *         0,0,3,
     *         2,1,0,
     *         2,0,1,
     *         1,2,0,
     *         0,2,1,
     *         1,0,2,
     *         0,1,2,
     *         1,1,1,
     *         4,0,0, !G
     *         0,4,0,
     *         0,0,4,
     *         3,1,0,
     *         3,0,1,
     *         1,3,0,
     *         0,3,1,
     *         1,0,3,
     *         0,1,3,
     *         2,2,0,
     *         2,0,2,
     *         0,2,2,
     *         2,1,1,
     *         1,2,1,
     *         1,1,2,
     *         5,0,0,  !H
     *         0,5,0,
     *         0,0,5,
     *         4,1,0,
     *         4,0,1,
     *         1,4,0,
     *         0,4,1,
     *         1,0,4,
     *         0,1,4,
     *         3,2,0,
     *         3,0,2,
     *         2,3,0,
     *         0,3,2,
     *         2,0,3,
     *         0,2,3,
     *         3,1,1,
     *         1,3,1,
     *         1,1,3,
     *         2,2,1,
     *         2,1,2,
     *         1,2,2,
     *         6,0,0, !I
     *         0,6,0,
     *         0,0,6,
     *         5,1,0,
     *         5,0,1,
     *         1,5,0,
     *         0,5,1,
     *         1,0,5,
     *         0,1,5,
     *         4,2,0,
     *         4,0,2,
     *         2,4,0,
     *         0,4,2,
     *         2,0,4,
     *         0,2,4,
     *         4,1,1,
     *         1,4,1,
     *         1,1,4,
     *         3,3,0,
     *         3,0,3,
     *         0,3,3,
     *         3,2,1,
     *         3,1,2,
     *         2,3,1,
     *         1,3,2,
     *         2,1,3,
     *         1,2,3,
     *         2,2,2/
      DATA IORG/
     *     1,2,3, 1,2,3,1,3,2, 1,2,3,1,1,2,2,3,3,1,
     *  1,2,3,1,1,2,2,3,3,1,3,2,1,2,3,
     *  1,2,3,2,3,1,3,1,2,2,3,1,3,1,2,2,3,1,3,2,1,
     *  1,2,3,2,3,1,3,1,2,2,3,1,3,1,2,2,3,1,2,1,3,3,2,3,1,2,1,1/
      DATA INDXL/
     *  0, 1,1,1, 2,2,2,2,2,2, 3,3,3,3,3,3,3,3,3,3,
     *  4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
     *  5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,
     *  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6/
      DATA N1/0,1,4,10,20,35,56,84,120/
      DATA N2/0,3,9,19,34,55,83,119,164/
C
      INTEGER :: MA1, MB1, MC1, MD1, MA2, MB2, MC2, MD2,
     *           MCD, MBCD, MABCD, IM1, IM2, KM1, KM2, IP1,
     *           NDIM1, NDIM2, NDIM3, NDIM4, NDIM5,
     *           I, J, K, L, M, NA, NB, NC, ND, IX, NN, JMAX
      DOUBLE PRECISION :: AA1, HAA1, RHO, RZ, RE, HZ, HE, 
     *                    FACT1, FACT2, FACT, T, RM, TMP
C
      MA1=INDXL(MINI)
      MB1=INDXL(MINJ)
      MC1=INDXL(MINK)
      MD1=INDXL(MINL)

      MA2=INDXL(MAXI)
      MB2=INDXL(MAXJ)
      MC2=INDXL(MAXK)
      MD2=INDXL(MAXL)

      NDIM1=N2(MA2+MB2)
      NDIM2=N2(MC2+MD2)
      NDIM3=N2(MA2)
      NDIM4=N2(MC2)
      NDIM5=N2(MB2)

      MCD  =MC2+MD2
      MBCD =MB2+MCD
      MABCD=MA2+MBCD

      ALLOCATE(XIM(0:MABCD,0:NDIM2,0:NDIM1),
     *         YIM(0:NDIM3,0:NDIM1,0:NDIM2),
     *         ZIM(0:NDIM4,0:NDIM2,0:NDIM3,0:NDIM5))

      BA(1)=XJ-XI
      BA(2)=YJ-YI
      BA(3)=ZJ-ZI
      DC(1)=XL-XK
      DC(2)=YL-YK
      DC(3)=ZL-ZK
      PB(1)=PX-XJ
      PB(2)=PY-YJ
      PB(3)=PZ-ZJ
      QD(1)=QX-XL
      QD(2)=QY-YL
      QD(3)=QZ-ZL
      PQ(1)=PX-QX
      PQ(2)=PY-QY
      PQ(3)=PZ-QZ

      AA1  =1.0D+00/(ETA+ZETA)
      HAA1 =0.5D+00*AA1
      RHO  =ETA*ZETA*AA1
      RZ   =RHO/ZETA
      RE   =RHO/ETA
      HZ   =0.5D+00/ZETA
      HE   =0.5D+00/ETA

      FACT1=PI*AA1*SQRT(PI*AA1)
      FACT2=2.0D+00*PI/RHO/RHO
      FACT =FACT1*SAB*SCD*FACT2

      T=RHO*(PQ(1)*PQ(1)+PQ(2)*PQ(2)+PQ(3)*PQ(3))

      CALL RSM_FFUNC(T,MABCD+3,FFTMP)
C
C     (0000;M)
C
      XIM(0,0,0)=FACT*((1.0D+00+T)*FFTMP(1)-T*FFTMP(2))

      DO M=1,MABCD
        RM=DFLOAT(M)
        TMP=-T*FFTMP(M+2)+(RM+1.0D+00+T)*FFTMP(M+1)-RM*FFTMP(M)
        XIM(M,0,0)=FACT*TMP
      ENDDO
C
C     (x000;M)
C
      DO NA=1,MA2+MB2
        DO I=N1(NA),N2(NA)
          IX =IORG(I)
          IM1=IM(IX,I)     !  I - 1
          IM2=IM(IX,IM1)   !  I - 2
          DO M=0,(MABCD-NA)
            XIM(M,0,I)=                        PB(IX)*XIM(M  ,0,IM1)
     *                                     -RZ*PQ(IX)*XIM(M+1,0,IM1)
     *                 +HZ*DFLOAT(NIN(IX,IM1))*(      XIM(M  ,0,IM2)
     *                                            -RZ*XIM(M+1,0,IM2))
          ENDDO
        ENDDO
      ENDDO
C
C     (x0x0)
C
      DO NC=1,MC2+MD2
        DO NA=0,MA2+MB2
          DO I=N1(NA),N2(NA)
            DO K=N1(NC),N2(NC)
              IX=IORG(K)
              KM1=IM(IX,K)
              KM2=IM(IX,KM1)
              IM1=IM(IX,I)

              DO M=0,MCD-NC
                XIM(M,K,I)=                    QD(IX)*XIM(M  ,KM1,I  )
     *                                     +RE*PQ(IX)*XIM(M+1,KM1,I  )
     *                   +HE*REAL(NIN(IX,KM1),8)*(    XIM(M  ,KM2,I  )
     *                                            -RE*XIM(M+1,KM2,I  ))
     *                   +     HAA1*REAL(NIN(IX,I),8)*XIM(M+1,KM1,IM1)
              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO

      DO K=N1(0),N2(MC2+MD2)
        DO I=N1(0),N2(MA2+MB2)
          YIM(0,I,K)=XIM(0,K,I)
        ENDDO
      ENDDO
C
C        (xxx0)
C
      DO K=N1(0),N2(MC2+MD2)
        DO NA=1,MA2
          DO NB=0,MB2+MA2-NA
            DO J=N1(NB),N2(NB)
              DO I=N1(NA),N2(NA)
                IX  = IORG(I)
                IP1 = IP(IX,J)
                IM1 = IM(IX,I)

                YIM(I,J,K)=YIM(IM1,IP1,K)+BA(IX)*YIM(IM1,J,K)
!        write(*,'(7i5,2e20.10)')
!    * k,na,nb,j,i,im1,ip1,YIM(I,J,K),YIM(IM1,IP1,K)

              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO


      DO J=N1(MB1),N2(MB2)
        DO I=N1(MA1),N2(MA2)
          DO K=N1(0),N2(MC2+MD2)
            ZIM(0,K,I,J)=YIM(I,J,K)
!        write(*,'(10x,3i5,e20.10)') j,i,k,YIM(I,J,K)
          ENDDO
        ENDDO
      ENDDO
C
C     (xxxx)
C
      DO J=N1(MB1),N2(MB2)
        DO I=N1(MA1),N2(MA2)
          DO NC=1,MC2
            DO ND=0,MD2+MC2-NC
              DO L=N1(ND),N2(ND)
                DO K=N1(NC),N2(NC)
                  IX  = IORG(K)
                  IP1 = IP(IX,L)
                  IM1 = IM(IX,K)

                  ZIM(K,L,I,J)=ZIM(IM1,IP1,I,J)+DC(IX)*ZIM(IM1,L,I,J)
                ENDDO
              ENDDO
            ENDDO
          ENDDO
        ENDDO
      ENDDO
   
      NN = 0
      JMAX = MAXJ
      DO I=MINI,MAXI
        IF(IANDJ) JMAX = I
        DO J=MINJ,JMAX
          DO K=MINK,MAXK
            DO L=MINL,MAXL
              NN=NN+1
              GTMP(NN)=ZIM(K-1,L-1,I-1,J-1)
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
      DEALLOCATE(XIM,YIM,ZIM)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKFQ1D
C>
C>    @brief   prepare 1D electrostatic potential
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   NTAB: the number of grid points
C>             NU: the number of solute atomic site
C>             NV: the number of solvent atomic site
C>             ALPA: splitting factor
C>             BETA: inverse temperature
C>             RTAB: grid points in r space
C>             RKTAB: grid points in k space
C>             QU: atomic charge of solute atomic site
C>             QV: atomic charge of solvent atomic site
C>             DMAT: fitting coefficient
C>             V: ABS-solvent interaction 
C>             FQS: short range of electrostatic potential in r space
C>             FQLK: long range of electrostatic potential in k space
C>
      SUBROUTINE RSM_MKFQ1D(NTAB,NU,NV,ALPA,BETA,RTAB,RKTAB,QU,QV,DMAT,
     *                      V,FQS,FQLK)
C
      USE ABSMOD, ONLY : KATM0A,NQMT0A,KATM_QMT0A
C
      IMPLICIT NONE
C
      INTEGER,          INTENT(IN   ) :: NTAB, NU, NV
      DOUBLE PRECISION, INTENT(IN   ) :: ALPA, BETA, RTAB(*), RKTAB(*),
     *                                   QU(NU), QV(NV), DMAT(*), 
     *                                   V(NTAB,NV,*)
      DOUBLE PRECISION, INTENT(  OUT) :: FQS(NTAB,NU,NV),FQLK(NTAB,NU,*)
C
      INTEGER                :: II, IV, IU, IRAD, IATM
      DOUBLE PRECISION       :: PI, QIJ, R1, R2, FQL
C
      PI = ACOS(-1.0D+00)
C
      DO II=1,NQMT0A
        IATM = KATM_QMT0A(II)
        DO IV=1,NV
          DO IRAD=1,NTAB
            FQS(IRAD,IATM,IV)=FQS(IRAD,IATM,IV)
     *                        +BETA*DMAT(II)*V(IRAD,IV,II)
          ENDDO
        ENDDO
      ENDDO
C
C     FQS
C
      DO IV=1,NV
        DO IU=1,NU
          QIJ=BETA*QV(IV)*QU(IU)
          DO IRAD=2,NTAB
            R1=MAX(RTAB(IRAD),1.0D-30)
            FQL             =-ERF(ALPA*R1)*QIJ/R1

            FQS(IRAD,IU,IV) = FQS(IRAD,IU,IV)-FQL
          ENDDO
          FQS(1,IU,IV) = FQS(2,IU,IV)
        ENDDO
      ENDDO
C
C     FQLK
C
      DO IV=1,NV
        DO IU=1,NU
          QIJ=BETA*QV(IV)*QU(IU)
          DO IRAD=1,NTAB
            R1=MAX(RKTAB(IRAD),1.0D-30)
            R2=R1*R1

            FQLK(IRAD,IU,IV)=-4.0D+00*PI*QIJ/R2
     *                        *EXP(-R2/4.0D+00/ALPA/ALPA)
          ENDDO
        ENDDO
      ENDDO
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKFQ1DRST
C>
C>    @brief   prepare 1D electrostatic potential in restart calculation
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   NTAB: the number of grid points
C>             NU: the number of solute atomic site
C>             NV: the number of solvent atomic site
C>             ALPA: splitting factor
C>             BETA: inverse temperature
C>             RTAB: grid points in r space
C>             RKTAB: grid points in k space
C>             QU: atomic charge of solute atomic site
C>             QV: atomic charge of solvent atomic site
C>             FQS: short range of electrostatic potential in r space
C>             FQLK: long range of electrostatic potential in k space
C>
      SUBROUTINE RSM_MKFQ1DRST(NTAB,NU,NV,ALPA,BETA,RTAB,RKTAB,QU,QV,
     *                         FQS,FQLK)
C
      USE RISM_IO,  ONLY : IR, IW
      USE RISM_MOD, ONLY : GOPARR, MASWRK, MASTER
C
      IMPLICIT NONE
C
      INTEGER,          INTENT(IN   ) :: NTAB, NU, NV
      DOUBLE PRECISION, INTENT(IN   ) :: ALPA, BETA, RTAB(*), RKTAB(*), 
     *                                   QV(NV)
      DOUBLE PRECISION, INTENT(  OUT) :: QU(NU), FQS(NTAB,NU,NV), 
     *                                   FQLK(NTAB,NU,*)
C
      INTEGER                :: IEOF, I, IV, IU, IRAD
      DOUBLE PRECISION       :: PI, QIJ, R1, R2, FQL
C
      PI = ACOS(-1.0D+00)
C
C     READ QU FROM INPUT
C
      CALL SEQREW(IR)
      CALL FNDGRP(IR,' $QUINI ',IEOF)

      IF (IEOF.NE.0) THEN
        WRITE(IW,*) 'There is no data of initial charges. '
        CALL ABRT
      ENDIF

      IF(MASWRK) THEN
        DO I=1,NU
          READ(IR,*) QU(I)
        ENDDO
      ENDIF

      IF(GOPARR) CALL RSM_BCAST(900,'F',QU,NU,MASTER)
C
C     FQS
C
      DO IV=1,NV
        DO IU=1,NU
          QIJ=BETA*QV(IV)*QU(IU)
          DO IRAD=2,NTAB
            R1=MAX(RTAB(IRAD),1.0D-30)
            FQL             =-ERF(ALPA*R1)*QIJ/R1

            FQS(IRAD,IU,IV) = -QIJ/R1 - FQL
          ENDDO
          FQS(1,IU,IV) = FQS(2,IU,IV)
        ENDDO
      ENDDO
C
C     FQLK
C
      DO IV=1,NV
        DO IU=1,NU
          QIJ=BETA*QV(IV)*QU(IU)
          DO IRAD=1,NTAB
            R1=MAX(RKTAB(IRAD),1.0D-30)
            R2=R1*R1

            FQLK(IRAD,IU,IV)=-4.0D+00*PI*QIJ/R2
     *                        *EXP(-R2/4.0D+00/ALPA/ALPA)
          ENDDO
        ENDDO
      ENDDO
C
      RETURN
      END

C*MODULE RSM_SDDINT  *DECK RSM_CLSLVFCK
C>
C>    @brief   compute solvated Fock matrix
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   NUM: the number of AOs
C>             NSHEL: the numebr of ABSs
C>             NUMIJ: working array (integer)
C>             WK2, H1: working array (real)
C>             VSOLV: electrostatic potential induced by solvent
C>             FA: Fock matrix
C>             DA: density matrix
C>             QMAT: Q matrix (see Chem. Phys. Lett., 587, 113 (2013).)
C>             EUV_E8: solute-solvent interaction energy
C>
      SUBROUTINE RSM_CLSLVFCK(NUM,NSHEL,NUMIJ,WK2,H1,VSOLV,FA,DA,QMAT,
     *                        EUV_E8)

      USE RISM_MOD, ONLY : MASWRK, GOPARR, MASTER
      USE RISM_IO,  ONLY : IRSSQF

      IMPLICIT NONE
C
      INTEGER,          INTENT(IN   ) :: NUM, NSHEL
      INTEGER,          INTENT(  OUT) :: NUMIJ(NUM,*)
      DOUBLE PRECISION, INTENT(IN   ) :: VSOLV(*),DA(*),QMAT(NSHEL+1,*)
      DOUBLE PRECISION, INTENT(  OUT) :: WK2(*), H1(*), EUV_E8
      DOUBLE PRECISION, INTENT(INOUT) :: FA(*)
C
      INTEGER                :: NSHELP, L2, I, J, K, IJ
      DOUBLE PRECISION       :: SUM, VAL
C
      DOUBLE PRECISION       :: TRACEP
C
      NSHELP = NSHEL + 1
      L2     = NUM*(NUM+1)/2
C
      DO I=1,NSHELP
        SUM = 0.0D+00
        DO J=1,NSHEL
          SUM = SUM + VSOLV(J)*QMAT(J,I)
        ENDDO
        WK2(I) = SUM
      ENDDO
C
C
C
      CALL SEQREW(IRSSQF)
C
C     ----- Read overlap matrix
C
      CALL RSM_DARE(H1,L2,43,0)
      DO I=1,L2
        H1(I) = - WK2(NSHELP)*H1(I)
      ENDDO
C
C     ----- Initialize H1- and H2-Matrices -----
C
      IJ=0
      DO I=1,NUM
        DO J=1,I
          IJ=IJ+1
          NUMIJ(I,J)=IJ
          NUMIJ(J,I)=IJ
        ENDDO
      ENDDO
C
C     ----- Make Solvated Fockian W2 = V * X(Inv) * Y -----
C
      IF(MASWRK) THEN
  300   CONTINUE
          READ(IRSSQF,END=400)I,J,K,VAL
          IJ=NUMIJ(I,J)
          H1(IJ)=H1(IJ)+WK2(K)*VAL

          GOTO 300
  400   CONTINUE
      ENDIF
C
C     GIVE VECTORS TO ALL PROCESSES
C
      IF (GOPARR) CALL RSM_BCAST(919,'F',H1,L2,MASTER)
C
C     SAVE SOLVATED FOCK (15) 
C
      CALL RSM_DAWR(H1,L2,15,0)
C
C     ----- Add LR term to FA
C
      DO I=1,L2
        FA(I) = FA(I) + H1(I)
      ENDDO
C
      EUV_E8 = TRACEP(DA,H1,NUM)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_PRPSMT
C>
C>    @brief   compute overlap matrix
C>
C>    @author  Daisuke Yokogawa
C>
      SUBROUTINE RSM_PRPSMT
C
      USE RSMSED,    ONLY: NUM, C
      USE RSM_BSMOD, ONLY: NSHELL,KSTART,KATOM,KTYPE,KNG,KLOC,KMIN,KMAX,
     *                     EX,CS,CP,CD,CF,CG,NORM
C
      IMPLICIT NONE
C
      LOGICAL             :: IANDJ,DOUBLE
C
      DOUBLE PRECISION    :: SBLK(784),DIJ(784),XIN(343),YIN(343),
     *                       ZIN(343)
      INTEGER             :: IJX(784),IJY(784),IJZ(784),IX(84),IY(84),
     *                       IZ(84),JX(84),JY(84),JZ(84)
C
      DOUBLE PRECISION, ALLOCATABLE :: S(:)
C
      INTEGER             :: NI, NJ
      DOUBLE PRECISION    :: XINT,YINT,ZINT,TAA,X0,Y0,Z0,XI,YI,ZI,XJ,YJ,
     *                       ZJ
      COMMON /RSSTV / XINT,YINT,ZINT,TAA,X0,Y0,Z0,
     *                XI,YI,ZI,XJ,YJ,ZJ,NI,NJ
C
      DOUBLE PRECISION, PARAMETER   :: PI212=1.1283791670955D+00, 
     *                                 SQRT3=1.73205080756888D+00,
     *                                 SQRT5=2.23606797749979D+00, 
     *                                 SQRT7=2.64575131106459D+00
C
      DATA JX / 0, 1, 0, 0, 2, 0, 0, 1, 1, 0,
     *          3, 0, 0, 2, 2, 1, 0, 1, 0, 1,
     *          4, 0, 0, 3, 3, 1, 0, 1, 0, 2,
     *          2, 0, 2, 1, 1,
     *          5, 0, 0, 4, 4, 1, 0, 1, 0, 3,
     *          3, 2, 0, 2, 0, 3, 1, 1, 2, 2,
     *          1,
     *          6, 0, 0, 5, 5, 1, 0, 1, 0, 4,
     *          4, 2, 0, 2, 0, 4, 1, 1, 3, 3,
     *          0, 3, 3, 2, 1, 2, 1, 2/
      DATA IX / 1, 8, 1, 1,15, 1, 1, 8, 8, 1,
     *         22, 1, 1,15,15, 8, 1, 8, 1, 8,
     *         29, 1, 1,22,22, 8, 1, 8, 1,15,
     *         15, 1,15, 8, 8,
     *         36, 1, 1,29,29, 8, 1, 8, 1,22,
     *         22,15, 1,15, 1,22, 8, 8,15,15,
     *          8,
     *         43, 1, 1,36,36, 8, 1, 8, 1,29,
     *         29,15, 1,15, 1,29, 8, 8,22,22,
     *          1,22,22,15, 8,15, 8,15/
      DATA JY / 0, 0, 1, 0, 0, 2, 0, 1, 0, 1,
     *          0, 3, 0, 1, 0, 2, 2, 0, 1, 1,
     *          0, 4, 0, 1, 0, 3, 3, 0, 1, 2,
     *          0, 2, 1, 2, 1,
     *          0, 5, 0, 1, 0, 4, 4, 0, 1, 2,
     *          0, 3, 3, 0, 2, 1, 3, 1, 2, 1,
     *          2,
     *          0, 6, 0, 1, 0, 5, 5, 0, 1, 2,
     *          0, 4, 4, 0, 2, 1, 4, 1, 3, 0,
     *          3, 2, 1, 3, 3, 1, 2, 2/
      DATA IY / 1, 1, 8, 1, 1,15, 1, 8, 1, 8,
     *          1,22, 1, 8, 1,15,15, 1, 8, 8,
     *          1,29, 1, 8, 1,22,22, 1, 8,15,
     *          1,15, 8,15, 8,
     *          1,36, 1, 8, 1,29,29, 1, 8,15,
     *          1,22,22, 1,15, 8,22, 8,15, 8,
     *         15,
     *          1,43, 1, 8, 1,36,36, 1, 8,15,
     *          1,29,29, 1,15, 8,29, 8,22, 1,
     *         22,15, 8,22,22, 8,15,15/
      DATA JZ / 0, 0, 0, 1, 0, 0, 2, 0, 1, 1,
     *          0, 0, 3, 0, 1, 0, 1, 2, 2, 1,
     *          0, 0, 4, 0, 1, 0, 1, 3, 3, 0,
     *          2, 2, 1, 1, 2,
     *          0, 0, 5, 0, 1, 0, 1, 4, 4, 0,
     *          2, 0, 2, 3, 3, 1, 1, 3, 1, 2,
     *          2,
     *          0, 0, 6, 0, 1, 0, 1, 5, 5, 0,
     *          2, 0, 2, 4, 4, 1, 1, 4, 0, 3,
     *          3, 1, 2, 1, 2, 3, 3, 2/
      DATA IZ / 1, 1, 1, 8, 1, 1,15, 1, 8, 8,
     *          1, 1,22, 1, 8, 1, 8,15,15, 8,
     *          1, 1,29, 1, 8, 1, 8,22,22, 1,
     *         15,15, 8, 8,15,
     *          1, 1,36, 1, 8, 1, 8,29,29, 1,
     *         15, 1,15,22,22, 8, 8,22, 8,15,
     *         15,
     *          1, 1,43, 1, 8, 1, 8,36,36, 1,
     *         15, 1,15,29,29, 8, 8,29, 1,22,
     *         22, 8,15, 8,15,22,22,15/
C
      INTEGER :: L1, L2, NX, NY, NZ, IJ, MAX, NN, JGMAX,
     *           II, I, I1, I2, LIT, MINI, MAXI, LOCI, IG, IN, LI,
     *           JJ, J, J1, J2, LJT, MINJ, MAXJ, LOCJ, JG, JN, LJ
      DOUBLE PRECISION :: RR, DUM, DUM1, DUM2, AA, AA1, T1, T2, ARRI,
     *                    AI, CSI, CPI, CDI, CFI, CGI,
     *                    AJ, CSJ, CPJ, CDJ, CFJ, CGJ,
     *                    AXI, AYI, AZI, AX, AY, AZ, FAC
C
C     NORM = .TRUE.
C
      L1 = NUM
      L2 = (L1*(L1+1))/2
C
      ALLOCATE(S(L2))
C
      CALL VCLR(S ,1,L2)
C
C     ----- I SHELL -----
C
      DO II = 1, NSHELL
        I = KATOM(II)
        XI = C(1,I)
        YI = C(2,I)
        ZI = C(3,I)
        I1 = KSTART(II)
        I2 = I1+KNG(II)-1
        LIT = KTYPE(II)
        MINI = KMIN(II)
        MAXI = KMAX(II)
        LOCI = KLOC(II)-MINI
C
C     ----- J SHELL -----
C
        DO JJ = 1,II
          J = KATOM(JJ)
          XJ = C(1,J)
          YJ = C(2,J)
          ZJ = C(3,J)
          J1 = KSTART(JJ)
          J2 = J1+KNG(JJ)-1
          LJT = KTYPE(JJ)
          MINJ = KMIN(JJ)
          MAXJ = KMAX(JJ)
          LOCJ = KLOC(JJ)-MINJ
          RR = (XI-XJ)**2+(YI-YJ)**2+(ZI-ZJ)**2
          IANDJ = II .EQ. JJ
C
C     ----- PREPARE INDICES FOR PAIRS OF (I,J) FUNCTIONS
C
          IJ = 0
          MAX = MAXJ
          DO I = MINI,MAXI
            NX = IX(I)
            NY = IY(I)
            NZ = IZ(I)
            IF (IANDJ) MAX = I
            DO J = MINJ,MAX
              IJ = IJ+1
              IJX(IJ) = NX+JX(J)
              IJY(IJ) = NY+JY(J)
              IJZ(IJ) = NZ+JZ(J)
            ENDDO
          ENDDO
C
          CALL VCLR( SBLK,1,IJ)
C
C     ----- I PRIMITIVE
C
          JGMAX = J2
          DO IG = I1,I2
            AI = EX(IG)
            ARRI = AI*RR
            AXI = AI*XI
            AYI = AI*YI
            AZI = AI*ZI
            CSI = CS(IG)
            CPI = CP(IG)
            CDI = CD(IG)
            CFI = CF(IG)
            CGI = CG(IG)
C
C     ----- J PRIMITIVE
C
            IF (IANDJ) JGMAX = IG
            DO JG = J1,JGMAX
              AJ = EX(JG)
              AA = AI+AJ
              AA1 = 1.0D+00/AA
              DUM = AJ*ARRI*AA1
              FAC = EXP(-DUM)
              CSJ = CS(JG)
              CPJ = CP(JG)
              CDJ = CD(JG)
              CFJ = CF(JG)
              CGJ = CG(JG)
              AX = (AXI+AJ*XJ)*AA1
              AY = (AYI+AJ*YJ)*AA1
              AZ = (AZI+AJ*ZJ)*AA1
C
C     ----- DENSITY FACTOR
C
              DOUBLE=IANDJ.AND.IG.NE.JG
              MAX = MAXJ
              NN = 0
              DUM1 = 0.0D+00
              DUM2 = 0.0D+00
              DO I = MINI,MAXI
                IF (I.EQ.1) DUM1=CSI*FAC
                IF (I.EQ.2) DUM1=CPI*FAC
                IF (I.EQ.5) DUM1=CDI*FAC
                IF ((I.EQ. 8).AND.NORM) DUM1=DUM1*SQRT3
                IF (I.EQ.11) DUM1=CFI*FAC
                IF ((I.EQ.14).AND.NORM) DUM1=DUM1*SQRT5
                IF ((I.EQ.20).AND.NORM) DUM1=DUM1*SQRT3
                IF (I.EQ.21) DUM1=CGI*FAC
                IF ((I.EQ.24).AND.NORM) DUM1=DUM1*SQRT7
                IF ((I.EQ.30).AND.NORM) DUM1=DUM1*SQRT5/SQRT3
                IF ((I.EQ.33).AND.NORM) DUM1=DUM1*SQRT3
                IF (IANDJ) MAX = I
                DO J = MINJ,MAX
                  IF (J.EQ.1) THEN
                    DUM2=DUM1*CSJ
                    IF (DOUBLE) THEN
                      IF (I.LE.1) THEN
                        DUM2=DUM2+DUM2
                      ELSE
                        DUM2=DUM2+CSI*CPJ*FAC
                      END IF
                    END IF
                  ELSE IF (J.EQ.2) THEN
                    DUM2=DUM1*CPJ
                    IF (DOUBLE) DUM2=DUM2+DUM2
                  ELSE IF (J.EQ.5) THEN
                    DUM2=DUM1*CDJ
                    IF (DOUBLE) DUM2=DUM2+DUM2
                  ELSE IF ((J.EQ.8).AND.NORM) THEN
                    DUM2=DUM2*SQRT3
                  ELSE IF (J.EQ.11) THEN
                    DUM2=DUM1*CFJ
                    IF (DOUBLE) DUM2=DUM2+DUM2
                  ELSE IF ((J.EQ.14).AND.NORM) THEN
                    DUM2=DUM2*SQRT5
                  ELSE IF ((J.EQ.20).AND.NORM) THEN
                    DUM2=DUM2*SQRT3
                  ELSE IF (J.EQ.21) THEN
                    DUM2=DUM1*CGJ
                    IF (DOUBLE) DUM2=DUM2+DUM2
                  ELSE IF ((J.EQ.24).AND.NORM) THEN
                    DUM2=DUM2*SQRT7
                  ELSE IF ((J.EQ.30).AND.NORM) THEN
                    DUM2=DUM2*SQRT5/SQRT3
                  ELSE IF ((J.EQ.33).AND.NORM) THEN
                    DUM2=DUM2*SQRT3
                  END IF
                  NN = NN+1
                  DIJ(NN) = DUM2
                ENDDO
              ENDDO
C
C     ----- OVERLAP AND KINETIC ENERGY
C
              TAA = SQRT(AA1)
              T1 = -2.0D+00*AJ*AJ*TAA
              T2 = -0.5D+00*TAA
              X0 = AX
              Y0 = AY
              Z0 = AZ
              IN = -7
              DO I = 1,LIT
                IN = IN+7
                NI = I
                DO J = 1,LJT
                  JN = IN+J
                  NJ = J
                  CALL RSM_STVINT
                  XIN(JN) = XINT*TAA
                  YIN(JN) = YINT*TAA
                  ZIN(JN) = ZINT*TAA
                ENDDO
              ENDDO

              DO I = 1,IJ
                NX = IJX(I)
                NY = IJY(I)
                NZ = IJZ(I)
                DUM   =             XIN(NX)    *YIN(NY)*ZIN(NZ)
                SBLK(I) =  SBLK(I) + DIJ(I)* DUM
              ENDDO
C
C     ----- END OF PRIMITIVE LOOPS -----
C
            ENDDO
          ENDDO
C
C     ----- SET BLOCK OF NUCLEAR ATTRACTION, OVERLAP, AND KINETIC ENERGY
C
          MAX = MAXJ
          NN = 0
          DO I = MINI,MAXI
            LI = LOCI+I
            IN = (LI*(LI-1))/2
            IF (IANDJ) MAX = I
            DO J = MINJ,MAX
              LJ = LOCJ+J
              JN = LJ+IN
              NN = NN+1
              S(JN) =  SBLK(NN)
            ENDDO
          ENDDO
C
C     ----- END OF SHELL LOOPS -----
C
        ENDDO
      ENDDO
C
C     ----- SAVE H, S, AND T MATRICES ON THE DAF -----
C
      CALL RSM_DAWR(S,L2,43,0)
C
      DEALLOCATE(S)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKDXMT
C>
C>    @brief   compute the derivative of X matrix
C>             (please see Chem. Phys. Lett., 587, 113 (2013).)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   DMT: fitting coeficient
C>             DER1: the derivative of X matrix
C>
      SUBROUTINE RSM_MKDXMT(DMT,DER1)
C
      USE RISM_MOD, ONLY : NSHEL0A
      USE RSMSED,   ONLY : NAT, C
      USE ABSMOD,   ONLY : KATM0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, EX0A,
     *                     COF0A, TRN3, TQ, NQMT0A, KTYP0A
C
      IMPLICIT NONE
C
      DOUBLE PRECISION :: DMT(*), DER1(NQMT0A+1,3,NAT)
C
      DOUBLE PRECISION :: GTMP(196000),DTMP(122500,3)
      DOUBLE PRECISION :: WRKX(10000),WRKY(10000),WRKZ(10000)
      DOUBLE PRECISION :: XI,YI,ZI, XJ,YJ,ZJ, XK,YK,ZK, XL,YL,ZL,
     *                    VALX1,VALX2,VALY1,VALY2,VALZ1,VALZ2,ZETA,ETA, 
     *                    VAL1, VAL2, RR, AL, CSI, CSK, DIJKL

      INTEGER :: I, J, K, L, NN, MM, MINI, MAXI, MINJ, MAXJ, MINK, MAXK,
     *           MINL, MAXL, IG, JG, KG, LG, I1, I2, J1, J2, K1, K2,
     *           L1, L2, II, KK, IJ, IAT, KAT, LLT, MINLM, MAXLP
C
      INTEGER, ALLOCATABLE           :: IA(:,:)
      DOUBLE PRECISION,  ALLOCATABLE :: DXMAT(:,:,:),WRK1(:,:),WRK2(:,:)
C
      INTEGER :: MINF(0:4),MAXF(4)
      DATA MINF/1,1,2, 5,11/
      DATA MAXF/  1,4,10,20/
C
      ALLOCATE(IA(NSHEL0A,NSHEL0A))
      ALLOCATE(DXMAT(NSHEL0A*(NSHEL0A+1)/2,3,NAT),
     *         WRK1(NSHEL0A,NSHEL0A),WRK2(NSHEL0A,NQMT0A))
C
      CALL VCLR(DXMAT,1,NSHEL0A*(NSHEL0A+1)/2*3*NAT)

      NN=0
      DO I=1,NSHEL0A
        DO J=1,I
          NN=NN+1
          IA(I,J)=NN
          IA(J,I)=NN
        ENDDO
      ENDDO
C
C     ----- I SHELL
C
      NN=0
      DO II = 1,NSHEL0A
        IAT = KATM0A(II)
        XI  = C(1,IAT)
        YI  = C(2,IAT)
        ZI  = C(3,IAT)

        I1  = KSTRT0A(II)
        I2  = I1 + KNG0A(II) - 1

        MINI = KMIN0A(II)
        MAXI = KMAX0A(II)

        XJ  = XI
        YJ  = YI
        ZJ  = ZI

        J1  = I1
        J2  = I2

        MINJ = MINI
        MAXJ = MAXI
C
C        ----- J SHELL
C
        DO KK = 1,II
          KAT = KATM0A(KK)
          XK  = C(1,KAT)
          YK  = C(2,KAT)
          ZK  = C(3,KAT)

          K1  = KSTRT0A(KK)
          K2  = K1 + KNG0A(KK) - 1

          MINK = KMIN0A(KK)
          MAXK = KMAX0A(KK)

          XL   = XK
          YL   = YK
          ZL   = ZK

          L1   = K1
          L2   = K2

          LLT  = KTYP0A(KK)
          MINL = MINK
          MAXL = MAXK
          MINLM= MINF(LLT-1)
          MAXLP= MAXF(LLT+1)

          RR =((XI-XK)*(XI-XK)+(YI-YK)*(YI-YK)+(ZI-ZK)*(ZI-ZK))

          NN = NN + 1         

          WRKX = 0.0D+00
          WRKY = 0.0D+00
          WRKZ = 0.0D+00
          DO IG=I1,I2
            DO JG=J1,J2
              ZETA= EX0A(IG) + EX0A(JG)
              CSI = COF0A(IG)*COF0A(JG)

              DO KG=K1,K2
                DO LG=L1,L2
                  ETA = EX0A(KG)+EX0A(LG)
                  CSK = COF0A(KG)*COF0A(LG)

                  AL  = EX0A(LG)

                  GTMP = 0.0D+00
                  CALL RSM_OSINT1(.FALSE.,MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                        MINLM,MAXLP,ZETA,ETA,XI,YI,ZI,XK,YK,ZK,XI,
     *                        YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,1.0D+00,
     *                        1.0D+00,GTMP)
           
                  CALL RSM_OSDER2(.FALSE.,AL,MINI,MAXI,MINJ,MAXJ,MINK,
     *                            MAXK,MINL,MAXL,MINLM,MAXLP,GTMP,DTMP)
C
                  DIJKL = 2.0D+00*CSI*CSK

                  MM = 0
                  DO I=MINI,MAXI
                    DO J=MINJ,MAXJ
                      DO K=MINK,MAXK
                        DO L=MINL,MAXL
                          MM = MM + 1

                          WRKX(MM) = WRKX(MM) + DIJKL*DTMP(MM,1)
                          WRKY(MM) = WRKY(MM) + DIJKL*DTMP(MM,2)
                          WRKZ(MM) = WRKZ(MM) + DIJKL*DTMP(MM,3)
                        ENDDO
                      ENDDO
                    ENDDO
                  ENDDO
                ENDDO
              ENDDO
            ENDDO
          ENDDO

          MM = 0
          VALX2 = 0.0D+00
          VALY2 = 0.0D+00
          VALZ2 = 0.0D+00
          DO I=MINI,MAXI
            DO J=MINJ,MAXJ
              VALX1 = 0.0D+00
              VALY1 = 0.0D+00
              VALZ1 = 0.0D+00
              DO K=MINK,MAXK
                DO L=MINL,MAXL
                  MM = MM + 1

                  VALX1 = VALX1 + TRN3(L,K)*WRKX(MM)
                  VALY1 = VALY1 + TRN3(L,K)*WRKY(MM)
                  VALZ1 = VALZ1 + TRN3(L,K)*WRKZ(MM)
                ENDDO
              ENDDO
              VALX2 = VALX2 + TRN3(J,I)*VALX1
              VALY2 = VALY2 + TRN3(J,I)*VALY1
              VALZ2 = VALZ2 + TRN3(J,I)*VALZ1
            ENDDO
          ENDDO

          DXMAT(NN,1,IAT)=DXMAT(NN,1,IAT)-VALX2
          DXMAT(NN,2,IAT)=DXMAT(NN,2,IAT)-VALY2
          DXMAT(NN,3,IAT)=DXMAT(NN,3,IAT)-VALZ2
          DXMAT(NN,1,KAT)=DXMAT(NN,1,KAT)+VALX2
          DXMAT(NN,2,KAT)=DXMAT(NN,2,KAT)+VALY2
          DXMAT(NN,3,KAT)=DXMAT(NN,3,KAT)+VALZ2
C
C     ----- END OF SHELLS
C
        ENDDO
      ENDDO

      DO IAT=1,NAT
        DO K=1,3

          DO I=1,NSHEL0A
            DO J=1,NSHEL0A
              IJ=IA(I,J)

              WRK1(J,I) = DXMAT(IJ,K,IAT)
            ENDDO
          ENDDO

          DO I=1,NQMT0A
            DO J=1,NSHEL0A
              VAL1=0.0D+00
              DO L=1,NSHEL0A
                VAL1 = VAL1 + TQ(L,I)*WRK1(L,J)
              ENDDO
              WRK2(J,I) = VAL1
            ENDDO
          ENDDO

          DO I=1,NQMT0A
            VAL2 = 0.0D+00
            DO J=1,NQMT0A
              VAL1 = 0.0D+00
              DO L=1,NSHEL0A
                VAL1 = VAL1 + TQ(L,J)*WRK2(L,I)
              ENDDO
              VAL2 = VAL2 + VAL1*DMT(J)
            ENDDO
            DER1(I,K,IAT)=VAL2
          ENDDO
        ENDDO
      ENDDO

      DEALLOCATE(IA,DXMAT,WRK1,WRK2)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_OSDER2
C>
C>    @brief   compute derivatives with Obara-Saika in RSM_MKDXMT
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   IANDJ: shell II is equal to shell JJ, or not
C>             AL: the exponent of L shell
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             MINLM: starting counters of the shell, which 
C>                    angular momentum is L-1
C>             MAXLP: ending counter of the shell, which
C>                    angular momentum is L+1
C>             GTMP: data computed in RSM_OSINT1
C>             DTMP: derivatives 
C>
      SUBROUTINE RSM_OSDER2(IANDJ,AL,MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,
     *                      MAXL,MINLM,MAXLP,GTMP,DTMP)
      IMPLICIT NONE
C
      LOGICAL,          INTENT(IN   ) :: IANDJ
      INTEGER,          INTENT(IN   ) :: MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                                   MINL,MAXL,MINLM,MAXLP
      DOUBLE PRECISION, INTENT(IN   ) :: AL, GTMP(196000)
      DOUBLE PRECISION, INTENT(  OUT) :: DTMP(122500,3)

      DOUBLE PRECISION                :: WRK(35)
C
      INTEGER                :: LP(3,10), LM(3,10), MINF(4), MAXF(4)
      DOUBLE PRECISION       :: RIN(3,10)

      DATA LP/ 2, 3, 4, !  S
     *         5, 8, 9, !  X
     *         8, 6,10, !  Y
     *         9,10, 7, !  Z
     *        11,14,15, !  XX
     *        16,12,17, !  YY
     *        18,19,13, !  ZZ
     *        14,16,20, !  XY
     *        15,20,18, !  XZ
     *        20,17,19/ !  YZ
      DATA LM/ 1, 1, 1, !  S
     *         1, 1, 1, !  X
     *         1, 1, 1, !  Y
     *         1, 1, 1, !  Z
     *         2, 1, 1, !  XX
     *         1, 3, 1, !  YY
     *         1, 1, 4, !  ZZ
     *         3, 2, 1, !  XY
     *         4, 1, 2, !  XZ
     *         1, 4, 3/ !  YZ
      DATA RIN/0.0D+00,0.0D+00,0.0D+00, !S
     *         1.0D+00,0.0D+00,0.0D+00, !X
     *         0.0D+00,1.0D+00,0.0D+00, !Y
     *         0.0D+00,0.0D+00,1.0D+00, !Z
     *         2.0D+00,0.0D+00,0.0D+00, !XX
     *         0.0D+00,2.0D+00,0.0D+00, !YY
     *         0.0D+00,0.0D+00,2.0D+00, !ZZ
     *         1.0D+00,1.0D+00,0.0D+00, !XY
     *         1.0D+00,0.0D+00,1.0D+00, !XZ
     *         0.0D+00,1.0D+00,1.0D+00/ !YZ
C
      INTEGER :: I, J, K, L, NN, MM, LPX, LPY, LPZ, LMX, LMY, LMZ, JMAX
      DOUBLE PRECISION :: TAL, RX, RY, RZ
C
      TAL = AL+AL
      NN = 0
      MM = 0
      JMAX = MAXJ
      DO I=MINI,MAXI
        IF(IANDJ) JMAX = I
        DO J=MINJ,JMAX
          DO K=MINK,MAXK
            DO L=MINLM,MAXLP
              NN = NN + 1

              WRK(L) = GTMP(NN)
            ENDDO

            DO L=MINL,MAXL
              MM = MM + 1
              LPX = LP(1,L)
              LPY = LP(2,L)
              LPZ = LP(3,L)

              LMX = LM(1,L)
              LMY = LM(2,L)
              LMZ = LM(3,L)

              RX  = RIN(1,L)
              RY  = RIN(2,L)
              RZ  = RIN(3,L)

              DTMP(MM,1) = TAL*WRK(LPX) - RX*WRK(LMX)
              DTMP(MM,2) = TAL*WRK(LPY) - RY*WRK(LMY)
              DTMP(MM,3) = TAL*WRK(LPZ) - RZ*WRK(LMZ)
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKDYMT1
C>
C>    @brief   compute the derivative of Y matrix
C>             (please see Chem. Phys. Lett., 587, 113 (2013).)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   PA: density matrix
C>             DER2: the derivative of Y matrix
C>
      SUBROUTINE RSM_MKDYMT1(PA,DER2)
C
      USE RISM_MOD, ONLY : RSM_ISTIEND, GOPARR, NSHEL0A
      USE RSMSED,   ONLY : NUM, C, NAT
      USE RSM_BSMOD,ONLY : NSHELL,KSTART,KATOM,KTYPE,KNG,KLOC,KMIN,KMAX,
     *                     EX,CS,CP,CD,CF,CG,NORM
      USE ABSMOD,   ONLY : KATM0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, EX0A,
     *                     COF0A, TRN3, NQMT0A, TQ
C
      IMPLICIT NONE
C
      DOUBLE PRECISION, INTENT(IN   ) :: PA(*)
      DOUBLE PRECISION, INTENT(  OUT) :: DER2(NQMT0A+1,3,NAT)
C
      INTEGER               :: MAXADD(5), MINMIN(5)
      DOUBLE PRECISION      :: DIJ(225),
     *                         WRKX(225,36),WRKY(225,36),WRKZ(225,36),
     *                         DTMPX(225,36),DTMPY(225,36),DTMPZ(225,36)
C
      DOUBLE PRECISION, ALLOCATABLE   :: GTMP(:),DWRK(:,:,:)
      INTEGER, ALLOCATABLE            :: NIJ(:,:)
C
      DOUBLE PRECISION,  PARAMETER    :: SQRT3=1.73205080756888D+00,
     *                                   SQRT5=2.23606797749979D+00, 
     *                                   SQRT7=2.64575131106459D+00,
     *                                   RLN10=2.30258D+00
C
      DATA MINMIN/0,1, 3, 6,10/
      DATA MAXADD/3,6,10,15,21/
C
      INTEGER               :: I, J, IJ, K, L, KL, ISTRT, IEND, NSHTT,
     *                         II, IAT, I1, I2, MINI, MAXI, LOCI, IG,
     *                         JJ, JAT, J1, J2, MINJ, MAXJ, LOCJ, JG,
     *                         KK, K1, K2, MINK, MAXK, KG, 
     *                         L1, L2, MINL, MAXL, LG, LCI, LCJ, L12,
     *                         LJT, MINJM, MAXJP, IJPM, NN, MM
      DOUBLE PRECISION      :: XI, YI, ZI, XJ, YJ, ZJ, XK, YK, ZK,
     *                         XL, YL, ZL, PX, PY, PZ,
     *                         CSI, CPI, CDI, CFI, CGI, AI,
     *                         CSJ, CPJ, CDJ, CFJ, CGJ, AJ,
     *                         VAL, ZETA, ZETA1, AXI, AYI, AZI, ETA, 
     *                         CSK, RR, ARRI, DKL, TRNFC,
     *                         DUM, DUM1, DUM2, SAB, VALX2, VALY2, VALZ2
C
      ALLOCATE(NIJ(NUM,NUM))
      ALLOCATE(GTMP(310*NSHEL0A),DWRK(NSHEL0A,3,NAT))
C
      CALL RSM_ISTIEND(NSHEL0A,ISTRT,IEND,NSHTT)
      L12 = NSHEL0A*3*NAT

      CALL VCLR(DWRK ,1,L12)
C
      IJ = 0
      DO I=1,NUM
        DO J=1,I
          IJ = IJ + 1
          NIJ(J,I) = IJ
          NIJ(I,J) = IJ
        ENDDO
      ENDDO
C
C     ---- I SHELL -----
C
      DO II = 1,NSHELL
        IAT  = KATOM(II)
        XI   = C(1,IAT)
        YI   = C(2,IAT)
        ZI   = C(3,IAT)
        I1   = KSTART(II)
        I2   = I1+KNG(II)-1
        MINI = KMIN(II)
        MAXI = KMAX(II)
        LOCI = KLOC(II)-MINI
C
C     ----- J SHELL -----
C
        DO JJ = 1,NSHELL
          JAT  = KATOM(JJ)
          LJT  = KTYPE(JJ)
          XJ   = C(1,JAT)
          YJ   = C(2,JAT)
          ZJ   = C(3,JAT)
          J1   = KSTART(JJ)
          J2   = J1+KNG(JJ)-1
          MINJ = KMIN(JJ)
          MAXJ = KMAX(JJ)
          MINJM= MAX(1,MINJ - MINMIN(LJT))
          MAXJP= MAXJ + MAXADD(LJT)
          LOCJ = KLOC(JJ)-MINJ

          RR = (XI-XJ)**2+(YI-YJ)**2+(ZI-ZJ)**2

          IJPM = 0
          DO I=MINI,MAXI
            DO J=MINJM,MAXJP
              IJPM = IJPM + 1
            ENDDO
          ENDDO
C
C         ----- K SHELL
C
          DO KK=ISTRT,IEND
            K    = KATM0A(KK)
            XK   = C(1,K)
            YK   = C(2,K)
            ZK   = C(3,K)
            MINK = KMIN0A(KK)
            MAXK = KMAX0A(KK)

            XL   = XK
            YL   = YK
            ZL   = ZK
            MINL = MINK
            MAXL = MAXK

            K1   = KSTRT0A(KK)
            K2   = K1 + KNG0A(KK) - 1

            L1   = K1
            L2   = K2
C
C           ----- I PRIMITIVE
C
            WRKX = 0.0D+00
            WRKY = 0.0D+00
            WRKZ = 0.0D+00
            DO IG = I1,I2
              AI   = EX(IG)
              ARRI = AI*RR
              AXI  = AI*XI
              AYI  = AI*YI
              AZI  = AI*ZI
              CSI  = CS(IG)
              CPI  = CP(IG)
              CDI  = CD(IG)
              CFI  = CF(IG)
              CGI  = CG(IG)
C
C           ----- J PRIMITIVE
C
              DO JG = J1,J2
                AJ    = EX(JG)
                ZETA  = AI+AJ
                ZETA1 = 1.0D+00/ZETA
                DUM   = AJ*ARRI*ZETA1
                SAB   = EXP(-DUM)
                CSJ   = CS(JG)
                CPJ   = CP(JG)
                CDJ   = CD(JG)
                CFJ   = CF(JG)
                CGJ   = CG(JG)
                PX    = (AXI+AJ*XJ)*ZETA1
                PY    = (AYI+AJ*YJ)*ZETA1
                PZ    = (AZI+AJ*ZJ)*ZETA1
C
C     ----- DENSITY FACTOR
C
                IJ = 0
                DUM1 = 0.0D+00
                DUM2 = 0.0D+00
                DO I = MINI,MAXI
                  IF (I.EQ.1) DUM1=CSI
                  IF (I.EQ.2) DUM1=CPI
                  IF (I.EQ.5) DUM1=CDI
                  IF ((I.EQ. 8).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.11) DUM1=CFI
                  IF ((I.EQ.14).AND.NORM) DUM1=DUM1*SQRT5
                  IF ((I.EQ.20).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.21) DUM1=CGI
                  IF ((I.EQ.24).AND.NORM) DUM1=DUM1*SQRT7
                  IF ((I.EQ.30).AND.NORM) DUM1=DUM1*SQRT5/SQRT3
                  IF ((I.EQ.33).AND.NORM) DUM1=DUM1*SQRT3
                  DO J = MINJ,MAXJ
                    IF (J.EQ.1) THEN
                      DUM2=DUM1*CSJ
                    ELSE IF (J.EQ.2) THEN
                      DUM2=DUM1*CPJ
                    ELSE IF (J.EQ.5) THEN
                      DUM2=DUM1*CDJ
                    ELSE IF ((J.EQ.8).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.11) THEN
                      DUM2=DUM1*CFJ
                    ELSE IF ((J.EQ.14).AND.NORM) THEN
                      DUM2=DUM2*SQRT5
                    ELSE IF ((J.EQ.20).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.21) THEN
                      DUM2=DUM1*CGJ
                    ELSE IF ((J.EQ.24).AND.NORM) THEN
                      DUM2=DUM2*SQRT7
                    ELSE IF ((J.EQ.30).AND.NORM) THEN
                      DUM2=DUM2*SQRT5/SQRT3
                    ELSE IF ((J.EQ.33).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    END IF
                    IJ = IJ + 1
                    DIJ(IJ) = 2.0D+00*DUM2
                  ENDDO
                ENDDO

                KL = 0
                DO K=MINK,MAXK
                  DO L=MINL,MAXL
                    KL = KL + 1
                  ENDDO
                ENDDO

                DO KG=K1,K2
                  DO LG=L1,L2
                    ETA = EX0A(KG) + EX0A(LG)
                    CSK = COF0A(KG) * COF0A(LG)

                    DKL = CSK

                    GTMP = 0.0D+00

                    CALL RSM_OSINT1(.FALSE.,MINI,MAXI,MINJM,MAXJP,MINK,
     *                          MAXK,
     *                          MINL,MAXL,ZETA,ETA,PX,PY,PZ,XK,YK,ZK,XI,
     *                          YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,SAB,
     *                          1.0D+00,GTMP)

                    CALL RSM_OSDER1A(AJ,MINI,MAXI,MINJ,MAXJ,MINJM,MAXJP,
     *                           MINK,MAXK,MINL,MAXL,KL,GTMP,DTMPX,
     *                           DTMPY,DTMPZ)
                    DO K=1,KL
                      DO I=1,IJ
                        WRKX(I,K) = WRKX(I,K) + DIJ(I)*DTMPX(I,K)*DKL
                        WRKY(I,K) = WRKY(I,K) + DIJ(I)*DTMPY(I,K)*DKL
                        WRKZ(I,K) = WRKZ(I,K) + DIJ(I)*DTMPZ(I,K)*DKL
                      ENDDO
                    ENDDO
C
C                   ----- END OF PRIMITIVES
C
                  ENDDO
                ENDDO
              ENDDO
            ENDDO

            KL = 0
            VALX2 = 0.0D+00
            VALY2 = 0.0D+00
            VALZ2 = 0.0D+00
            DO K=MINK,MAXK
              DO L=MINL,MAXL
                KL = KL + 1

                TRNFC = TRN3(L,K)
                NN = 0
                DO I=MINI,MAXI
                  LCI = LOCI + I
                  DO J=MINJ,MAXJ
                    LCJ = LOCJ + J
                    MM  = NIJ(LCI,LCJ)
                    NN = NN + 1

                    DUM = PA(MM)*TRNFC

                    VALX2 = VALX2 + DUM*WRKX(NN,KL)
                    VALY2 = VALY2 + DUM*WRKY(NN,KL)
                    VALZ2 = VALZ2 + DUM*WRKZ(NN,KL)
                  ENDDO
                ENDDO
              ENDDO
            ENDDO

            DWRK(KK,1,JAT)=DWRK(KK,1,JAT)+ VALX2
            DWRK(KK,2,JAT)=DWRK(KK,2,JAT)+ VALY2
            DWRK(KK,3,JAT)=DWRK(KK,3,JAT)+ VALZ2
C
          ENDDO
        ENDDO
      ENDDO

      IF(GOPARR) CALL RSM_GSUMF(10000,DWRK,L12)

      DO I=1,NAT
        DO J=1,3
          DO K=1,NQMT0A
            VAL = 0.0D+00
            DO L=1,NSHEL0A 
              VAL = VAL + TQ(L,K)*DWRK(L,J,I)
            ENDDO
            DER2(K,J,I) = VAL
          ENDDO
        ENDDO
      ENDDO
C
      DEALLOCATE(NIJ)
      DEALLOCATE(GTMP,DWRK)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKDYMT2
C>
C>    @brief   compute the derivative of Y matrix
C>             (please see Chem. Phys. Lett., 587, 113 (2013).)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   PA: density matrix
C>             DER2: the derivative of Y matrix
C>
      SUBROUTINE RSM_MKDYMT2(PA,DER2)

      USE ABSMOD,   ONLY : KATM0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, EX0A,
     *                     COF0A, KTYP0A, TRN3, NQMT0A, TQ
      USE RISM_MOD, ONLY : RSM_ISTIEND, GOPARR, NSHEL0A
      USE RSMSED,   ONLY : NUM, C, NAT
      USE RSM_BSMOD,ONLY : NSHELL,KSTART,KATOM,KTYPE,KNG,KLOC,KMIN,KMAX,
     *                     EX,CS,CP,CD,CF,CG,NORM

      IMPLICIT NONE
C
      DOUBLE PRECISION, INTENT(IN   ) :: PA(*)
      DOUBLE PRECISION, INTENT(INOUT) :: DER2(NQMT0A+1,3,NAT)
C
      LOGICAL IANDJ,DOUBLE
C
      DOUBLE PRECISION ::DIJ(225),WRKX(225,36),WRKY(225,36),WRKZ(255,36)
     *                  ,DTMPX(225,36),DTMPY(225,36),DTMPZ(225,36)
      INTEGER :: MAXADD(5),MINMIN(5)
C
      INTEGER, ALLOCATABLE :: NIJ(:,:)
      DOUBLE PRECISION,  ALLOCATABLE :: GTMP(:),DWRK(:,:,:)
C
      INTEGER :: II, JJ, KK, I, J, K, L, MINI, MAXI, MINJ, MAXJ, MINK, 
     *           MAXK, MINL, MAXL, MINKM, MAXKP, LIT, LJT, LKT, 
     *           I1, I2, J1, J2, K1, K2, L1, L2, IG, JG, KG, LG, 
     *           LOCI, LOCJ, LCI, LCJ, IJ, KL, JMAX, JGMAX, KAT, 
     *           ISTRT, IEND, L12, NN, MM, NSHTT

      DOUBLE PRECISION :: XI,YI,ZI, XJ,YJ,ZJ, XK,YK,ZK, XL,YL,ZL, 
     *                    ZETA, ETA, VALX2, VALY2, VALZ2, SAB, VAL, 
     *                    PX,PY,PZ, RR, CSK,CSJ,CPJ,CDJ,CFJ,CGJ, 
     *                    CSI,CPI,CDI,CFI,CGI, DUM, DKL, AXI,AYI,AZI, 
     *                    AI,AJ,AK, AA1, ARRI, DUM1,DUM2
C
      DATA MINMIN/0,1, 3, 6,10/
      DATA MAXADD/3,6,10,15,21/
C
      DOUBLE PRECISION,PARAMETER :: SQRT3=1.73205080756888D+00,
     *                              SQRT5=2.23606797749979D+00, 
     *                              SQRT7=2.64575131106459D+00
C
      ALLOCATE(NIJ(NUM,NUM))
      ALLOCATE(GTMP(1323*NSHEL0A),DWRK(NSHEL0A,3,NAT))
C
      CALL RSM_ISTIEND(NSHEL0A,ISTRT,IEND,NSHTT)
      L12 = NSHEL0A*3*NAT
      CALL VCLR(DWRK ,1,L12)
C
      IJ = 0
      DO I=1,NUM
        DO J=1,I
          IJ = IJ + 1
          NIJ(J,I) = IJ
          NIJ(I,J) = IJ
        ENDDO
      ENDDO
C
      DO II = 1,NSHELL
        I = KATOM(II)
        XI = C(1,I)
        YI = C(2,I)
        ZI = C(3,I)
        I1 = KSTART(II)
        I2 = I1+KNG(II)-1
        LIT = KTYPE(II)
        MINI = KMIN(II)
        MAXI = KMAX(II)
        LOCI = KLOC(II)-MINI
C
C     ----- J SHELL -----
C
        DO JJ = 1,II
          J = KATOM(JJ)
          XJ = C(1,J)
          YJ = C(2,J)
          ZJ = C(3,J)
          J1 = KSTART(JJ)
          J2 = J1+KNG(JJ)-1
          LJT = KTYPE(JJ)
          MINJ = KMIN(JJ)
          MAXJ = KMAX(JJ)
          LOCJ = KLOC(JJ)-MINJ

          RR = (XI-XJ)**2+(YI-YJ)**2+(ZI-ZJ)**2
          IANDJ = II .EQ. JJ
C
C         ----- K SHELL
C
          DO KK=ISTRT,IEND
            KAT  = KATM0A(KK)
            LKT  = KTYP0A(KK)
            XK   = C(1,KAT)
            YK   = C(2,KAT)
            ZK   = C(3,KAT)
            MINK = KMIN0A(KK)
            MAXK = KMAX0A(KK)
            MINKM= MAX(1,MINK - MINMIN(LKT))
            MAXKP= MAXK + MAXADD(LKT)

            XL   = XK
            YL   = YK
            ZL   = ZK
            MINL = MINK
            MAXL = MAXK

            K1   = KSTRT0A(KK)
            K2   = K1 + KNG0A(KK) - 1

            L1   = K1
            L2   = K2
C
C     ----- I PRIMITIVE
C
            WRKX = 0.0D+00
            WRKY = 0.0D+00
            WRKZ = 0.0D+00
            JGMAX = J2
            DO IG = I1,I2
              AI   = EX(IG)
              ARRI = AI*RR
              AXI  = AI*XI
              AYI  = AI*YI
              AZI  = AI*ZI
              CSI  = CS(IG)
              CPI  = CP(IG)
              CDI  = CD(IG)
              CFI  = CF(IG)
              CGI  = CG(IG)
C
C     ----- J PRIMITIVE
C
              IF (IANDJ) JGMAX = IG
              DO JG = J1,JGMAX
                AJ  = EX(JG)
                ZETA= AI+AJ
                AA1 = 1.0D+00/ZETA
                DUM = AJ*ARRI*AA1
*                 IF (DUM .GT. TOL) GO TO 500
                SAB = EXP(-DUM)
                CSJ = CS(JG)
                CPJ = CP(JG)
                CDJ = CD(JG)
                CFJ = CF(JG)
                CGJ = CG(JG)
                PX = (AXI+AJ*XJ)*AA1
                PY = (AYI+AJ*YJ)*AA1
                PZ = (AZI+AJ*ZJ)*AA1
C
C     ----- DENSITY FACTOR
C
                DOUBLE=IANDJ.AND.IG.NE.JG
                JMAX = MAXJ
                IJ = 0
                DUM1 = 0.0D+00
                DUM2 = 0.0D+00
                DO I = MINI,MAXI
                  IF (I.EQ.1) DUM1=CSI
                  IF (I.EQ.2) DUM1=CPI
                  IF (I.EQ.5) DUM1=CDI
                  IF ((I.EQ. 8).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.11) DUM1=CFI
                  IF ((I.EQ.14).AND.NORM) DUM1=DUM1*SQRT5
                  IF ((I.EQ.20).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.21) DUM1=CGI
                  IF ((I.EQ.24).AND.NORM) DUM1=DUM1*SQRT7
                  IF ((I.EQ.30).AND.NORM) DUM1=DUM1*SQRT5/SQRT3
                  IF ((I.EQ.33).AND.NORM) DUM1=DUM1*SQRT3
                  IF (IANDJ) JMAX = I
                  DO J = MINJ,JMAX
                    IF (J.EQ.1) THEN
                      DUM2=DUM1*CSJ
                      IF (DOUBLE) THEN
                        IF (I.LE.1) THEN
                          DUM2=DUM2+DUM2
                        ELSE
                          DUM2=DUM2+CSI*CPJ
                        END IF
                      END IF
                    ELSE IF (J.EQ.2) THEN
                      DUM2=DUM1*CPJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF (J.EQ.5) THEN
                      DUM2=DUM1*CDJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF ((J.EQ.8).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.11) THEN
                      DUM2=DUM1*CFJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF ((J.EQ.14).AND.NORM) THEN
                      DUM2=DUM2*SQRT5
                    ELSE IF ((J.EQ.20).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.21) THEN
                      DUM2=DUM1*CGJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF ((J.EQ.24).AND.NORM) THEN
                      DUM2=DUM2*SQRT7
                    ELSE IF ((J.EQ.30).AND.NORM) THEN
                      DUM2=DUM2*SQRT5/SQRT3
                    ELSE IF ((J.EQ.33).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    END IF
                    IJ = IJ+1
                    DIJ(IJ) = DUM2
                  ENDDO
                ENDDO

                KL = 0
                DO K=MINK,MAXK
                  DO L=MINL,MAXL
                    KL = KL + 1
                  ENDDO
                ENDDO

                DO KG=K1,K2
                  AK = EX0A(KG)
                  DO LG=L1,L2
                    ETA = AK + EX0A(LG)
                    CSK = COF0A(KG) * COF0A(LG)

                    DKL = CSK

                    GTMP = 0.0D+00

                    CALL RSM_OSINT1(IANDJ,MINI,MAXI,MINJ,MAXJ,MINKM,
     *                          MAXKP,
     *                          MINL,MAXL,ZETA,ETA,PX,PY,PZ,XK,YK,ZK,XI,
     *                          YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,SAB,
     *                          1.0D+00,GTMP)
 
                    CALL RSM_OSDER1B(IANDJ,AK,MINI,MAXI,MINJ,MAXJ,MINK,
     *                               MAXK,MINKM,MAXKP,MINL,MAXL,GTMP,
     *                               DTMPX,DTMPY,DTMPZ)

                    DO K=1,KL
                      DO I=1,IJ
                        WRKX(I,K) = WRKX(I,K) + DIJ(I)*DTMPX(I,K)*DKL
                        WRKY(I,K) = WRKY(I,K) + DIJ(I)*DTMPY(I,K)*DKL
                        WRKZ(I,K) = WRKZ(I,K) + DIJ(I)*DTMPZ(I,K)*DKL
                      ENDDO
                    ENDDO
C
C                   ----- END OF PRIMITIVES
C
                  ENDDO
                ENDDO
              ENDDO
            ENDDO

            KL = 0
            VALX2 = 0.0D+00
            VALY2 = 0.0D+00
            VALZ2 = 0.0D+00
            DO K=MINK,MAXK
              DO L=MINL,MAXL
                KL = KL + 1

                JMAX= MAXJ
                NN = 0
                DO I=MINI,MAXI
                  IF(IANDJ) JMAX = I
                  LCI = LOCI + I
                  DO J=MINJ,JMAX
                    LCJ = LOCJ + J

                    MM = NIJ(LCJ,LCI) 
                    NN = NN + 1

                    DUM = PA(MM)*TRN3(L,K)
                    IF(LCI.NE.LCJ) DUM=DUM+DUM

                    VALX2 = VALX2 + DUM*WRKX(NN,KL)
                    VALY2 = VALY2 + DUM*WRKY(NN,KL)
                    VALZ2 = VALZ2 + DUM*WRKZ(NN,KL)
                  ENDDO
                ENDDO
              ENDDO
            ENDDO

            DWRK(KK,1,KAT)=DWRK(KK,1,KAT)+ VALX2 + VALX2
            DWRK(KK,2,KAT)=DWRK(KK,2,KAT)+ VALY2 + VALY2
            DWRK(KK,3,KAT)=DWRK(KK,3,KAT)+ VALZ2 + VALZ2

          ENDDO
        ENDDO
      ENDDO

      IF(GOPARR) CALL RSM_GSUMF(10001,DWRK,L12)

      DO I=1,NAT
        DO J=1,3
          DO K=1,NQMT0A
            VAL = 0.0D+00
            DO L=1,NSHEL0A
              VAL = VAL + TQ(L,K)*DWRK(L,J,I)
            ENDDO
            DER2(K,J,I) = DER2(K,J,I) + VAL
          ENDDO
        ENDDO
      ENDDO
C
      DEALLOCATE(NIJ)
      DEALLOCATE(GTMP,DWRK)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKDYMT3
C>
C>    @brief   compute dY/dB
C>             (see eq 34 in JCP, 152, 194102 (2020))
C>
C>    @author  Kosuke Imamura
C>
      SUBROUTINE RSM_MKDYMT3
C
      USE RISM_MOD, ONLY : RSM_ISTIEND, GOPARR, NSHEL0A, MASWRK
      USE RSMSED,   ONLY : NUM, C, NAT
      USE RSM_BSMOD,ONLY : NSHELL,KSTART,KATOM,KTYPE,KNG,KLOC,KMIN,KMAX,
     *                     EX,CS,CP,CD,CF,CG,NORM
      USE ABSMOD,   ONLY : KATM0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, EX0A,
     *                     COF0A, TRN3, NQMT0A, TQ
C
      IMPLICIT NONE
C
      INTEGER               :: MAXADD(5), MINMIN(5)
      DOUBLE PRECISION      :: DIJ(225),
     *                         WRKX(225,36),WRKY(225,36),WRKZ(225,36),
     *                         DTMPX(225,36),DTMPY(225,36),DTMPZ(225,36)
C
      DOUBLE PRECISION, ALLOCATABLE  :: GTMP(:),DWRK(:,:,:),DER2(:,:,:)
      INTEGER, ALLOCATABLE           :: NIJ(:,:)
C
      DOUBLE PRECISION, PARAMETER    :: SQRT3=1.73205080756888D+00,
     *                                  SQRT5=2.23606797749979D+00, 
     *                                  SQRT7=2.64575131106459D+00,
     *                                  RLN10=2.30258D+00,
     *                                  PT5=0.5D+00
C
      DATA MINMIN/0,1, 3, 6,10/
      DATA MAXADD/3,6,10,15,21/
C
      INTEGER               :: I, J, IJ, K, L, KL, ISTRT, IEND, NSHTT,
     *                         II, IAT, I1, I2, MINI, MAXI, LOCI, IG,
     *                         JJ, JAT, J1, J2, MINJ, MAXJ, LOCJ, JG,
     *                         KK, K1, K2, MINK, MAXK, KG,
     *                         L1, L2, MINL, MAXL, LG, LCI, LIN, LCJ,
     *                         LJT, MINJM, MAXJP, IJPM, NN, MM,
     *                         L2S, L12, L13
      DOUBLE PRECISION      :: XI, YI, ZI, XJ, YJ, ZJ, XK, YK, ZK,
     *                         XL, YL, ZL, PX, PY, PZ, XIJ, YIJ, ZIJ,
     *                         CSI, CPI, CDI, CFI, CGI, AI,
     *                         CSJ, CPJ, CDJ, CFJ, CGJ, AJ,
     *                         VAL, ZETA, ZETA1, AXI, AYI, AZI, ETA,
     *                         CSK, RR, ARRI, DKL, TRNFC,
     *                         DUM, DUM1, DUM2, SAB, 
     *                         VALX2, VALY2, VALZ2, TP1, TP2, TP3
C
      ALLOCATE(NIJ(NUM,NUM))
      ALLOCATE(GTMP(310*NSHEL0A),DWRK(NSHEL0A,3,NUM*(NUM-1)/2))
      ALLOCATE(DER2(NQMT0A,3,NUM*(NUM-1)/2))
C
      CALL RSM_ISTIEND(NSHEL0A,ISTRT,IEND,NSHTT)
      L2S = NUM*(NUM-1)/2
      L12 = NSHEL0A*3*L2S
      L13 = NQMT0A*3*L2S

      CALL VCLR(DWRK ,1,L12)
      CALL VCLR(DER2 ,1,L13)
C
!      TOL = RLN10*ITOL
C
C
      IJ = 0
      DO I=1,NUM
        DO J=1,I
          IJ = IJ + 1
          NIJ(J,I) = IJ
          NIJ(I,J) = IJ
        ENDDO
      ENDDO
C
C     ---- I SHELL -----
C
      DO II = 1,NSHELL
        IAT  = KATOM(II)
        XI   = C(1,IAT)
        YI   = C(2,IAT)
        ZI   = C(3,IAT)
        I1   = KSTART(II)
        I2   = I1+KNG(II)-1
        MINI = KMIN(II)
        MAXI = KMAX(II)
        LOCI = KLOC(II)-MINI
C
C     ----- J SHELL -----
C
        DO JJ = 1,NSHELL
          JAT  = KATOM(JJ)
          LJT  = KTYPE(JJ)
          XJ   = C(1,JAT)
          YJ   = C(2,JAT)
          ZJ   = C(3,JAT)
          J1   = KSTART(JJ)
          J2   = J1+KNG(JJ)-1
          MINJ = KMIN(JJ)
          MAXJ = KMAX(JJ)
          MINJM= MAX(1,MINJ - MINMIN(LJT))
          MAXJP= MAXJ + MAXADD(LJT)
          LOCJ = KLOC(JJ)-MINJ

          RR = (XI-XJ)**2+(YI-YJ)**2+(ZI-ZJ)**2

          IJPM = 0
          DO I=MINI,MAXI
            DO J=MINJM,MAXJP
              IJPM = IJPM + 1
            ENDDO
          ENDDO

C
C         ----- K SHELL
C
          DO KK=ISTRT,IEND
            K    = KATM0A(KK)
            XK   = C(1,K)
            YK   = C(2,K)
            ZK   = C(3,K)
            MINK = KMIN0A(KK)
            MAXK = KMAX0A(KK)

            XL   = XK
            YL   = YK
            ZL   = ZK
            MINL = MINK
            MAXL = MAXK

            K1   = KSTRT0A(KK)
            K2   = K1 + KNG0A(KK) - 1

            L1   = K1
            L2   = K2

C
C           ----- I PRIMITIVE
C
            WRKX = 0.0D+00
            WRKY = 0.0D+00
            WRKZ = 0.0D+00
            DO IG = I1,I2
              AI   = EX(IG)
              ARRI = AI*RR
              AXI  = AI*XI
              AYI  = AI*YI
              AZI  = AI*ZI
              CSI  = CS(IG)
              CPI  = CP(IG)
              CDI  = CD(IG)
              CFI  = CF(IG)
              CGI  = CG(IG)
C
C           ----- J PRIMITIVE
C
              DO JG = J1,J2
                AJ    = EX(JG)
                ZETA  = AI+AJ
                ZETA1 = 1.0D+00/ZETA
                DUM   = AJ*ARRI*ZETA1
*               IF (DUM .GT. TOL) GO TO 500
                SAB   = EXP(-DUM)
                CSJ   = CS(JG)
                CPJ   = CP(JG)
                CDJ   = CD(JG)
                CFJ   = CF(JG)
                CGJ   = CG(JG)
                PX    = (AXI+AJ*XJ)*ZETA1
                PY    = (AYI+AJ*YJ)*ZETA1
                PZ    = (AZI+AJ*ZJ)*ZETA1
C
C     ----- DENSITY FACTOR
C
                IJ = 0
                DUM1 = 0.0D+00
                DUM2 = 0.0D+00
                DO I = MINI,MAXI
                  IF (I.EQ.1) DUM1=CSI
                  IF (I.EQ.2) DUM1=CPI
                  IF (I.EQ.5) DUM1=CDI
                  IF ((I.EQ. 8).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.11) DUM1=CFI
                  IF ((I.EQ.14).AND.NORM) DUM1=DUM1*SQRT5
                  IF ((I.EQ.20).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.21) DUM1=CGI
                  IF ((I.EQ.24).AND.NORM) DUM1=DUM1*SQRT7
                  IF ((I.EQ.30).AND.NORM) DUM1=DUM1*SQRT5/SQRT3
                  IF ((I.EQ.33).AND.NORM) DUM1=DUM1*SQRT3
                  DO J = MINJ,MAXJ
                    IF (J.EQ.1) THEN
                      DUM2=DUM1*CSJ
                    ELSE IF (J.EQ.2) THEN
                      DUM2=DUM1*CPJ
                    ELSE IF (J.EQ.5) THEN
                      DUM2=DUM1*CDJ
                    ELSE IF ((J.EQ.8).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.11) THEN
                      DUM2=DUM1*CFJ
                    ELSE IF ((J.EQ.14).AND.NORM) THEN
                      DUM2=DUM2*SQRT5
                    ELSE IF ((J.EQ.20).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.21) THEN
                      DUM2=DUM1*CGJ
                    ELSE IF ((J.EQ.24).AND.NORM) THEN
                      DUM2=DUM2*SQRT7
                    ELSE IF ((J.EQ.30).AND.NORM) THEN
                      DUM2=DUM2*SQRT5/SQRT3
                    ELSE IF ((J.EQ.33).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    END IF
                    IJ = IJ + 1
                    DIJ(IJ) = DUM2
                  ENDDO
                ENDDO

                KL = 0
                DO K=MINK,MAXK
                  DO L=MINL,MAXL
                    KL = KL + 1
                  ENDDO
                ENDDO

                DO KG=K1,K2
                  DO LG=L1,L2
                    ETA = EX0A(KG) + EX0A(LG)
                    CSK = COF0A(KG) * COF0A(LG)

                    DKL = CSK

                    GTMP = 0.0D+00

                    CALL RSM_OSINT1(.FALSE.,MINI,MAXI,MINJM,MAXJP,MINK,
     *                          MAXK,
     *                          MINL,MAXL,ZETA,ETA,PX,PY,PZ,XK,YK,ZK,XI,
     *                          YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,SAB,
     *                          1.0D+00,GTMP)


                    CALL RSM_OSDER3(MINI,MAXI,MINJ,MAXJ,MINJM,MAXJP,
     *                          MINK,MAXK,MINL,MAXL,XJ,YJ,ZJ,KL,
     *                          GTMP,DTMPX,DTMPY,DTMPZ)

                    DO K=1,KL
                      DO I=1,IJ
                        WRKX(I,K) = WRKX(I,K) + DIJ(I)*DTMPX(I,K)*DKL
                        WRKY(I,K) = WRKY(I,K) + DIJ(I)*DTMPY(I,K)*DKL
                        WRKZ(I,K) = WRKZ(I,K) + DIJ(I)*DTMPZ(I,K)*DKL
                      ENDDO
                    ENDDO
C
C                   ----- END OF PRIMITIVES
C
                  ENDDO
                ENDDO
              ENDDO
            ENDDO

            IF (II>=JJ) THEN
            KL = 0
            VALX2 = 0.0D+00
            VALY2 = 0.0D+00
            VALZ2 = 0.0D+00
            DO K=MINK,MAXK
              DO L=MINL,MAXL
                KL = KL + 1

                TRNFC = TRN3(L,K)
                NN = 0
                DO I=MINI,MAXI
                  LCI = LOCI + I-1
                  LIN = (LCI*(LCI-1))/2
                  DO J=MINJ,MAXJ
                    LCJ = LIN + LOCJ + J
                    NN = NN + 1

                    DUM = TRNFC
                    IF ((I>J.AND.LOCI.EQ.LOCJ).OR.LOCI>LOCJ) THEN
                      DWRK(KK,1,LCJ)=DWRK(KK,1,LCJ)+ DUM*WRKX(NN,KL)
                      DWRK(KK,2,LCJ)=DWRK(KK,2,LCJ)+ DUM*WRKY(NN,KL)
                      DWRK(KK,3,LCJ)=DWRK(KK,3,LCJ)+ DUM*WRKZ(NN,KL)
                    ENDIF

                  ENDDO
                ENDDO
              ENDDO
            ENDDO
            ENDIF
            IF (II>=JJ) THEN
              XIJ = XI - XJ
              YIJ = YI - YJ
              ZIJ = ZI - ZJ
              DO I=MINI,MAXI
                LCI = LOCI + I-1
                LIN = (LCI*(LCI-1))/2
                DO J = MINJ,MAXJ
                  LCJ = LIN + LOCJ + J
                  IF ((I>J.AND.LOCI.EQ.LOCJ).OR.LOCI>LOCJ) THEN
                    TP1 = PT5*(YIJ*DWRK(KK,3,LCJ)-ZIJ*DWRK(KK,2,LCJ))
                    TP2 = PT5*(ZIJ*DWRK(KK,1,LCJ)-XIJ*DWRK(KK,3,LCJ))
                    TP3 = PT5*(XIJ*DWRK(KK,2,LCJ)-YIJ*DWRK(KK,1,LCJ))
                    DWRK(KK,1,LCJ)=TP1
                    DWRK(KK,2,LCJ)=TP2
                    DWRK(KK,3,LCJ)=TP3
                  ENDIF
                ENDDO
              ENDDO
            ENDIF

          ENDDO
        ENDDO
      ENDDO

      IF(GOPARR) CALL RSM_GSUMF(10000,DWRK,L12)

      DO I=1,L2S
        DO J=1,3
          DO K=1,NQMT0A
            VAL = 0.0D+00
            DO L=1,NSHEL0A
              VAL = VAL + TQ(L,K)*DWRK(L,J,I)
            ENDDO
            DER2(K,J,I) = VAL
          ENDDO
        ENDDO
      ENDDO

      CALL RSM_DAWR(DER2,L13,61,0)
C
      DEALLOCATE(NIJ)
      DEALLOCATE(GTMP,DWRK)
      DEALLOCATE(DER2)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_OSDER1A
C>
C>    @brief   compute derivatives with Obara-Saika in RSM_MKDYMT1
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   AJ: the exponent of J shell
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             MINJM: starting counters of the shell, which
C>                    angular momentum is J-1
C>             MAXJP: ending counter of the shell, which
C>                    angular momentum is J+1
C>             KL: total number of K-L pairs of ABSs
C>             GTMP: data computed in RSM_OSINT1
C>             DTMPX: derivatives with respect X coordinate
C>             DTMPY: derivatives with respect Y coordinate
C>             DTMPZ: derivatives with respect Z coordinate
C>
      SUBROUTINE RSM_OSDER1A(AJ,MINI,MAXI,MINJ,MAXJ,MINJM,MAXJP,MINK,
     *                       MAXK,MINL,MAXL,KL,GTMP,DTMPX,DTMPY,DTMPZ)
      IMPLICIT NONE
C
      INTEGER,          INTENT(IN   ) :: MINI,MAXI,MINJ,MAXJ,MINJM,MAXJP
     *                                  ,MINK,MAXK,MINL,MAXL,KL
      DOUBLE PRECISION, INTENT(IN   ) :: AJ, GTMP(196000)
      DOUBLE PRECISION, INTENT(  OUT) :: DTMPX(225,*),DTMPY(225,*),
     *                                   DTMPZ(225,*)
C
      DOUBLE PRECISION                :: WRK(84,36)
C
      INTEGER                :: JP(3,56), JM(3,56)
      DOUBLE PRECISION       :: RIN(3,56)

      DATA JP/ 2, 3, 4,
     *         5, 8, 9,
     *         8, 6,10,
     *         9,10, 7,
     *        11,14,15,
     *        16,12,17,
     *        18,19,13,
     *        14,16,20,
     *        15,20,18,
     *        20,17,19,
     *        21,24,25,
     *        26,22,27,
     *        28,29,23,
     *        24,30,33,
     *        25,33,31,
     *        30,26,34,
     *        34,27,32,
     *        31,35,28,
     *        35,32,29,
     *        33,34,35,
     *        36,39,40,
     *        41,37,42,
     *        43,44,38,
     *        39,45,51,
     *        40,51,46,
     *        47,41,52,
     *        52,42,48,
     *        49,53,43,
     *        53,50,44,
     *        45,47,54,
     *        46,55,49,
     *        56,48,50,
     *        51,54,55,
     *        54,52,56,
     *        55,56,53,
     *        57,60,61,
     *        62,58,63,
     *        64,65,59,
     *        60,66,72,
     *        61,72,67,
     *        68,62,73,
     *        73,63,69,
     *        70,74,64,
     *        74,71,65,
     *        66,75,78,
     *        67,79,76,
     *        75,68,80,
     *        81,69,77,
     *        76,82,70,
     *        83,77,71,
     *        72,78,79,
     *        80,73,81,
     *        82,83,74,
     *        78,80,84,
     *        79,84,82,
     *        84,81,83/ 
      DATA JM/ 1, 1, 1,
     *         1, 1, 1,
     *         1, 1, 1,
     *         1, 1, 1,
     *         2, 1, 1,
     *         1, 3, 1,
     *         1, 1, 4,
     *         3, 2, 1,
     *         4, 1, 2,
     *         1, 4, 3,
     *         5, 1, 1,
     *         1, 6, 1,
     *         1, 1, 7,
     *         8, 5, 1,
     *         9, 1, 5,
     *         6, 8, 1,
     *         1,10, 6,
     *         7, 1, 9,
     *         1, 7,10,
     *        10, 9, 8,
     *        11, 1, 1,
     *         1,12, 1,
     *         1, 1,13,
     *        14,11, 1,
     *        15, 1,11,
     *        12,16, 1,
     *         1,17,12,
     *        13, 1,18,
     *         1,13,19,
     *        16,14, 1,
     *        18, 1,15,
     *         1,19,17,
     *        20,15,14,
     *        17,20,16,
     *        19,18,20,
     *        21, 1, 1,
     *         1,22, 1,
     *         1, 1,23,
     *        24,21, 1,
     *        25, 1,21,
     *        22,26, 1,
     *         1,27,22,
     *        23, 1,28,
     *         1,23,29,
     *        30,24, 1,
     *        31, 1,25,
     *        26,30, 1,
     *         1,32,27,
     *        28, 1,31,
     *         1,29,32,
     *        33,25,24,
     *        27,34,26,
     *        29,28,35,
     *        34,33,30,
     *        35,31,33,
     *        32,35,34/
      DATA RIN/0.0D+00,0.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,1.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,1.0D+00,
     *         2.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,1.0D+00,
     *         0.0D+00,1.0D+00,1.0D+00,
     *         3.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,3.0D+00,
     *         2.0D+00,1.0D+00,0.0D+00,
     *         2.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,2.0D+00,
     *         0.0D+00,1.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,1.0D+00,
     *         4.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,4.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,4.0D+00,
     *         3.0D+00,1.0D+00,0.0D+00,
     *         3.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,3.0D+00,
     *         0.0D+00,1.0D+00,3.0D+00,
     *         2.0D+00,2.0D+00,0.0D+00,
     *         2.0D+00,0.0D+00,2.0D+00,
     *         0.0D+00,2.0D+00,2.0D+00,
     *         2.0D+00,1.0D+00,1.0D+00,
     *         1.0D+00,2.0D+00,1.0D+00,
     *         1.0D+00,1.0D+00,2.0D+00,
     *         5.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,5.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,5.0D+00,
     *         4.0D+00,1.0D+00,0.0D+00,
     *         4.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,4.0D+00,0.0D+00,
     *         0.0D+00,4.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,4.0D+00,
     *         0.0D+00,1.0D+00,4.0D+00,
     *         3.0D+00,2.0D+00,0.0D+00,
     *         3.0D+00,0.0D+00,2.0D+00,
     *         2.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,2.0D+00,
     *         2.0D+00,0.0D+00,3.0D+00,
     *         0.0D+00,2.0D+00,3.0D+00,
     *         3.0D+00,1.0D+00,1.0D+00,
     *         1.0D+00,3.0D+00,1.0D+00,
     *         1.0D+00,1.0D+00,3.0D+00,
     *         2.0D+00,2.0D+00,1.0D+00,
     *         2.0D+00,1.0D+00,2.0D+00,
     *         1.0D+00,2.0D+00,2.0D+00/
C
      INTEGER :: I, J, K, L, IJ, NN, MM, JPX, JPY, JPZ, JMX, JMY, JMZ
      DOUBLE PRECISION :: TAJ, RX, RY, RZ
C
      TAJ = AJ+AJ
      NN = 0
      IJ = 0
      DO I=MINI,MAXI
        DO J=MINJM,MAXJP
          MM = 0
          DO K=MINK,MAXK
            DO L=MINL,MAXL
              NN = NN + 1
              MM = MM + 1

              WRK(J,MM) = GTMP(NN)
            ENDDO
          ENDDO
        ENDDO

        DO J=MINJ,MAXJ
          IJ = IJ + 1

          JPX = JP(1,J)
          JPY = JP(2,J)
          JPZ = JP(3,J)

          JMX = JM(1,J)
          JMY = JM(2,J)
          JMZ = JM(3,J)

          RX  = RIN(1,J)
          RY  = RIN(2,J)
          RZ  = RIN(3,J)
          DO K=1,KL
            DTMPX(IJ,K) = TAJ*WRK(JPX,K) - RX*WRK(JMX,K)
            DTMPY(IJ,K) = TAJ*WRK(JPY,K) - RY*WRK(JMY,K)
            DTMPZ(IJ,K) = TAJ*WRK(JPZ,K) - RZ*WRK(JMZ,K)
          ENDDO
        ENDDO
      ENDDO
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_OSDER1B
C>
C>    @brief   compute derivatives with Obara-Saika in RSM_MKDYMT2
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   IANDJ: the shell II is equal to the shell JJ, or not
C>             AK: the exponent of K shell
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             MINKM: starting counters of the shell, which
C>                    angular momentum is K-1
C>             MAXKP: ending counter of the shell, which
C>                    angular momentum is K+1
C>             GTMP: data computed in RSM_OSINT1
C>             DTMPX: derivatives with respect X coordinate
C>             DTMPY: derivatives with respect Y coordinate
C>             DTMPZ: derivatives with respect Z coordinate
C>

      SUBROUTINE RSM_OSDER1B(IANDJ,AK,MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                     MINKM,MAXKP,MINL,MAXL,GTMP,DTMPX,DTMPY,DTMPZ)
      IMPLICIT NONE
C
      LOGICAL,          INTENT(IN   ) :: IANDJ
      INTEGER,          INTENT(IN   ) :: MINI,MAXI,MINJ,MAXJ,MINK,MAXK, 
     *                                   MINKM,MAXKP,MINL,MAXL
      DOUBLE PRECISION, INTENT(IN   ) :: AK, GTMP(196000)
      DOUBLE PRECISION, INTENT(  OUT) :: DTMPX(225,*),DTMPY(225,*),
     *                                   DTMPZ(225,*)
C
      DOUBLE PRECISION                 :: WRK(20,10)
C
      INTEGER                :: KP(3,10), KM(3,10)
      DOUBLE PRECISION       :: RIN(3,10)

      DATA KP/ 2, 3, 4, ! S
     *         5, 8, 9, ! P
     *         8, 6,10,
     *         9,10, 7,
     *        11,14,15, ! D
     *        16,12,17,
     *        18,19,13,
     *        14,16,20,
     *        15,20,18,
     *        20,17,19/
      DATA KM/ 1, 1, 1, ! S
     *         1, 1, 1, ! P
     *         1, 1, 1,
     *         1, 1, 1,
     *         2, 1, 1, ! D
     *         1, 3, 1,
     *         1, 1, 4,
     *         3, 2, 1,
     *         4, 1, 2,
     *         1, 4, 3/
      DATA RIN/0.0D+00,0.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,1.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,1.0D+00,
     *         2.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,1.0D+00,
     *         0.0D+00,1.0D+00,1.0D+00/
C
      INTEGER :: I, J, IJ, K, L, KL, NN, KPX, KPY, KPZ, KMX, KMY, KMZ,
     *           JMAX
      DOUBLE PRECISION :: TAK, RX, RY, RZ
C
      TAK = AK+AK
      NN = 0
      IJ = 0
      JMAX = MAXJ
      DO I=MINI,MAXI
        IF(IANDJ) JMAX = I
        DO J=MINJ,JMAX
          IJ = IJ + 1
          DO K=MINKM,MAXKP
            DO L=MINL,MAXL
              NN = NN + 1

              WRK(K,L) = GTMP(NN)
            ENDDO
          ENDDO

          KL = 0
          DO K=MINK,MAXK
            KPX = KP(1,K)
            KPY = KP(2,K)
            KPZ = KP(3,K)
 
            KMX = KM(1,K)
            KMY = KM(2,K)
            KMZ = KM(3,K)
 
            RX  = RIN(1,K)
            RY  = RIN(2,K)
            RZ  = RIN(3,K)
 
            DO L=MINL,MAXL
              KL = KL + 1

              DTMPX(IJ,KL) = TAK*WRK(KPX,L) - RX*WRK(KMX,L)
              DTMPY(IJ,KL) = TAK*WRK(KPY,L) - RY*WRK(KMY,L)
              DTMPZ(IJ,KL) = TAK*WRK(KPZ,L) - RZ*WRK(KMZ,L)
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_OSDER3
C>
C>    @brief   compute derivatives with Obara-Saika in RSM_MKDYMT3
C>
C>    @author  Kosuke Imamura
C>
C>    @param   MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counters of shells
C>             MINJM: starting counter of the shell, which 
C>                    angular momentum is J-1
C>             MAXJP: ending counter of the shell, which
C>                    angular momentum is J+1
C>             XJ, YJ, ZJ: the position of the Gaussian J
C>             KL: total number of K-L pairs of ABSs
C>             GTMP: data computed in RSM_OSINT1
C>             DTMPX: derivatives with respect to X coordinate
C>             DTMPY: derivatives with respect to Y coordinate
C>             DTMPZ: derivatives with respect to Z coordinate
C>
      SUBROUTINE RSM_OSDER3(MINI,MAXI,MINJ,MAXJ,MINJM,MAXJP,MINK,MAXK,
     *                   MINL,MAXL,XJ,YJ,ZJ,KL,GTMP,DTMPX,DTMPY,DTMPZ)
      IMPLICIT NONE
C
      INTEGER,          INTENT(IN   ) :: MINI,MAXI,MINJ,MAXJ,MINJM,MAXJP 
     *                                  ,MINK,MAXK,MINL,MAXL,KL
      DOUBLE PRECISION, INTENT(IN   ) :: XJ, YJ, ZJ, GTMP(196000)
      DOUBLE PRECISION, INTENT(  OUT) :: DTMPX(225,*), DTMPY(225,*), 
     *                                   DTMPZ(225,*)
C
      DOUBLE PRECISION                :: WRK(84,36)
C
      INTEGER                         :: JP(3,56)
      DOUBLE PRECISION                :: RIN(3,56)

      DATA JP/ 2, 3, 4,
     *         5, 8, 9,
     *         8, 6,10,
     *         9,10, 7,
     *        11,14,15,
     *        16,12,17,
     *        18,19,13,
     *        14,16,20,
     *        15,20,18,
     *        20,17,19,
     *        21,24,25,
     *        26,22,27,
     *        28,29,23,
     *        24,30,33,
     *        25,33,31,
     *        30,26,34,
     *        34,27,32,
     *        31,35,28,
     *        35,32,29,
     *        33,34,35,
     *        36,39,40,
     *        41,37,42,
     *        43,44,38,
     *        39,45,51,
     *        40,51,46,
     *        47,41,52,
     *        52,42,48,
     *        49,53,43,
     *        53,50,44,
     *        45,47,54,
     *        46,55,49,
     *        56,48,50,
     *        51,54,55,
     *        54,52,56,
     *        55,56,53,
     *        57,60,61,
     *        62,58,63,
     *        64,65,59,
     *        60,66,72,
     *        61,72,67,
     *        68,62,73,
     *        73,63,69,
     *        70,74,64,
     *        74,71,65,
     *        66,75,78,
     *        67,79,76,
     *        75,68,80,
     *        81,69,77,
     *        76,82,70,
     *        83,77,71,
     *        72,78,79,
     *        80,73,81,
     *        82,83,74,
     *        78,80,84,
     *        79,84,82,
     *        84,81,83/ 
      DATA RIN/0.0D+00,0.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,1.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,1.0D+00,
     *         2.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,1.0D+00,
     *         0.0D+00,1.0D+00,1.0D+00,
     *         3.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,3.0D+00,
     *         2.0D+00,1.0D+00,0.0D+00,
     *         2.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,2.0D+00,
     *         0.0D+00,1.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,1.0D+00,
     *         4.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,4.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,4.0D+00,
     *         3.0D+00,1.0D+00,0.0D+00,
     *         3.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,3.0D+00,
     *         0.0D+00,1.0D+00,3.0D+00,
     *         2.0D+00,2.0D+00,0.0D+00,
     *         2.0D+00,0.0D+00,2.0D+00,
     *         0.0D+00,2.0D+00,2.0D+00,
     *         2.0D+00,1.0D+00,1.0D+00,
     *         1.0D+00,2.0D+00,1.0D+00,
     *         1.0D+00,1.0D+00,2.0D+00,
     *         5.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,5.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,5.0D+00,
     *         4.0D+00,1.0D+00,0.0D+00,
     *         4.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,4.0D+00,0.0D+00,
     *         0.0D+00,4.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,4.0D+00,
     *         0.0D+00,1.0D+00,4.0D+00,
     *         3.0D+00,2.0D+00,0.0D+00,
     *         3.0D+00,0.0D+00,2.0D+00,
     *         2.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,2.0D+00,
     *         2.0D+00,0.0D+00,3.0D+00,
     *         0.0D+00,2.0D+00,3.0D+00,
     *         3.0D+00,1.0D+00,1.0D+00,
     *         1.0D+00,3.0D+00,1.0D+00,
     *         1.0D+00,1.0D+00,3.0D+00,
     *         2.0D+00,2.0D+00,1.0D+00,
     *         2.0D+00,1.0D+00,2.0D+00,
     *         1.0D+00,2.0D+00,2.0D+00/
C
      INTEGER :: I, J, IJ, K, L, MM, NN, JPX, JPY, JPZ
C
      NN = 0
      IJ = 0
      DO I=MINI,MAXI
        DO J=MINJM,MAXJP
          MM = 0
          DO K=MINK,MAXK
            DO L=MINL,MAXL
              NN = NN + 1
              MM = MM + 1

              WRK(J,MM) = GTMP(NN)
            ENDDO
          ENDDO
        ENDDO

        DO J=MINJ,MAXJ
          IJ = IJ + 1

          JPX = JP(1,J)
          JPY = JP(2,J)
          JPZ = JP(3,J)

          DO K=1,KL
            DTMPX(IJ,K) = WRK(JPX,K) + XJ*WRK(J,K)
            DTMPY(IJ,K) = WRK(JPY,K) + YJ*WRK(J,K)
            DTMPZ(IJ,K) = WRK(JPZ,K) + ZJ*WRK(J,K)
          ENDDO
        ENDDO
      ENDDO
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKDSMT
C>
C>    @brief   compute the derivative of overlap matrix
C>             (please see J. Chem. Phys., 131, 214504 (2009).)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   PA: density matrix
C>             DER2: the derivative of Y matrix
C>
      SUBROUTINE RSM_MKDSMT(PA,DER2)
C
      USE ABSMOD,   ONLY : NQMT0A
      USE RSM_BSMOD,ONLY : NSHELL,KSTART,KATOM,KTYPE,KNG,KLOC,KMIN,KMAX,
     *                     EX,CS,CP,CD,CF,CG,NORM
      USE RSMSED,   ONLY : C, NUM, NAT
C
      IMPLICIT NONE
C
      DOUBLE PRECISION, INTENT(IN   ) :: PA(*)
      DOUBLE PRECISION, INTENT(INOUT) :: DER2(NQMT0A+1,3,NAT)
C
C     PARAMETER (MXGTOT=20000, MXATM=2000, MXAO=8192)
C
      DOUBLE PRECISION      :: DIJ(225),
     *                         XS(6,5), YS(6,5), ZS(6,5),
     *                         DXS(5,5),DYS(5,5),DZS(5,5)
      INTEGER               :: IJX(35), IJY(35),IJZ(35)
C
      INTEGER               :: NI, NJ
      DOUBLE PRECISION      :: XINT,YINT,ZINT,T,X0,Y0,Z0,XI,YI,ZI,
     *                         XJ,YJ,ZJ,CX,CY,CZ
      COMMON /RSDSTV/ XINT,YINT,ZINT,T,X0,Y0,Z0,XI,YI,ZI,
     *                XJ,YJ,ZJ,NI,NJ,CX,CY,CZ
C
      INTEGER, ALLOCATABLE :: IA(:)
C
      DOUBLE PRECISION, PARAMETER     :: SQRT3=1.73205080756888D+00,
     *                                   SQRT5=2.23606797749979D+00,
     *                                   SQRT7=2.64575131106459D+00
C
      DATA IJX / 1, 2, 1, 1, 3, 1, 1, 2, 2, 1,
     *           4, 1, 1, 3, 3, 2, 1, 2, 1, 2,
     *           5, 1, 1, 4, 4, 2, 1, 2, 1, 3,
     *           3, 1, 3, 2, 2/
      DATA IJY / 1, 1, 2, 1, 1, 3, 1, 2, 1, 2,
     *           1, 4, 1, 2, 1, 3, 3, 1, 2, 2,
     *           1, 5, 1, 2, 1, 4, 4, 1, 2, 3,
     *           1, 3, 2, 3, 2/
      DATA IJZ / 1, 1, 1, 2, 1, 1, 3, 1, 2, 2,
     *           1, 1, 4, 1, 2, 1, 2, 3, 3, 2,
     *           1, 1, 5, 1, 2, 1, 2, 4, 4, 1,
     *           3, 3, 2, 2, 3/
C
      INTEGER               :: I, J, IJ, IG, JG, NSHLP, LITDER, NN,
     *                         II, IAT, I1, I2, LIT, MINI, MAXI, LOCI,
     *                         JJ, JAT, J1, J2, LJT, MINJ, MAXJ, LOCJ,
     *                         IX, IY, IZ, JX, JY, JZ
      DOUBLE PRECISION      :: CSI, CPI, CDI, CFI, CGI, AI, DUM1, 
     *                         CSJ, CPJ, CDJ, CFJ, CGJ, AJ, DUM2,
     *                         AXI, AYI, AZI, DUMX, DUMY, DUMZ, DUM,
     *                         AX, AY, AZ, AA, AA1, RR, ARRI, DEN, FAC
C
      ALLOCATE(IA(NUM))
C
      DO I = 1,NUM
        IA(I) = (I*I-I)/2
      ENDDO
C
C     ----- CALCULATE DERIVATIVES OF THE OVERLAP MATRIX -----
C     
      NSHLP = NQMT0A + 1
C
C     ----- I SHELL
C
      DO II = 1,NSHELL
        IAT = KATOM(II)
        XI = C(1,IAT)
        YI = C(2,IAT)
        ZI = C(3,IAT)
        I1 = KSTART(II)
        I2 = I1+KNG(II)-1
        LIT = KTYPE(II)
        MINI = KMIN(II)
        MAXI = KMAX(II)
        LOCI = KLOC(II)-MINI
        LITDER = LIT+1
C
C     ----- J SHELL
C
        DO JJ = 1,II
          JAT = KATOM(JJ)
          XJ = C(1,JAT)
          YJ = C(2,JAT)
          ZJ = C(3,JAT)
          J1 = KSTART(JJ)
          J2 = J1+KNG(JJ)-1
          LJT = KTYPE(JJ)
          MINJ = KMIN(JJ)
          MAXJ = KMAX(JJ)
          LOCJ = KLOC(JJ)-MINJ
          RR = (XI-XJ)**2+(YI-YJ)**2+(ZI-ZJ)**2
          IF(II.EQ.JJ) GO TO 760
C
C     ----- I PRIMITIVE
C
          DO IG = I1,I2
            AI = EX(IG)
            ARRI = AI*RR
            AXI = AI*XI
            AYI = AI*YI
            AZI = AI*ZI
            CSI=CS(IG)
            CPI=CP(IG)
            CDI=CD(IG)
            CFI=CF(IG)
            CGI=CG(IG)
C
C     ----- J PRIMITIVE
C
            DO JG = J1,J2
              AJ = EX(JG)
              AA = AI+AJ
              AA1 = 1.0D+00/AA
              DUM = AJ*ARRI*AA1
              FAC = EXP(-DUM)
              CSJ = CS(JG)
              CPJ = CP(JG)
              CDJ = CD(JG)
              CFJ = CF(JG)
              CGJ = CG(JG)
              AX = (AXI+AJ*XJ)*AA1
              AY = (AYI+AJ*YJ)*AA1
              AZ = (AZI+AJ*ZJ)*AA1
C
C     ----- DENSITY FACTOR
C
              IJ = 0
              DO I = MINI,MAXI
                IF(I.EQ.1) DUM1=CSI*FAC
                IF(I.EQ.2) DUM1=CPI*FAC
                IF(I.EQ.5) DUM1=CDI*FAC
                IF(I.EQ.8.AND.NORM) DUM1=DUM1*SQRT3
                IF(I.EQ.11) DUM1=CFI*FAC
                IF(I.EQ.14.AND.NORM) DUM1=DUM1*SQRT5
                IF(I.EQ.20.AND.NORM) DUM1=DUM1*SQRT3
                IF(I.EQ.21) DUM1=CGI*FAC
                IF(I.EQ.24.AND.NORM) DUM1=DUM1*SQRT7
                IF(I.EQ.30.AND.NORM) DUM1=DUM1*SQRT5/SQRT3
                IF(I.EQ.33.AND.NORM) DUM1=DUM1*SQRT3
                DO J = MINJ,MAXJ
                  IF(J.EQ.1) DUM2=DUM1*CSJ
                  IF(J.EQ.2) DUM2=DUM1*CPJ
                  IF(J.EQ.5) DUM2=DUM1*CDJ
                  IF(J.EQ.8.AND.NORM) DUM2=DUM2*SQRT3
                  IF(J.EQ.11) DUM2=DUM1*CFJ
                  IF(J.EQ.14.AND.NORM) DUM2=DUM2*SQRT5
                  IF(J.EQ.20.AND.NORM) DUM2=DUM2*SQRT3
                  IF(J.EQ.21) DUM2=DUM1*CGJ
                  IF(J.EQ.24.AND.NORM) DUM2=DUM2*SQRT7
                  IF(J.EQ.30.AND.NORM) DUM2=DUM2*SQRT5/SQRT3
                  IF(J.EQ.33.AND.NORM) DUM2=DUM2*SQRT3
                  IJ=IJ+1
                  NN=IA(LOCI+I)+(LOCJ+J)

                  DEN = PA(NN)
                  DEN=DEN+DEN
                  DIJ(IJ) = DUM2*DEN
                ENDDO
              ENDDO
C
C     ----- OVERLAP
C
              T = SQRT(AA1)
              X0 = AX
              Y0 = AY
              Z0 = AZ
              DO J = 1,LJT
                NJ = J
                DO I = 1,LITDER
                  NI = I
                  CALL RSM_VINT
                  XS(I,J)=XINT*T
                  YS(I,J)=YINT*T
                  ZS(I,J)=ZINT*T
                ENDDO
              ENDDO
C
              CALL DERI(DXS,DYS,DZS,XS,YS,ZS,LIT,LJT,AI)
C
              IJ=0
              DO I=MINI,MAXI
                IX=IJX(I)
                IY=IJY(I)
                IZ=IJZ(I)
                DO J=MINJ,MAXJ
                  JX=IJX(J)
                  JY=IJY(J)
                  JZ=IJZ(J)
                  DUMX=DXS(IX,JX)* YS(IY,JY)* ZS(IZ,JZ)
                  DUMY= XS(IX,JX)*DYS(IY,JY)* ZS(IZ,JZ)
                  DUMZ= XS(IX,JX)* YS(IY,JY)*DZS(IZ,JZ)
                  IJ=IJ+1
C
C                 SIGN IS CHANGED FROM ORIGINAL ONE
C
                  DER2(NSHLP,1,IAT)=DER2(NSHLP,1,IAT)-(DUMX*DIJ(IJ))
                  DER2(NSHLP,2,IAT)=DER2(NSHLP,2,IAT)-(DUMY*DIJ(IJ))
                  DER2(NSHLP,3,IAT)=DER2(NSHLP,3,IAT)-(DUMZ*DIJ(IJ))
                  DER2(NSHLP,1,JAT)=DER2(NSHLP,1,JAT)+(DUMX*DIJ(IJ))
                  DER2(NSHLP,2,JAT)=DER2(NSHLP,2,JAT)+(DUMY*DIJ(IJ))
                  DER2(NSHLP,3,JAT)=DER2(NSHLP,3,JAT)+(DUMZ*DIJ(IJ))
                ENDDO
              ENDDO
C
  620         CONTINUE
            ENDDO
          ENDDO
C
C     ----- END OF PRIMITIVE LOOPS -----
C
  760     CONTINUE
        ENDDO
      ENDDO
C
C     ----- END OF SHELL LOOPS -----
C
      DEALLOCATE(IA)
      RETURN
C
      END

C*MODULE RSM_SDDINT  *DECK RSM_MKDYMT2CP
C>
C>    @brief   compute the derivative of Y matrix in HESS calculation
C>             (ref: J. Chem. Phys. 155, 204102 (2021).)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   VPR: electrostatic potential induced by solvent molecules
C>             PA: density matrix
C>             FD: derivative of solvated Fock matrix
C>             GD: derivative of Delta d matrix (eq 15 in the reference)
C>             EG: gradient
C>             EH: Hessian
C>
      SUBROUTINE RSM_MKDYMT2CP(VPR,PA,FD,GD,EG,EH)

      USE ABSMOD,   ONLY : KATM0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, EX0A,
     *                     COF0A, KTYP0A, TRN3, NQMT0A, TQ
      USE RISM_MOD, ONLY : RSM_ISTIEND, GOPARR, NSHEL0A
      USE RSMSED,   ONLY : NUM, C, NAT
      USE RSM_BSMOD,ONLY : NSHELL,KSTART,KATOM,KTYPE,KNG,KLOC,KMIN,KMAX,
     *                     EX,CS,CP,CD,CF,CG,NORM

      IMPLICIT NONE
C
      LOGICAL IANDJ,DOUBLE
C
      DOUBLE PRECISION :: VPR(*),PA(*),FD(*),GD(NQMT0A,3,NAT),
     *                    EG(3,*),EH(9,*)
C
      DOUBLE PRECISION :: D01X(36,225),D01Y(36,225),D01Z(36,225),
     *                    DTMPX(225,36),DTMPY(225,36),DTMPZ(225,36),
     *                    DIJ(225)
      DOUBLE PRECISION :: DSTMP(36,9,2),DFTMP(36,3),DF(3),DS(9,2)
      INTEGER :: MINF(5), MAXF(5)
C
      DOUBLE PRECISION,ALLOCATABLE :: GTMP(:),TRNV(:),DWRK(:),SWRK(:,:),
     *                                FWRK(:,:), DG(:,:,:)
C
      INTEGER :: II, JJ, KK, I, J, K, L, MINI, MAXI, MINJ, MAXJ, MINK, 
     *           MAXK, MINL, MAXL, MINKM, MAXKP, MINKMM, MAXKPP, MINLM, 
     *           MAXLP, LIT, LJT, LKT, KFDX, KFDY, KFDZ,
     *           I1, I2, J1, J2, K1, K2, L1, L2, IG, JG, KG, LG, 
     *           LOCI, LOCJ, IN, JN, IJ, KL, JMAX, JGMAX, KAT, LAT,
     *           ISTRT, IEND, NN, MM, NSHTT, LL2, NN2, KKAT

      DOUBLE PRECISION :: XI,YI,ZI, XJ,YJ,ZJ, XK,YK,ZK, XL,YL,ZL,
     *                    ZETA,ETA,VALX2,VALY2,VALZ2,SAB,VAL,PX,PY,PZ,
     *                    RR, CSK,CSJ,CPJ,CDJ,CFJ,CGJ, CSI,CPI,CDI,CFI,
     *                    CGI,DUM,DKL, AXI,AYI,AZI, AI,AJ,AK,AL, AA1, 
     *                    ARRI, DUM1, DUM2, TRNFC, FAC
C
      DATA MINF/1,2, 5,11,21/
      DATA MAXF/1,4,10,20,35/
C
      DOUBLE PRECISION,PARAMETER :: SQRT3=1.73205080756888D+00,
     *                              SQRT5=2.23606797749979D+00, 
     *                              SQRT7=2.64575131106459D+00,
     *                              RLN10=2.30258D+00
C
      LL2 = NUM*(NUM+1)/2
      NN2 = NAT*(NAT+1)/2
      ALLOCATE(GTMP(1323*NSHEL0A),TRNV(NSHEL0A),DWRK(3*NAT*LL2),
     *         SWRK(9,NN2),FWRK(3,NAT),DG(NSHEL0A,3,NAT))
C
      CALL RSM_ISTIEND(NSHEL0A,ISTRT,IEND,NSHTT)

      CALL VCLR(DG   ,1,3*NAT*NSHEL0A)
      CALL VCLR(DWRK ,1,3*NAT*LL2)
      CALL VCLR(SWRK ,1,9*    NN2)
      CALL VCLR(FWRK ,1,3*    NAT)
C
!     TOL = RLN10*ITOL
C
      DO L=1,NSHEL0A
        VAL = 0.0D+00
        DO K=1,NQMT0A
          VAL = VAL + TQ(L,K)*VPR(K)
        ENDDO
        TRNV(L) = VAL
      ENDDO
C
      DO II = 1,NSHELL
        I   = KATOM(II)
        XI  = C(1,I)
        YI  = C(2,I)
        ZI  = C(3,I)
        I1  = KSTART(II)
        I2  = I1+KNG(II)-1
        LIT = KTYPE(II)
        MINI = KMIN(II)
        MAXI = KMAX(II)
        LOCI = KLOC(II)-MINI
C
C     ----- J SHELL -----
C
        DO JJ = 1,II
          J   = KATOM(JJ)
          XJ  = C(1,J)
          YJ  = C(2,J)
          ZJ  = C(3,J)
          J1  = KSTART(JJ)
          J2  = J1+KNG(JJ)-1
          LJT = KTYPE(JJ)
          MINJ = KMIN(JJ)
          MAXJ = KMAX(JJ)
          LOCJ = KLOC(JJ)-MINJ

          RR = (XI-XJ)**2+(YI-YJ)**2+(ZI-ZJ)**2
          IANDJ = II .EQ. JJ
C
C         ----- K SHELL
C
          DO KK=ISTRT,IEND
            KAT   = KATM0A(KK)
            KFDX  = 3*LL2*(KAT-1)
            KFDY  = KFDX + LL2
            KFDZ  = KFDY + LL2

            LKT   = KTYP0A(KK)
            XK    = C(1,KAT)
            YK    = C(2,KAT)
            ZK    = C(3,KAT)
            MINK  = KMIN0A(KK)
            MAXK  = KMAX0A(KK)
            MINKM = MINF(MAX(LKT-1,1))
            MAXKP = MAXF(LKT+1)
            MINKMM= MINF(MAX(LKT-2,1))
            MAXKPP= MAXF(LKT+2)

            LAT   = KAT
            XL    = XK
            YL    = YK
            ZL    = ZK
            MINL  = MINK
            MAXL  = MAXK
            MINLM = MINKM
            MAXLP = MAXKP

            K1   = KSTRT0A(KK)
            K2   = K1 + KNG0A(KK) - 1

            L1   = K1
            L2   = K2
C
C     ----- I PRIMITIVE
C
            D01X = 0.0D+00
            D01Y = 0.0D+00
            D01Z = 0.0D+00

            DFTMP = 0.0D+00
            DSTMP = 0.0D+00

            JGMAX = J2
            DO IG = I1,I2
              AI   = EX(IG)
              ARRI = AI*RR
              AXI  = AI*XI
              AYI  = AI*YI
              AZI  = AI*ZI
              CSI  = CS(IG)
              CPI  = CP(IG)
              CDI  = CD(IG)
              CFI  = CF(IG)
              CGI  = CG(IG)
C
C     ----- J PRIMITIVE
C
              IF (IANDJ) JGMAX = IG
              DO JG = J1,JGMAX
                AJ  = EX(JG)
                ZETA= AI+AJ
                AA1 = 1.0D+00/ZETA
                DUM = AJ*ARRI*AA1
*                 IF (DUM .GT. TOL) GO TO 500
                SAB = EXP(-DUM)
                CSJ = CS(JG)
                CPJ = CP(JG)
                CDJ = CD(JG)
                CFJ = CF(JG)
                CGJ = CG(JG)
                PX = (AXI+AJ*XJ)*AA1
                PY = (AYI+AJ*YJ)*AA1
                PZ = (AZI+AJ*ZJ)*AA1
C
C     ----- DENSITY FACTOR
C
                DOUBLE=IANDJ.AND.IG.NE.JG
                JMAX = MAXJ
                IJ = 0
                DUM1 = 0.0D+00
                DUM2 = 0.0D+00
                DO I = MINI,MAXI
                  IF (I.EQ.1) DUM1=CSI
                  IF (I.EQ.2) DUM1=CPI
                  IF (I.EQ.5) DUM1=CDI
                  IF ((I.EQ. 8).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.11) DUM1=CFI
                  IF ((I.EQ.14).AND.NORM) DUM1=DUM1*SQRT5
                  IF ((I.EQ.20).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.21) DUM1=CGI
                  IF ((I.EQ.24).AND.NORM) DUM1=DUM1*SQRT7
                  IF ((I.EQ.30).AND.NORM) DUM1=DUM1*SQRT5/SQRT3
                  IF ((I.EQ.33).AND.NORM) DUM1=DUM1*SQRT3
                  IF (IANDJ) JMAX = I
                  DO J = MINJ,JMAX
                    IF (J.EQ.1) THEN
                      DUM2=DUM1*CSJ
                      IF (DOUBLE) THEN
                        IF (I.LE.1) THEN
                          DUM2=DUM2+DUM2
                        ELSE
                          DUM2=DUM2+CSI*CPJ
                        END IF
                      END IF
                    ELSE IF (J.EQ.2) THEN
                      DUM2=DUM1*CPJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF (J.EQ.5) THEN
                      DUM2=DUM1*CDJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF ((J.EQ.8).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.11) THEN
                      DUM2=DUM1*CFJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF ((J.EQ.14).AND.NORM) THEN
                      DUM2=DUM2*SQRT5
                    ELSE IF ((J.EQ.20).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.21) THEN
                      DUM2=DUM1*CGJ
                      IF (DOUBLE) DUM2=DUM2+DUM2
                    ELSE IF ((J.EQ.24).AND.NORM) THEN
                      DUM2=DUM2*SQRT7
                    ELSE IF ((J.EQ.30).AND.NORM) THEN
                      DUM2=DUM2*SQRT5/SQRT3
                    ELSE IF ((J.EQ.33).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    END IF
                    IJ = IJ+1
                    DIJ(IJ) = DUM2
                  ENDDO
                ENDDO

                KL = 0
                DO K=MINK,MAXK
                  DO L=MINL,MAXL
                    KL = KL + 1
                  ENDDO
                ENDDO

                DO KG=K1,K2
                  AK = EX0A(KG)
                  DO LG=L1,L2
                    AL = EX0A(LG)

                    ETA = AK + AL
                    CSK = COF0A(KG) * COF0A(LG)

                    DKL = CSK

                    GTMP = 0.0D+00

                    CALL RSM_OSINT1(IANDJ,MINI,MAXI,MINJ,MAXJ,MINKMM,
     *                          MAXKPP,
     *                          MINLM,MAXLP,
     *                          ZETA,ETA,PX,PY,PZ,XK,YK,ZK,XI,
     *                          YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,SAB,
     *                          1.0D+00,GTMP)
 
                    CALL RSM_OSDER1BCP(IANDJ,AK,AL,PA,DIJ,DKL,GTMP,
     *                          MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                          MINKM,MAXKP,MINKMM,MAXKPP,MINLM,MAXLP,
     *                          LOCI,LOCJ,
     *                          D01X,D01Y,D01Z,DFTMP,DSTMP)
C
C                   ----- END OF PRIMITIVES
C
                  ENDDO
                ENDDO
              ENDDO
            ENDDO


            NN = 0
            JMAX = MAXJ
            DO I=MINI,MAXI
              IF(IANDJ) JMAX = I
              IN = LOCI + I
              DO J=MINJ,JMAX
                JN = LOCJ + J
                NN = NN + 1
                IF(IN < JN) THEN
                  MM = JN * (JN-1)/2 + IN
                ELSE
                  MM = IN * (IN-1)/2 + JN
                ENDIF

                KL = 0
                VALX2 = 0.0D+00
                VALY2 = 0.0D+00
                VALZ2 = 0.0D+00
                DO K=MINK,MAXK
                  DO L=MINL,MAXL
                    KL = KL + 1

                    TRNFC = TRN3(L,K)
                    VALX2 = VALX2 + TRNFC*D01X(KL,NN)
                    VALY2 = VALY2 + TRNFC*D01Y(KL,NN)
                    VALZ2 = VALZ2 + TRNFC*D01Z(KL,NN)
                  ENDDO
                ENDDO

                FAC = TRNV(KK)

                DWRK(KFDX+MM) = DWRK(KFDX+MM) + VALX2*FAC
                DWRK(KFDY+MM) = DWRK(KFDY+MM) + VALY2*FAC
                DWRK(KFDZ+MM) = DWRK(KFDZ+MM) + VALZ2*FAC
              ENDDO
            ENDDO

            DS = 0.0D+00
            DO I=1,2
              DO J=1,9
                KL = 0
                VAL = 0.0D+00
                DO K=MINK,MAXK
                  DO L=MINL,MAXL
                    KL = KL + 1

                    TRNFC = TRN3(L,K)
                    VAL = VAL + TRNFC*DSTMP(KL,J,I)
                  ENDDO
                ENDDO

                DS(J,I) = DS(J,I) + VAL*TRNV(KK)
              ENDDO
            ENDDO

!           print *,ds(1,1),ds(1,2)

            DF = 0.0D+00
            DO I=1,3
              KL = 0
              VAL = 0.0D+00
              DO K=MINK,MAXK
                DO L=MINL,MAXL
                  KL = KL + 1

                  TRNFC = TRN3(L,K)
                  VAL = VAL + TRNFC*DFTMP(KL,I)
                ENDDO
              ENDDO

              DF(I) = DF(I) + VAL*TRNV(KK)

              DG(KK,I,KAT) = DG(KK,I,KAT) + VAL
            ENDDO
C
            KKAT = KAT*(KAT-1)/2 + KAT

            DO I = 1,3
              FWRK(I,KAT) = FWRK(I,KAT) + DF(I)
            ENDDO

            DO I = 1,9
              SWRK(I,KKAT) = SWRK(I,KKAT) + DS(I,1)
              SWRK(I,KKAT) = SWRK(I,KKAT) + DS(I,2)
            ENDDO
          ENDDO
        ENDDO
      ENDDO

      IF(GOPARR) THEN
        CALL RSM_GSUMF(10003,DWRK,3*NAT*LL2)
        CALL RSM_GSUMF(10004,FWRK,3*    NAT)
        CALL RSM_GSUMF(10005,SWRK,9*    NN2)
        CALL RSM_GSUMF(10006,DG  ,3*NAT*NSHEL0A)
      ENDIF
C
C     SYMMETRIZE
C
      DO KAT = 1,NAT
        KKAT = ( KAT * (KAT-1) ) / 2 + KAT
        FAC  = ( SWRK(2,KKAT) + SWRK(4,KKAT) ) / 2.0D+00
        SWRK(2,KKAT) = FAC
        SWRK(4,KKAT) = FAC
        FAC  = ( SWRK(3,KKAT) + SWRK(7,KKAT) ) / 2.0D+00
        SWRK(3,KKAT) = FAC
        SWRK(7,KKAT) = FAC
        FAC  = ( SWRK(6,KKAT) + SWRK(8,KKAT) ) / 2.0D+00
        SWRK(6,KKAT) = FAC
        SWRK(8,KKAT) = FAC
      ENDDO
C
C
C
      DO I=1,NAT
        DO J=1,3
          DO K=1,NQMT0A
            VAL = 0.0D+00
            DO L=1,NSHEL0A
              VAL = VAL + TQ(L,K)*DG(L,J,I)
            ENDDO

            GD(K,J,I) = GD(K,J,I) + VAL
          ENDDO
        ENDDO
      ENDDO

      DO I=1,3*NAT*LL2
        FD(I) = FD(I) + DWRK(I)
      ENDDO

      DO I=1,NAT
        DO J=1,3
          EG(J,I) = EG(J,I) + FWRK(J,I)
        ENDDO
      ENDDO

      DO I=1,NN2
        DO J=1,9
          EH(J,I) = EH(J,I) + SWRK(J,I)
        ENDDO
      ENDDO
C
      DEALLOCATE(GTMP,TRNV,DWRK,SWRK,FWRK)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_OSDER1BCP
C>
C>    @brief   compute derivatives with Obara-Saika in RSM_MKDYMT2CP
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   IANDJ: the shell II is equal to the shell JJ, or not
C>             AK: the exponent of K shell
C>             AL: the exponent of l shell
C>             DAB: density matrix
C>             DIJ: product of normalized factors of shells I and J
C>             DKL: product of normalized factors of shells K and L
C>             GTMP: data computed in RSM_OSINT1
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             MINKM: starting counters of the shell, which
C>                    angular momentum is K-1
C>             MAXKP: ending counter of the shell, which
C>                    angular momentum is K+1
C>             MINKMM: starting counters of the shell, which
C>                    angular momentum is K-2
C>             MAXKPP: ending counter of the shell, which
C>                    angular momentum is K+2
C>             MINLM: starting counters of the shell, which
C>                    angular momentum is L-1
C>             MAXLP: ending counter of the shell, which
C>                    angular momentum is L+1
C>             LOCI: location of the basis function in shell I
C>             LOCJ: location of the basis function in shell J
C>             D01X: derivatives with respect X coordinate
C>             D01Y: derivatives with respect Y coordinate
C>             D01Z: derivatives with respect Z coordinate
C>             DF: gradient
C>             DS: hessian
C>
      SUBROUTINE RSM_OSDER1BCP(IANDJ,AK,AL,DAB,DIJ,DKL,GTMP,
     *                   MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                   MINKM,MAXKP,MINKMM,MAXKPP,MINLM,MAXLP,
     *                   LOCI,LOCJ,
     *                   D01X,D01Y,D01Z,DF,DS)
      IMPLICIT NONE
C
      LOGICAL,          INTENT(IN   ) :: IANDJ
      INTEGER,          INTENT(IN   ) :: MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                                   MINL,MAXL,MINKM,MAXKP,MINKMM,
     *                                   MAXKPP,MINLM,MAXLP,LOCI,LOCJ
      DOUBLE PRECISION, INTENT(IN   ) :: AK,AL,DAB(*),DIJ(*),DKL,GTMP(*)
      DOUBLE PRECISION, INTENT(INOUT) :: DF(36,3),D01X(36,*),D01Y(36,*),
     *                                   D01Z(36,*),DS(36,9,2)
      DOUBLE PRECISION                :: WRK1(20,20), WRK2X(20,20), 
     *                                   WRK2Y(20,20),WRK2Z(20,20)
C
      INTEGER                :: I, J, K, L, IJN, IN, JN, IJ, KL, NN,
     *                          KPX, KPY, KPZ, KMX, KMY, KMZ,
     *                          LPX, LPY, LPZ, LMX, LMY, LMZ,
     *                          JMAX
      DOUBLE PRECISION       :: TAK, TAL, DENSITY, DENSITY0, 
     *                          X, Y, Z, RX, RY, RZ,
     *                          XX, XY, XZ, YX, YY, YZ, ZX, ZY, ZZ
C
      INTEGER                :: KP(3,10), KM(3,10)
      DOUBLE PRECISION       :: RIN(3,10)

      DATA KP/ 2, 3, 4, ! S
     *         5, 8, 9, ! P
     *         8, 6,10,
     *         9,10, 7,
     *        11,14,15, ! D
     *        16,12,17,
     *        18,19,13,
     *        14,16,20,
     *        15,20,18,
     *        20,17,19/
      DATA KM/ 1, 1, 1, ! S
     *         1, 1, 1, ! P
     *         1, 1, 1,
     *         1, 1, 1,
     *         2, 1, 1, ! D
     *         1, 3, 1,
     *         1, 1, 4,
     *         3, 2, 1,
     *         4, 1, 2,
     *         1, 4, 3/
      DATA RIN/0.0D+00,0.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,1.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,1.0D+00,
     *         2.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,1.0D+00,
     *         0.0D+00,1.0D+00,1.0D+00/
C
      TAK = AK + AK
      TAL = AL + AL

!     print *,MINKMM,MAXKPP,MINLM,MAXLP

      NN = 0
      IJ = 0
      JMAX = MAXJ
      DO I=MINI,MAXI
        IN = LOCI + I
        IF(IANDJ) JMAX = I
        DO J=MINJ,JMAX
          JN = LOCJ + J

          IJ = IJ + 1
          DO K=MINKMM,MAXKPP
            DO L=MINLM,MAXLP
              NN = NN + 1

              WRK1(K,L) = GTMP(NN)

!             if(in*(in-1)/2+jn == 3) print *,k,l,GTMP(NN)
            ENDDO
          ENDDO
C
C         (K',L)
C
          IJN = IN*(IN-1)/2 + JN

          DENSITY0= DIJ(IJ)*(DKL + DKL)
          DENSITY = DENSITY0*DAB(IJN)
          IF(IN /= JN) DENSITY = DENSITY + DENSITY

          KL = 0
          DO K=MINK,MAXK
            KPX = KP(1,K)
            KPY = KP(2,K)
            KPZ = KP(3,K)
 
            KMX = KM(1,K)
            KMY = KM(2,K)
            KMZ = KM(3,K)
 
            RX  = RIN(1,K)
            RY  = RIN(2,K)
            RZ  = RIN(3,K)
 
            DO L=MINL,MAXL
              KL = KL + 1

              X = TAK*WRK1(KPX,L) - RX*WRK1(KMX,L)
              Y = TAK*WRK1(KPY,L) - RY*WRK1(KMY,L)
              Z = TAK*WRK1(KPZ,L) - RZ*WRK1(KMZ,L)

              D01X(KL,IJ) = D01X(KL,IJ) + X*DENSITY0
              D01Y(KL,IJ) = D01Y(KL,IJ) + Y*DENSITY0
              D01Z(KL,IJ) = D01Z(KL,IJ) + Z*DENSITY0
              
              DF(KL,1) = DF(KL,1) + X*DENSITY
              DF(KL,2) = DF(KL,2) + Y*DENSITY
              DF(KL,3) = DF(KL,3) + Z*DENSITY
            ENDDO
          ENDDO
C
C         (K',L')
C
          DO K=MINKM,MAXKP
            DO L=MINL,MAXL
              LPX = KP(1,L)
              LPY = KP(2,L)
              LPZ = KP(3,L)

              LMX = KM(1,L)
              LMY = KM(2,L)
              LMZ = KM(3,L)

              RX  = RIN(1,L)
              RY  = RIN(2,L)
              RZ  = RIN(3,L)

              WRK2X(K,L) = TAL*WRK1(K,LPX) - RX*WRK1(K,LMX)
              WRK2Y(K,L) = TAL*WRK1(K,LPY) - RY*WRK1(K,LMY)
              WRK2Z(K,L) = TAL*WRK1(K,LPZ) - RZ*WRK1(K,LMZ)
            ENDDO
          ENDDO

          KL = 0
          DO K=MINK,MAXK
            KPX = KP(1,K)
            KPY = KP(2,K)
            KPZ = KP(3,K)

            KMX = KM(1,K)
            KMY = KM(2,K)
            KMZ = KM(3,K)

            RX  = RIN(1,K)
            RY  = RIN(2,K)
            RZ  = RIN(3,K)

            DO L=MINL,MAXL
              KL = KL + 1 
C
C           XX, XY, XZ
C
!     if(ijn == 3) print *,WRK2X(KPX,L),RX*WRK2X(KMX,L)
              XX = TAK*WRK2X(KPX,L) - RX*WRK2X(KMX,L)
              XY = TAK*WRK2X(KPY,L) - RY*WRK2X(KMY,L)
              XZ = TAK*WRK2X(KPZ,L) - RZ*WRK2X(KMZ,L)
C
C           YX, YY, YZ
C
              YX = TAK*WRK2Y(KPX,L) - RX*WRK2Y(KMX,L)
              YY = TAK*WRK2Y(KPY,L) - RY*WRK2Y(KMY,L)
              YZ = TAK*WRK2Y(KPZ,L) - RZ*WRK2Y(KMZ,L)
C
C           ZX, ZY, ZZ
C
              ZX = TAK*WRK2Z(KPX,L) - RX*WRK2Z(KMX,L)
              ZY = TAK*WRK2Z(KPY,L) - RY*WRK2Z(KMY,L)
              ZZ = TAK*WRK2Z(KPZ,L) - RZ*WRK2Z(KMZ,L)
C
              DS(KL,1,2) = DS(KL,1,2) + XX*DENSITY
              DS(KL,2,2) = DS(KL,2,2) + YX*DENSITY
              DS(KL,3,2) = DS(KL,3,2) + ZX*DENSITY
              DS(KL,4,2) = DS(KL,4,2) + XY*DENSITY
              DS(KL,5,2) = DS(KL,5,2) + YY*DENSITY
              DS(KL,6,2) = DS(KL,6,2) + ZY*DENSITY
              DS(KL,7,2) = DS(KL,7,2) + XZ*DENSITY
              DS(KL,8,2) = DS(KL,8,2) + YZ*DENSITY
              DS(KL,9,2) = DS(KL,9,2) + ZZ*DENSITY
            ENDDO
          ENDDO
C
C         (K'',L)
C
          DO K=MINKM,MAXKP
            KPX = KP(1,K)
            KPY = KP(2,K)
            KPZ = KP(3,K)

            KMX = KM(1,K)
            KMY = KM(2,K)
            KMZ = KM(3,K)

            RX  = RIN(1,K)
            RY  = RIN(2,K)
            RZ  = RIN(3,K)

            DO L=MINL,MAXL
              WRK2X(K,L) = TAK*WRK1(KPX,L) - RX*WRK1(KMX,L)
              WRK2Y(K,L) = TAK*WRK1(KPY,L) - RY*WRK1(KMY,L)
              WRK2Z(K,L) = TAK*WRK1(KPZ,L) - RZ*WRK1(KMZ,L)
            ENDDO
          ENDDO

          KL = 0
          DO K=MINK,MAXK
            KPX = KP(1,K)
            KPY = KP(2,K)
            KPZ = KP(3,K)

            KMX = KM(1,K)
            KMY = KM(2,K)
            KMZ = KM(3,K)

            RX  = RIN(1,K)
            RY  = RIN(2,K)
            RZ  = RIN(3,K)

            DO L=MINL,MAXL
              KL = KL + 1
C
C           XX, XY, XZ
C
              XX = TAK*WRK2X(KPX,L) - RX*WRK2X(KMX,L)
              XY = TAK*WRK2X(KPY,L) - RY*WRK2X(KMY,L)
              XZ = TAK*WRK2X(KPZ,L) - RZ*WRK2X(KMZ,L)
C
C           YX, YY, YZ
C
              YX = TAK*WRK2Y(KPX,L) - RX*WRK2Y(KMX,L)
              YY = TAK*WRK2Y(KPY,L) - RY*WRK2Y(KMY,L)
              YZ = TAK*WRK2Y(KPZ,L) - RZ*WRK2Y(KMZ,L)
C
C           ZX, ZY, ZZ
C
              ZX = TAK*WRK2Z(KPX,L) - RX*WRK2Z(KMX,L)
              ZY = TAK*WRK2Z(KPY,L) - RY*WRK2Z(KMY,L)
              ZZ = TAK*WRK2Z(KPZ,L) - RZ*WRK2Z(KMZ,L)
C
              DS(KL,1,1) = DS(KL,1,1) + XX*DENSITY
              DS(KL,2,1) = DS(KL,2,1) + YX*DENSITY
              DS(KL,3,1) = DS(KL,3,1) + ZX*DENSITY
              DS(KL,4,1) = DS(KL,4,1) + XY*DENSITY
              DS(KL,5,1) = DS(KL,5,1) + YY*DENSITY
              DS(KL,6,1) = DS(KL,6,1) + ZY*DENSITY
              DS(KL,7,1) = DS(KL,7,1) + XZ*DENSITY
              DS(KL,8,1) = DS(KL,8,1) + YZ*DENSITY
              DS(KL,9,1) = DS(KL,9,1) + ZZ*DENSITY
            ENDDO
          ENDDO
C        
!         if(ijn == 3) print *,ds(1,1,1),ds(1,1,2)


        ENDDO
      ENDDO
C
      RETURN
      END

C*MODULE RSM_SDDINT  *DECK RSM_MKDYMT2CP
C>
C>    @brief   compute the hessian of Y matrix in HESS calculation
C>             (ref: J. Chem. Phys. 155, 204102 (2021).)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   VPR: electrostatic potential induced by solvent molecules
C>             PA: density matrix
C>             EH: Hessian
C>

      SUBROUTINE RSM_MKDYMT3CP(VPR,PA,EH)
C
      USE RISM_MOD, ONLY : RSM_ISTIEND, GOPARR, NSHEL0A
      USE RSMSED,   ONLY : NUM, C, NAT
      USE RSM_BSMOD,ONLY : NSHELL,KSTART,KATOM,KTYPE,KNG,KLOC,KMIN,KMAX,
     *                     EX,CS,CP,CD,CF,CG,NORM
      USE ABSMOD,   ONLY : KATM0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, 
     *                     KTYP0A, EX0A, COF0A, TRN3, NQMT0A, TQ
C
      IMPLICIT NONE
C
      DOUBLE PRECISION, INTENT(IN   ) :: VPR(*),PA(*)
      DOUBLE PRECISION, INTENT(INOUT) :: EH(9,*)
C
      LOGICAL               :: KGTJ
      DOUBLE PRECISION      :: DIJ(225),
     *                         WRK3(9), DSTMP(36,9), DS(9)
C
      DOUBLE PRECISION, ALLOCATABLE  :: GTMP(:),TRNV(:),SWRK(:,:)
C
      INTEGER              :: II, MINI, MAXI, LOCI, I1, I2, IG, 
     *                        JJ, MINJ, MAXJ, LOCJ, J1, J2, JG, JAT,
     *                        KK, MINK, MAXK,       K1, K2, KG, KAT,
     *                            MINL, MAXL,       L1, L2, LG,
     *                        I, J, K, L, IJ, KL, NN, IN, JN, NIJ,
     *                        LJT, LKT, MINJM, MAXJP, MINKM, MAXKP,
     *                        LL2, NN2, 
     *                        ISTRT, IEND, NSHTT, KKAT, JKAT
      DOUBLE PRECISION     :: XI, YI, ZI, XJ, YJ, ZJ, PX, PY, PZ,
     *                        XK, YK, ZK, XL, YL, ZL, AXI, AYI, AZI,
     *                        AI, CSI, CPI, CDI, CFI, CGI,
     *                        AJ, CSJ, CPJ, CDJ, CFJ, CGJ,
     *                        SAB, DUM, ETA, ZETA, ZETA1, VAL, RR, AK,
     *                        DUM1, DUM2, FAC, TRNFC, CSK, DKL, ARRI
C
      DOUBLE PRECISION, PARAMETER    :: SQRT3=1.73205080756888D+00,
     *                                  SQRT5=2.23606797749979D+00, 
     *                                  SQRT7=2.64575131106459D+00
C
      INTEGER :: MINF(5), MAXF(5)
      DATA MINF/1,2, 5,11,21/
      DATA MAXF/1,4,10,20,35/
C
      LL2 = NUM*(NUM+1)/2
      NN2 = NAT*(NAT+1)/2
      ALLOCATE(GTMP(310*NSHEL0A),TRNV(NSHEL0A),SWRK(9,NN2))
C
      CALL RSM_ISTIEND(NSHEL0A,ISTRT,IEND,NSHTT)

      CALL VCLR(SWRK ,1,9*    NN2)
C
      DO L=1,NSHEL0A
        VAL = 0.0D+00
        DO K=1,NQMT0A
          VAL = VAL + TQ(L,K)*VPR(K)
        ENDDO
        TRNV(L) = VAL
      ENDDO

!     print *,'istrt',ISTRT,IEND
!
!     PROGRAM CHECK !
!
!     do i=1,nshel0a
!       trnv(i) = 0.0d0
!     enddo
!     do i=1,ll2
!       pa(i) = 0.0d0
!     enddo
!
!     trnv(6) = 1.0d0
!     pa(15) = 1.0d0
!        print *,'nshel0a',nshel0a
C
C     ---- I SHELL -----
C
      DO II = 1,NSHELL
        I    = KATOM(II)
        XI   = C(1,I)   
        YI   = C(2,I)
        ZI   = C(3,I)
        I1   = KSTART(II)
        I2   = I1+KNG(II)-1
        MINI = KMIN(II)
        MAXI = KMAX(II)
        LOCI = KLOC(II)-MINI
C
C     ----- J SHELL -----
C
        DO JJ = 1,NSHELL
          JAT   = KATOM(JJ)
          LJT   = KTYPE(JJ)
          XJ    = C(1,JAT)   
          YJ    = C(2,JAT)
          ZJ    = C(3,JAT)
          J1    = KSTART(JJ)
          J2    = J1+KNG(JJ)-1
          MINJ  = KMIN(JJ)
          MAXJ  = KMAX(JJ)
          MINJM = MINF(MAX(LJT-1,1))
          MAXJP = MAXF(LJT+1)
          LOCJ  = KLOC(JJ)-MINJ

          RR = (XI-XJ)**2+(YI-YJ)**2+(ZI-ZJ)**2
C
C         ----- K SHELL
C
          DO KK=ISTRT,IEND
            KAT  = KATM0A(KK)
            LKT  = KTYP0A(KK)
            XK   = C(1,KAT)
            YK   = C(2,KAT)
            ZK   = C(3,KAT)
            MINK = KMIN0A(KK)
            MAXK = KMAX0A(KK)

            MINKM = MINF(MAX(LKT-1,1))
            MAXKP = MAXF(LKT+1)

            XL   = XK
            YL   = YK
            ZL   = ZK
            MINL = MINK
            MAXL = MAXK

            K1   = KSTRT0A(KK)
            K2   = K1 + KNG0A(KK) - 1

            L1   = K1
            L2   = K2

            KGTJ = KAT > JAT
C
C           ----- I PRIMITIVE
C
            DSTMP = 0.0D+00
            DO IG = I1,I2
              AI   = EX(IG)
              ARRI = AI*RR
              AXI  = AI*XI
              AYI  = AI*YI
              AZI  = AI*ZI
              CSI  = CS(IG)
              CPI  = CP(IG)
              CDI  = CD(IG)
              CFI  = CF(IG)
              CGI  = CG(IG)
C
C           ----- J PRIMITIVE
C
              DO JG = J1,J2
                AJ    = EX(JG)
                ZETA  = AI+AJ
                ZETA1 = 1.0D+00/ZETA
                DUM   = AJ*ARRI*ZETA1
*               IF (DUM .GT. TOL) GO TO 500
                SAB   = EXP(-DUM)
                CSJ   = CS(JG)
                CPJ   = CP(JG)
                CDJ   = CD(JG)
                CFJ   = CF(JG)
                CGJ   = CG(JG)
                PX    = (AXI+AJ*XJ)*ZETA1
                PY    = (AYI+AJ*YJ)*ZETA1
                PZ    = (AZI+AJ*ZJ)*ZETA1
C
C     ----- DENSITY FACTOR
C
                IJ = 0
                DUM1 = 0.0D+00
                DUM2 = 0.0D+00
                DO I = MINI,MAXI
                  IF (I.EQ.1) DUM1=CSI
                  IF (I.EQ.2) DUM1=CPI
                  IF (I.EQ.5) DUM1=CDI
                  IF ((I.EQ. 8).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.11) DUM1=CFI
                  IF ((I.EQ.14).AND.NORM) DUM1=DUM1*SQRT5
                  IF ((I.EQ.20).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.21) DUM1=CGI
                  IF ((I.EQ.24).AND.NORM) DUM1=DUM1*SQRT7
                  IF ((I.EQ.30).AND.NORM) DUM1=DUM1*SQRT5/SQRT3
                  IF ((I.EQ.33).AND.NORM) DUM1=DUM1*SQRT3
                  DO J = MINJ,MAXJ
                    IF (J.EQ.1) THEN
                      DUM2=DUM1*CSJ
                    ELSE IF (J.EQ.2) THEN
                      DUM2=DUM1*CPJ
                    ELSE IF (J.EQ.5) THEN
                      DUM2=DUM1*CDJ
                    ELSE IF ((J.EQ.8).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.11) THEN
                      DUM2=DUM1*CFJ
                    ELSE IF ((J.EQ.14).AND.NORM) THEN
                      DUM2=DUM2*SQRT5
                    ELSE IF ((J.EQ.20).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.21) THEN
                      DUM2=DUM1*CGJ
                    ELSE IF ((J.EQ.24).AND.NORM) THEN
                      DUM2=DUM2*SQRT7
                    ELSE IF ((J.EQ.30).AND.NORM) THEN
                      DUM2=DUM2*SQRT5/SQRT3
                    ELSE IF ((J.EQ.33).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    END IF
                    IJ = IJ + 1
                    DIJ(IJ) = DUM2
                  ENDDO
                ENDDO

                KL = 0
                DO K=MINK,MAXK
                  DO L=MINL,MAXL
                    KL = KL + 1
                  ENDDO
                ENDDO

                DO KG=K1,K2
                  AK = EX0A(KG)
                  DO LG=L1,L2
                    ETA = AK + EX0A(LG)
                    CSK = COF0A(KG) * COF0A(LG)

                    DKL = CSK

                    GTMP = 0.0D+00

                    CALL RSM_OSINT1(.FALSE.,MINI,MAXI,MINJM,MAXJP,
     *                          MINKM,MAXKP,MINL,MAXL,
     *                          ZETA,ETA,PX,PY,PZ,XK,YK,ZK,XI,
     *                          YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,SAB,
     *                          1.0D+00,GTMP)

                    CALL RSM_OSDER1CCP(KGTJ,AJ,AK,PA,DIJ,DKL,GTMP,
     *                        MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                        MINJM,MAXJP,MINKM,MAXKP,
     *                        LOCI,LOCJ,DSTMP)
C
C                   ----- END OF PRIMITIVES
C
                  ENDDO
                ENDDO
              ENDDO
            ENDDO

            WRK3  = 0.0D+00
            KL = 0
            DO K=MINK,MAXK
              DO L=MINL,MAXL
                KL = KL + 1

!               print *,jat,kat,dstmp(kl,1)

                TRNFC = TRN3(L,K)
                DO J=1,9
                  WRK3(J) = WRK3(J) + TRNFC*DSTMP(KL,J)
                ENDDO
              ENDDO
            ENDDO

            DS = 0.0D+00
            DO J=1,9
              DS(J) = DS(J) + WRK3(J)*TRNV(KK)
            ENDDO
C
            FAC = 1.0D+00
            IF(KAT .EQ. JAT) FAC = 2.0D+00

            IF(JAT <= KAT) THEN
              JKAT = KAT*(KAT-1)/2 + JAT
            ELSE
              JKAT = JAT*(JAT-1)/2 + KAT
            ENDIF

            DO I = 1,9
              SWRK(I,JKAT) = SWRK(I,JKAT) + DS(I) * FAC
!             SWRK2(I,JAT,KAT) = SWRK2(I,JAT,KAT) + DS(I)*FAC
            ENDDO
          ENDDO
C
        ENDDO
      ENDDO

      IF(GOPARR) CALL RSM_GSUMF(10006,SWRK,9*    NN2)
C
C     SYMMETRIZE
C
      DO KAT = 1,NAT
        KKAT = ( KAT * (KAT-1) ) / 2 + KAT
        FAC  = ( SWRK(2,KKAT) + SWRK(4,KKAT) ) / 2.0D+00
        SWRK(2,KKAT) = FAC
        SWRK(4,KKAT) = FAC
        FAC  = ( SWRK(3,KKAT) + SWRK(7,KKAT) ) / 2.0D+00
        SWRK(3,KKAT) = FAC
        SWRK(7,KKAT) = FAC
        FAC  = ( SWRK(6,KKAT) + SWRK(8,KKAT) ) / 2.0D+00
        SWRK(6,KKAT) = FAC
        SWRK(8,KKAT) = FAC
      ENDDO
C
C
C
      DO I=1,NN2
        DO J=1,9
          EH(J,I) = EH(J,I) + SWRK(J,I)
        ENDDO
      ENDDO
!
!     test
!
!     print *,'>> ymt3'
!
!     do i=1,nn2
!       nn = 0
!       do k=1,3
!         print *,(eh(nn+j,i),j=1,3)
!         nn = nn + 3
!       enddo
!       print *,'----'
!     enddo
C
      DEALLOCATE(GTMP,TRNV,SWRK)
C
      RETURN
      END

C*MODULE RSM_SDDINT  *DECK RSM_OSDER1CCP
C>
C>    @brief   compute derivatives with Obara-Saika in RSM_MKDYMT3CP
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   KGTJ: KAT is greater than JAT, or not
C>             AJ: the exponent of J shell
C>             AK: the exponent of K shell
C>             DAB: density matrix
C>             DIJ: product of normalized factors of shells I and J
C>             DKL: product of normalized factors of shells K and L
C>             GTMP: data computed in RSM_OSINT1
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             MINJM: starting counters of the shell, which
C>                    angular momentum is J-1
C>             MAXJP: ending counter of the shell, which
C>                    angular momentum is J+1
C>             MINKM: starting counters of the shell, which
C>                    angular momentum is K-1
C>             MAXKP: ending counter of the shell, which
C>                    angular momentum is K+1
C>             LOCI: location of the basis function in shell I
C>             LOCJ: location of the basis function in shell J
C>             DS: hessian
C>
      SUBROUTINE RSM_OSDER1CCP(KGTJ,AJ,AK,DAB,DIJ,DKL,GTMP,
     *                        MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                        MINJM,MAXJP,MINKM,MAXKP,
     *                        LOCI,LOCJ,DS)
      IMPLICIT NONE
C
      LOGICAL,          INTENT(IN   ) :: KGTJ
      INTEGER,          INTENT(IN   ) :: MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                                   MINL,MAXL, MINJM,MAXJP,
     *                                   MINKM,MAXKP,LOCI,LOCJ
      DOUBLE PRECISION, INTENT(IN   ) :: AJ,AK,DAB(*),DIJ(*),DKL,GTMP(*)
      DOUBLE PRECISION, INTENT(  OUT) :: DS(36,*)
C
      DOUBLE PRECISION  :: WRK1(10,84,10,84), 
     *           WRK2X(35,10), WRK2Y(35,10), WRK2Z(35,10)
C
      INTEGER :: I, J, K, L, NN, IJ, IJ0, IN, JN, IJN, KL,
     *           KPX, KPY, KPZ, KMX, KMY, KMZ,
     *           JPX, JPY, JPZ, JMX, JMY, JMZ
      DOUBLE PRECISION :: RX,RY,RZ, XX, YX, ZX, XY, YY, ZY, XZ, YZ, ZZ,
     *                    TAJ, TAK, DENSITY
C
      INTEGER          :: JP(3,56), JM(3,56)
      DOUBLE PRECISION :: RIN(3,56)

      DATA JP/ 2, 3, 4,
     *         5, 8, 9,
     *         8, 6,10,
     *         9,10, 7,
     *        11,14,15,
     *        16,12,17,
     *        18,19,13,
     *        14,16,20,
     *        15,20,18,
     *        20,17,19,
     *        21,24,25,
     *        26,22,27,
     *        28,29,23,
     *        24,30,33,
     *        25,33,31,
     *        30,26,34,
     *        34,27,32,
     *        31,35,28,
     *        35,32,29,
     *        33,34,35,
     *        36,39,40,
     *        41,37,42,
     *        43,44,38,
     *        39,45,51,
     *        40,51,46,
     *        47,41,52,
     *        52,42,48,
     *        49,53,43,
     *        53,50,44,
     *        45,47,54,
     *        46,55,49,
     *        56,48,50,
     *        51,54,55,
     *        54,52,56,
     *        55,56,53,
     *        57,60,61,
     *        62,58,63,
     *        64,65,59,
     *        60,66,72,
     *        61,72,67,
     *        68,62,73,
     *        73,63,69,
     *        70,74,64,
     *        74,71,65,
     *        66,75,78,
     *        67,79,76,
     *        75,68,80,
     *        81,69,77,
     *        76,82,70,
     *        83,77,71,
     *        72,78,79,
     *        80,73,81,
     *        82,83,74,
     *        78,80,84,
     *        79,84,82,
     *        84,81,83/ 
      DATA JM/ 1, 1, 1,
     *         1, 1, 1,
     *         1, 1, 1,
     *         1, 1, 1,
     *         2, 1, 1,
     *         1, 3, 1,
     *         1, 1, 4,
     *         3, 2, 1,
     *         4, 1, 2,
     *         1, 4, 3,
     *         5, 1, 1,
     *         1, 6, 1,
     *         1, 1, 7,
     *         8, 5, 1,
     *         9, 1, 5,
     *         6, 8, 1,
     *         1,10, 6,
     *         7, 1, 9,
     *         1, 7,10,
     *        10, 9, 8,
     *        11, 1, 1,
     *         1,12, 1,
     *         1, 1,13,
     *        14,11, 1,
     *        15, 1,11,
     *        12,16, 1,
     *         1,17,12,
     *        13, 1,18,
     *         1,13,19,
     *        16,14, 1,
     *        18, 1,15,
     *         1,19,17,
     *        20,15,14,
     *        17,20,16,
     *        19,18,20,
     *        21, 1, 1,
     *         1,22, 1,
     *         1, 1,23,
     *        24,21, 1,
     *        25, 1,21,
     *        22,26, 1,
     *         1,27,22,
     *        23, 1,28,
     *         1,23,29,
     *        30,24, 1,
     *        31, 1,25,
     *        26,30, 1,
     *         1,32,27,
     *        28, 1,31,
     *         1,29,32,
     *        33,25,24,
     *        27,34,26,
     *        29,28,35,
     *        34,33,30,
     *        35,31,33,
     *        32,35,34/
      DATA RIN/0.0D+00,0.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,1.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,1.0D+00,
     *         2.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,1.0D+00,
     *         0.0D+00,1.0D+00,1.0D+00,
     *         3.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,3.0D+00,
     *         2.0D+00,1.0D+00,0.0D+00,
     *         2.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,2.0D+00,
     *         0.0D+00,1.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,1.0D+00,
     *         4.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,4.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,4.0D+00,
     *         3.0D+00,1.0D+00,0.0D+00,
     *         3.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,3.0D+00,
     *         0.0D+00,1.0D+00,3.0D+00,
     *         2.0D+00,2.0D+00,0.0D+00,
     *         2.0D+00,0.0D+00,2.0D+00,
     *         0.0D+00,2.0D+00,2.0D+00,
     *         2.0D+00,1.0D+00,1.0D+00,
     *         1.0D+00,2.0D+00,1.0D+00,
     *         1.0D+00,1.0D+00,2.0D+00,
     *         5.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,5.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,5.0D+00,
     *         4.0D+00,1.0D+00,0.0D+00,
     *         4.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,4.0D+00,0.0D+00,
     *         0.0D+00,4.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,4.0D+00,
     *         0.0D+00,1.0D+00,4.0D+00,
     *         3.0D+00,2.0D+00,0.0D+00,
     *         3.0D+00,0.0D+00,2.0D+00,
     *         2.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,2.0D+00,
     *         2.0D+00,0.0D+00,3.0D+00,
     *         0.0D+00,2.0D+00,3.0D+00,
     *         3.0D+00,1.0D+00,1.0D+00,
     *         1.0D+00,3.0D+00,1.0D+00,
     *         1.0D+00,1.0D+00,3.0D+00,
     *         2.0D+00,2.0D+00,1.0D+00,
     *         2.0D+00,1.0D+00,2.0D+00,
     *         1.0D+00,2.0D+00,2.0D+00/
C
      TAJ = AJ + AJ
      TAK = AK + AK

      NN = 0
      DO I=MINI,MAXI
        DO J=MINJM,MAXJP
          DO K=MINKM,MAXKP
            DO L=MINL,MAXL
              NN = NN + 1

              WRK1(K,J,L,I) = GTMP(NN)
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
C
C
      DO I=MINI,MAXI
        IN = LOCI + I
        IJ0 = (MAXJ-MINJ+1)*(I-MINI)

        KL = 0
        DO L=MINL,MAXL

          DO J=MINJM,MAXJP
            DO K=MINK,MAXK
              KPX = JP(1,K)
              KPY = JP(2,K)
              KPZ = JP(3,K)

              KMX = JM(1,K)
              KMY = JM(2,K)
              KMZ = JM(3,K)

              RX  = RIN(1,K)
              RY  = RIN(2,K)
              RZ  = RIN(3,K)

              WRK2X(J,K) = TAK*WRK1(KPX,J,L,I) - RX*WRK1(KMX,J,L,I)
              WRK2Y(J,K) = TAK*WRK1(KPY,J,L,I) - RY*WRK1(KMY,J,L,I)
              WRK2Z(J,K) = TAK*WRK1(KPZ,J,L,I) - RZ*WRK1(KMZ,J,L,I)
            ENDDO
          ENDDO

          DO K=MINK,MAXK
            KL = KL + 1
            IJ = IJ0
            DO J=MINJ,MAXJ
              IJ = IJ + 1
              JN = LOCJ + J

              IF(JN > IN) THEN
                IJN = JN*(JN-1)/2 + IN
              ELSE
                IJN = IN*(IN-1)/2 + JN
              ENDIF

              DENSITY = 4.0D+00*DIJ(IJ)*DAB(IJN)*DKL

              JPX = JP(1,J)
              JPY = JP(2,J)
              JPZ = JP(3,J)

              JMX = JM(1,J)
              JMY = JM(2,J)
              JMZ = JM(3,J)

              RX  = RIN(1,J)
              RY  = RIN(2,J)
              RZ  = RIN(3,J)
C
C           XX, XY, XZ (K, J)
C
              XX = TAJ*WRK2X(JPX,K) - RX*WRK2X(JMX,K)
              XY = TAJ*WRK2X(JPY,K) - RY*WRK2X(JMY,K)
              XZ = TAJ*WRK2X(JPZ,K) - RZ*WRK2X(JMZ,K)
C
C           YX, YY, YZ
C
              YX = TAJ*WRK2Y(JPX,K) - RX*WRK2Y(JMX,K)
              YY = TAJ*WRK2Y(JPY,K) - RY*WRK2Y(JMY,K)
              YZ = TAJ*WRK2Y(JPZ,K) - RZ*WRK2Y(JMZ,K)
C
C           ZX, ZY, ZZ
C
              ZX = TAJ*WRK2Z(JPX,K) - RX*WRK2Z(JMX,K)
              ZY = TAJ*WRK2Z(JPY,K) - RY*WRK2Z(JMY,K)
              ZZ = TAJ*WRK2Z(JPZ,K) - RZ*WRK2Z(JMZ,K)
C
C             (K > J)
C
              IF(.NOT.KGTJ) THEN
                DS(KL,1) = DS(KL,1) + XX*DENSITY
                DS(KL,2) = DS(KL,2) + YX*DENSITY
                DS(KL,3) = DS(KL,3) + ZX*DENSITY
                DS(KL,4) = DS(KL,4) + XY*DENSITY
                DS(KL,5) = DS(KL,5) + YY*DENSITY
                DS(KL,6) = DS(KL,6) + ZY*DENSITY
                DS(KL,7) = DS(KL,7) + XZ*DENSITY
                DS(KL,8) = DS(KL,8) + YZ*DENSITY
                DS(KL,9) = DS(KL,9) + ZZ*DENSITY
              ELSE
C
C             (J >= K)
C
                DS(KL,1) = DS(KL,1) + XX*DENSITY
                DS(KL,2) = DS(KL,2) + XY*DENSITY
                DS(KL,3) = DS(KL,3) + XZ*DENSITY
                DS(KL,4) = DS(KL,4) + YX*DENSITY
                DS(KL,5) = DS(KL,5) + YY*DENSITY
                DS(KL,6) = DS(KL,6) + YZ*DENSITY
                DS(KL,7) = DS(KL,7) + ZX*DENSITY
                DS(KL,8) = DS(KL,8) + ZY*DENSITY
                DS(KL,9) = DS(KL,9) + ZZ*DENSITY
              ENDIF
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKDXMT1CP
C>
C>    @brief   compute the derivative of X matrix in HESS calculation
C>             (ref: J. Chem. Phys. 155, 204102 (2021).)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   VPR: electrostatic potential induced by solvent molecules
C>             DMT: fitting coefficient
C>             FD: derivative of solvated Fock matrix
C>             GD: derivative of Delta d matrix (eq 15 in the reference)
C>             EG: gradient
C>             EH: Hessian
C>
      SUBROUTINE RSM_MKDXMT1CP(VPR,DMT,FD,GD,EG,EH)
C
      USE RISM_MOD, ONLY : NSHEL0A
      USE RSMSED,   ONLY : NAT, C
      USE ABSMOD,   ONLY : KATM0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, EX0A,
     *                     COF0A, TRN3, TQ, NQMT0A, KTYP0A
C
      IMPLICIT NONE
C
      DOUBLE PRECISION, INTENT(IN   ) :: VPR(*), DMT(*)
      DOUBLE PRECISION, INTENT(  OUT) :: FD(NQMT0A,3,NAT)
      DOUBLE PRECISION, INTENT(INOUT) :: GD(NQMT0A,3,NAT),
     *                                   EG(3,*), EH(9,*)
C
      DOUBLE PRECISION      :: GTMP(196000),DTMP(122500,3)
      DOUBLE PRECISION      :: WRKX(10000),WRKY(10000),WRKZ(10000), 
     *                         D01(36,36,3), D11(36,36,9), D02(36,36,9)
      DOUBLE PRECISION      :: XI, YI, ZI, XJ, YJ, ZJ, XK, YK, ZK, 
     *                         XL, YL, ZL, VALX1, VALX2, VALY1, VALY2, 
     *                         VALZ1, VALZ2, ZETA, ETA, VAL1, VAL2, FAC,
     *                         VAL3, VAL4, RR, CSI, CSK, DIJKL, AI, AJ

      INTEGER :: I, J, K, L, MM, NN, MINI, MAXI, MINJ, MAXJ, MINK, MAXK,
     *           MINL, MAXL, IG, JG, KG, LG, I1, I2, J1, J2, K1, K2, KL,
     *           L1, L2, II, KK, IJ, IAT, KAT, LIT, LJT, MINIM, MAXIP, 
     *           MINJM, MAXJP, MINJMM, MAXJPP, N, LL2, NN2, IIAT
C
      DOUBLE PRECISION, ALLOCATABLE   :: DWRK1(:,:,:), DWRK2(:,:,:), 
     *                                   FWRK(:,:), SWRK(:,:), TRNV(:),
     *                                   WRK1(:), TRND(:)
C
      INTEGER :: MINF(5), MAXF(5)
      DATA MINF/1,2, 5,11,21/
      DATA MAXF/1,4,10,20,35/
C
      LL2 = NSHEL0A*(NSHEL0A+1)/2
      NN2 = NAT*(NAT+1)/2
      ALLOCATE(DWRK1(NSHEL0A,3,NAT),DWRK2(NSHEL0A,3,NAT),FWRK(3,NAT),
     *         SWRK(9,NN2),TRNV(NSHEL0A),TRND(NSHEL0A),WRK1(NSHEL0A))
C
      DO L=1,NSHEL0A
        VAL1 = 0.0D+00
        DO K=1,NQMT0A
          VAL1 = VAL1 + TQ(L,K)*VPR(K)
!         print *,'tq',TQ(L,K),VPR(K)
        ENDDO
        TRNV(L) = VAL1
      ENDDO

      DO L=1,NSHEL0A
        VAL1 = 0.0D+00
        DO K=1,NQMT0A
          VAL1 = VAL1 + TQ(L,K)*DMT(K)
        ENDDO
        TRND(L) = VAL1
      ENDDO
C
      CALL VCLR(DWRK1,1,NSHEL0A*3*NAT)
      CALL VCLR(DWRK2,1,NSHEL0A*3*NAT)
      CALL VCLR(SWRK,1,9*NN2)
      CALL VCLR(FWRK,1,3*NAT)
C
C     ----- I SHELL
C
      DO II = 1,NSHEL0A
        IAT = KATM0A(II)

        LIT = KTYP0A(II)
        XI  = C(1,IAT)
        YI  = C(2,IAT)
        ZI  = C(3,IAT)

        I1  = KSTRT0A(II)
        I2  = I1 + KNG0A(II) - 1

        MINI = KMIN0A(II)
        MAXI = KMAX0A(II)
        MINIM= MINF(MAX(LIT-1,1))
        MAXIP= MAXF(LIT+1)

        LJT = LIT
        XJ  = XI
        YJ  = YI
        ZJ  = ZI

        J1  = I1
        J2  = I2

        MINJ  = MINI
        MAXJ  = MAXI
        MINJM = MINIM
        MAXJP = MAXIP
        MINJMM= MINF(MAX(LJT-2,1))
        MAXJPP= MAXF(LJT+2)
C
C        ----- J SHELL
C
        DO KK = 1,NSHEL0A
          KAT = KATM0A(KK)
          XK  = C(1,KAT)
          YK  = C(2,KAT)
          ZK  = C(3,KAT)

          K1  = KSTRT0A(KK)
          K2  = K1 + KNG0A(KK) - 1

          MINK  = KMIN0A(KK)
          MAXK  = KMAX0A(KK)

          XL   = XK
          YL   = YK
          ZL   = ZK

          L1   = K1
          L2   = K2

          MINL = MINK
          MAXL = MAXK

          RR =((XI-XK)*(XI-XK)+(YI-YK)*(YI-YK)+(ZI-ZK)*(ZI-ZK))

          KL = 0
          DO K=MINK,MAXK
            DO L=MINL,MAXL
              KL = KL + 1
            ENDDO
          ENDDO

          D01 = 0.0D+00
          D11 = 0.0D+00
          D02 = 0.0D+00
          DO IG=I1,I2
            AI = EX0A(IG)
            DO JG=J1,J2
              AJ = EX0A(JG)

              ZETA= AI + AJ
              CSI = COF0A(IG)*COF0A(JG)

              DO KG=K1,K2
                DO LG=L1,L2
                  ETA = EX0A(KG)+EX0A(LG)
                  CSK = COF0A(KG)*COF0A(LG)

                  GTMP = 0.0D+00
                  CALL RSM_OSINT1(.FALSE.,MINIM,MAXIP,MINJMM,MAXJPP,
     *                        MINK,MAXK,MINL,MAXL,
     *                        ZETA,ETA,XI,YI,ZI,XK,YK,ZK,XI,
     *                        YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,1.0D+00,
     *                        1.0D+00,GTMP)
           
                  DIJKL = 2.0D+00*CSI*CSK
                  CALL RSM_OSDER2ACP(AI,AJ,DIJKL,GTMP,
     *                       MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                       MINIM,MAXIP,MINJM,MAXJP,MINJMM,MAXJPP,KL,
     *                       D01,D11,D02)
C
                ENDDO
              ENDDO
            ENDDO
          ENDDO

          FAC  = TRND(II)*TRNV(KK) + TRND(KK)*TRNV(II)

          DO N=1,3
            MM = 0
            VAL2 = 0.0D+00
            DO K=MINK,MAXK
              DO L=MINL,MAXL
                MM = MM + 1

                VAL1 = 0.0D+00
                IJ = 0
                DO I=MINI,MAXI
                  DO J=MINJ,MAXJ
                    IJ = IJ + 1

                    VAL1 = VAL1 + TRN3(J,I)*D01(IJ,MM,N)
                  ENDDO
                ENDDO
                VAL2 = VAL2 + TRN3(L,K)*VAL1
              ENDDO
            ENDDO
            FWRK(N,IAT) = FWRK(N,IAT) + VAL2*FAC

            DWRK1(II,N,IAT) = DWRK1(II,N,IAT) + VAL2*TRNV(KK)
            DWRK1(KK,N,IAT) = DWRK1(KK,N,IAT) + VAL2*TRNV(II)

!           print *,val2,TRNV(II),TRNV(KK)
 
            DWRK2(II,N,IAT) = DWRK2(II,N,IAT) + VAL2*TRND(KK)
            DWRK2(KK,N,IAT) = DWRK2(KK,N,IAT) + VAL2*TRND(II)
          ENDDO


          IIAT = IAT*(IAT-1)/2 + IAT
          DO N=1,9
            MM = 0
            VAL2 = 0.0D+00
            DO K=MINK,MAXK
              DO L=MINL,MAXL
                MM = MM + 1

                VAL1 = 0.0D+00
                IJ = 0
                DO I=MINI,MAXI
                  DO J=MINJ,MAXJ
                    IJ = IJ + 1 
           
                    VAL1 = VAL1 + TRN3(J,I)*D11(IJ,MM,N)
                  ENDDO
                ENDDO
                VAL2 = VAL2 + TRN3(L,K)*VAL1
              ENDDO
            ENDDO
            SWRK(N,IIAT) = SWRK(N,IIAT) + VAL2*FAC

            MM = 0
            VAL2 = 0.0D+00
            DO K=MINK,MAXK
              DO L=MINL,MAXL
                MM = MM + 1

                VAL1 = 0.0D+00
                IJ = 0
                DO I=MINI,MAXI
                  DO J=MINJ,MAXJ
                    IJ = IJ + 1

                    VAL1 = VAL1 + TRN3(J,I)*D02(IJ,MM,N)
                  ENDDO
                ENDDO
                VAL2 = VAL2 + TRN3(L,K)*VAL1
              ENDDO
            ENDDO
            SWRK(N,IIAT) = SWRK(N,IIAT) + VAL2*FAC
          ENDDO


C
C     ----- END OF SHELLS
C
        ENDDO
      ENDDO

      NN = 0
      DO IAT=1,NAT
        DO K=1,3

          WRK1 = 0.0D+00
          DO I=1,NSHEL0A
            WRK1(I) = DWRK1(I,K,IAT)
!            print *,'dwrk1',DWRK1(I,K,IAT)
          ENDDO

          DO I=1,NQMT0A
            VAL1=0.0D+00
            DO L=1,NSHEL0A
              VAL1 = VAL1 + TQ(L,I)*WRK1(L)
            ENDDO
            FD(I,K,IAT) = VAL1
!             print *,'fd',val1
          ENDDO

          WRK1 = 0.0D+00
          DO I=1,NSHEL0A
            WRK1(I) = DWRK2(I,K,IAT)
          ENDDO

          DO I=1,NQMT0A
            VAL1=0.0D+00
            DO L=1,NSHEL0A
              VAL1 = VAL1 + TQ(L,I)*WRK1(L)
            ENDDO
            GD(I,K,IAT) = GD(I,K,IAT) - VAL1
          ENDDO
        ENDDO
      ENDDO
C
C     SYMMETRIZE
C
      DO IAT = 1,NAT
        IIAT = ( IAT * (IAT-1) ) / 2 + IAT
        FAC  = ( SWRK(2,IIAT) + SWRK(4,IIAT) ) / 2.0D+00
        SWRK(2,IIAT) = FAC
        SWRK(4,IIAT) = FAC
        FAC  = ( SWRK(3,IIAT) + SWRK(7,IIAT) ) / 2.0D+00
        SWRK(3,IIAT) = FAC
        SWRK(7,IIAT) = FAC
        FAC  = ( SWRK(6,IIAT) + SWRK(8,IIAT) ) / 2.0D+00
        SWRK(6,IIAT) = FAC
        SWRK(8,IIAT) = FAC
      ENDDO

      DO I=1,NAT
        DO J=1,3
          EG(J,I) = EG(J,I) - FWRK(J,I)
        ENDDO
      ENDDO

      DO I=1,NN2
        DO J=1,9
          EH(J,I) = EH(J,I) - SWRK(J,I)
        ENDDO
      ENDDO

      DEALLOCATE(DWRK1,DWRK2,SWRK,FWRK,WRK1,TRNV,TRND)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_OSDER2ACP
C>
C>    @brief   compute derivatives with Obara-Saika in RSM_MKDXMT1CP
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   AI: the exponent of I shell
C>             AJ: the exponent of J shell
C>             DIJKL: product of normalized factors of ABSs I and K
C>             GTMP: data computed in RSM_OSINT1
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             MINIM: starting counters of the shell, which
C>                    angular momentum is I-1
C>             MAXIP: ending counter of the shell, which
C>                    angular momentum is I+1
C>             MINJM: starting counters of the shell, which
C>                    angular momentum is J-1
C>             MAXJP: ending counter of the shell, which
C>                    angular momentum is J+1
C>             MINJMM: starting counters of the shell, which
C>                    angular momentum is J-2
C>             MAXJPP: ending counter of the shell, which
C>                    angular momentum is J+2
C>             KL: total number of K-L pairs of ABSs
C>             D01: derivatives 
C>             D11: hessian 
C>             D02: hessian
C>
      SUBROUTINE RSM_OSDER2ACP(AI,AJ,DIJKL,GTMP,
     *                       MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                       MINIM,MAXIP,MINJM,MAXJP,MINJMM,MAXJPP,KL,
     *                       D01,D11,D02)
      IMPLICIT NONE
C
      INTEGER,          INTENT(IN   ) :: MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                                   MINL,MAXL,MINIM,MAXIP,
     *                                   MINJM,MAXJP,MINJMM,MAXJPP,KL
      DOUBLE PRECISION, INTENT(IN   ) :: AI, AJ, DIJKL, GTMP(*)
      DOUBLE PRECISION, INTENT(INOUT) :: D01(36,36,*), D11(36,36,*), 
     *                                   D02(36,36,*)

      INTEGER                :: I, J, K, L, IJ, NN, MM, 
     *                          IPX, IPY, IPZ, IMX, IMY, IMZ,
     *                          JPX, JPY, JPZ, JMX, JMY, JMZ
      DOUBLE PRECISION       :: X, Y, Z, RX, RY, RZ, TAI, TAJ,
     *                          XX, YX, ZX, XY, YY, ZY, XZ, YZ, ZZ,
     *                          WRK1(20,20,36), WRK2X(20), WRK2Y(20),
     *                          WRK2Z(20)
C
      INTEGER                :: LP(3,10), LM(3,10)
      DOUBLE PRECISION       :: RIN(3,10)

      DATA LP/ 2, 3, 4, !  S
     *         5, 8, 9, !  X
     *         8, 6,10, !  Y
     *         9,10, 7, !  Z
     *        11,14,15, !  XX
     *        16,12,17, !  YY
     *        18,19,13, !  ZZ
     *        14,16,20, !  XY
     *        15,20,18, !  XZ
     *        20,17,19/ !  YZ
      DATA LM/ 1, 1, 1, !  S
     *         1, 1, 1, !  X
     *         1, 1, 1, !  Y
     *         1, 1, 1, !  Z
     *         2, 1, 1, !  XX
     *         1, 3, 1, !  YY
     *         1, 1, 4, !  ZZ
     *         3, 2, 1, !  XY
     *         4, 1, 2, !  XZ
     *         1, 4, 3/ !  YZ
      DATA RIN/0.0D+00,0.0D+00,0.0D+00, !S
     *         1.0D+00,0.0D+00,0.0D+00, !X
     *         0.0D+00,1.0D+00,0.0D+00, !Y
     *         0.0D+00,0.0D+00,1.0D+00, !Z
     *         2.0D+00,0.0D+00,0.0D+00, !XX
     *         0.0D+00,2.0D+00,0.0D+00, !YY
     *         0.0D+00,0.0D+00,2.0D+00, !ZZ
     *         1.0D+00,1.0D+00,0.0D+00, !XY
     *         1.0D+00,0.0D+00,1.0D+00, !XZ
     *         0.0D+00,1.0D+00,1.0D+00/ !YZ
C
      TAI = AI + AI
      TAJ = AJ + AJ

      NN = 0
      DO I=MINIM,MAXIP
        DO J=MINJMM,MAXJPP
          MM = 0
          DO K=MINK,MAXK
            DO L=MINL,MAXL
              NN = NN + 1
              MM = MM + 1

              WRK1(J,I,MM) = GTMP(NN)
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
C     (I,J')
C
      DO K=1,KL
        IJ = 0
        DO I=MINI,MAXI
          DO J=MINJ,MAXJ
            IJ = IJ + 1

            JPX = LP(1,J)
            JPY = LP(2,J)
            JPZ = LP(3,J)

            JMX = LM(1,J)
            JMY = LM(2,J)
            JMZ = LM(3,J)

            RX  = RIN(1,J)
            RY  = RIN(2,J)
            RZ  = RIN(3,J)

            X = TAJ*WRK1(JPX,I,K) - RX*WRK1(JMX,I,K)
            Y = TAJ*WRK1(JPY,I,K) - RY*WRK1(JMY,I,K)
            Z = TAJ*WRK1(JPZ,I,K) - RZ*WRK1(JMZ,I,K)

            D01(IJ,K,1) = D01(IJ,K,1) + X*DIJKL
            D01(IJ,K,2) = D01(IJ,K,2) + Y*DIJKL
            D01(IJ,K,3) = D01(IJ,K,3) + Z*DIJKL
          ENDDO
        ENDDO
C
C     (I',J')
C
        IJ = 0
        DO I=MINI,MAXI
          IPX = LP(1,I)
          IPY = LP(2,I)
          IPZ = LP(3,I)

          IMX = LM(1,I)
          IMY = LM(2,I)
          IMZ = LM(3,I)

          RX  = RIN(1,I)
          RY  = RIN(2,I)
          RZ  = RIN(3,I)

          DO J=MINJM,MAXJP
            WRK2X(J) = TAI*WRK1(J,IPX,K) - RX*WRK1(J,IMX,K)
            WRK2Y(J) = TAI*WRK1(J,IPY,K) - RY*WRK1(J,IMY,K)
            WRK2Z(J) = TAI*WRK1(J,IPZ,K) - RZ*WRK1(J,IMZ,K)
          ENDDO

          DO J=MINJ,MAXJ
            IJ = IJ + 1

            JPX = LP(1,J)
            JPY = LP(2,J)
            JPZ = LP(3,J)

            JMX = LM(1,J)
            JMY = LM(2,J)
            JMZ = LM(3,J)

            RX  = RIN(1,J)
            RY  = RIN(2,J)
            RZ  = RIN(3,J)

            XX = TAJ*WRK2X(JPX) - RX*WRK2X(JMX)
            XY = TAJ*WRK2X(JPY) - RY*WRK2X(JMY)
            XZ = TAJ*WRK2X(JPZ) - RZ*WRK2X(JMZ)

            YX = TAJ*WRK2Y(JPX) - RX*WRK2Y(JMX)
            YY = TAJ*WRK2Y(JPY) - RY*WRK2Y(JMY)
            YZ = TAJ*WRK2Y(JPZ) - RZ*WRK2Y(JMZ)

            ZX = TAJ*WRK2Z(JPX) - RX*WRK2Z(JMX)
            ZY = TAJ*WRK2Z(JPY) - RY*WRK2Z(JMY)
            ZZ = TAJ*WRK2Z(JPZ) - RZ*WRK2Z(JMZ)

            D11(IJ,K,1) = D11(IJ,K,1) + XX*DIJKL
            D11(IJ,K,2) = D11(IJ,K,2) + YX*DIJKL
            D11(IJ,K,3) = D11(IJ,K,3) + ZX*DIJKL
            D11(IJ,K,4) = D11(IJ,K,4) + XY*DIJKL
            D11(IJ,K,5) = D11(IJ,K,5) + YY*DIJKL
            D11(IJ,K,6) = D11(IJ,K,6) + ZY*DIJKL
            D11(IJ,K,7) = D11(IJ,K,7) + XZ*DIJKL
            D11(IJ,K,8) = D11(IJ,K,8) + YZ*DIJKL
            D11(IJ,K,9) = D11(IJ,K,9) + ZZ*DIJKL
          ENDDO
        ENDDO
C
C     (I,J'')
C
        IJ = 0
        DO I=MINI,MAXI
          DO J=MINJM,MAXJP
            JPX = LP(1,J)
            JPY = LP(2,J)
            JPZ = LP(3,J)

            JMX = LM(1,J)
            JMY = LM(2,J)
            JMZ = LM(3,J)

            RX  = RIN(1,J)
            RY  = RIN(2,J)
            RZ  = RIN(3,J)

            WRK2X(J) = TAJ*WRK1(JPX,I,K) - RX*WRK1(JMX,I,K)
            WRK2Y(J) = TAJ*WRK1(JPY,I,K) - RY*WRK1(JMY,I,K)
            WRK2Z(J) = TAJ*WRK1(JPZ,I,K) - RZ*WRK1(JMZ,I,K)
          ENDDO

          DO J=MINJ,MAXJ
            IJ = IJ + 1

            JPX = LP(1,J)
            JPY = LP(2,J)
            JPZ = LP(3,J)

            JMX = LM(1,J)
            JMY = LM(2,J)
            JMZ = LM(3,J)

            RX  = RIN(1,J)
            RY  = RIN(2,J)
            RZ  = RIN(3,J)

            XX = TAJ*WRK2X(JPX) - RX*WRK2X(JMX)
            XY = TAJ*WRK2X(JPY) - RY*WRK2X(JMY)
            XZ = TAJ*WRK2X(JPZ) - RZ*WRK2X(JMZ)

            YX = TAJ*WRK2Y(JPX) - RX*WRK2Y(JMX)
            YY = TAJ*WRK2Y(JPY) - RY*WRK2Y(JMY)
            YZ = TAJ*WRK2Y(JPZ) - RZ*WRK2Y(JMZ)

            ZX = TAJ*WRK2Z(JPX) - RX*WRK2Z(JMX)
            ZY = TAJ*WRK2Z(JPY) - RY*WRK2Z(JMY)
            ZZ = TAJ*WRK2Z(JPZ) - RZ*WRK2Z(JMZ)

            D02(IJ,K,1) = D02(IJ,K,1) + XX*DIJKL
            D02(IJ,K,2) = D02(IJ,K,2) + YX*DIJKL
            D02(IJ,K,3) = D02(IJ,K,3) + ZX*DIJKL
            D02(IJ,K,4) = D02(IJ,K,4) + XY*DIJKL
            D02(IJ,K,5) = D02(IJ,K,5) + YY*DIJKL
            D02(IJ,K,6) = D02(IJ,K,6) + ZY*DIJKL
            D02(IJ,K,7) = D02(IJ,K,7) + XZ*DIJKL
            D02(IJ,K,8) = D02(IJ,K,8) + YZ*DIJKL
            D02(IJ,K,9) = D02(IJ,K,9) + ZZ*DIJKL
          ENDDO
        ENDDO
      ENDDO

C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKDXMT2CP
C>
C>    @brief   compute the HESSIAN of X matrix in HESS calculation
C>             (ref: J. Chem. Phys. 155, 204102 (2021).)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   VPR: electrostatic potential induced by solvent molecules
C>             DMT: fitting coefficient
C>             EH: Hessian
C>
      SUBROUTINE RSM_MKDXMT2CP(VPR,DMT,EH)
C
      USE RISM_MOD, ONLY : NSHEL0A
      USE RSMSED,   ONLY : NAT, C
      USE ABSMOD,   ONLY : KATM0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, EX0A,
     *                     COF0A, TRN3, TQ, NQMT0A, KTYP0A
C
      IMPLICIT NONE
C
      DOUBLE PRECISION, INTENT(IN   ) :: VPR(*), DMT(*)
      DOUBLE PRECISION, INTENT(INOUT) :: EH(9,*)
C
      DOUBLE PRECISION :: GTMP(196000),DTMP(122500,3)
      DOUBLE PRECISION :: WRKX(10000),WRKY(10000),WRKZ(10000), 
     *          D11(36,36,9)
      DOUBLE PRECISION :: XI,YI,ZI, XJ,YJ,ZJ, XK,YK,ZK, XL,YL,ZL,
     *                    VALX1,VALX2, VALY1,VALY2, VALZ1,VALZ2,
     *                    ZETA, ETA, VAL1,VAL2,VAL3, RR, CSI, CSK, 
     *                    DIJKL, AI, AK, FAC

      LOGICAL :: IGTK
      INTEGER :: I, J, K, L, MM, NN, MINI, MAXI, MINJ, MAXJ, MINK, MAXK,
     *           MINL, MAXL, IG, JG, KG, LG, I1, I2, J1, J2, K1, K2, KL,
     *           L1, L2, II, KK, IJ, IAT, KAT, LIT, LKT, MINIM, MAXIP, 
     *           MINKM, MAXKP, IFDX, IFDY, IFDZ, N, LL2, NN2, IKAT
C
      DOUBLE PRECISION, ALLOCATABLE ::SWRK(:,:), TRNV(:), TRND(:)
C
      INTEGER :: MINF(5), MAXF(5)
      DATA MINF/1,2, 5,11,21/
      DATA MAXF/1,4,10,20,35/
C
      LL2 = NSHEL0A*(NSHEL0A+1)/2
      NN2 = NAT*(NAT+1)/2
      ALLOCATE(SWRK(9,NN2),TRNV(NSHEL0A),TRND(NSHEL0A))
C
      DO L=1,NSHEL0A
        VAL1 = 0.0D+00
        DO K=1,NQMT0A
          VAL1 = VAL1 + TQ(L,K)*VPR(K)
        ENDDO
        TRNV(L) = VAL1
      ENDDO

      DO L=1,NSHEL0A
        VAL1 = 0.0D+00
        DO K=1,NQMT0A
          VAL1 = VAL1 + TQ(L,K)*DMT(K)
        ENDDO
        TRND(L) = VAL1
      ENDDO
C
      CALL VCLR(SWRK,1,9*    NN2)
C
C     ----- I SHELL
C
      DO II = 1,NSHEL0A
        IAT = KATM0A(II)
        IFDX  = 3*LL2*(IAT-1)
        IFDY  = IFDX + LL2
        IFDZ  = IFDY + LL2

        LIT = KTYP0A(II)
        XI  = C(1,IAT)
        YI  = C(2,IAT)
        ZI  = C(3,IAT)

        I1  = KSTRT0A(II)
        I2  = I1 + KNG0A(II) - 1

        MINI = KMIN0A(II)
        MAXI = KMAX0A(II)
        MINIM= MINF(MAX(LIT-1,1))
        MAXIP= MAXF(LIT+1)

        XJ  = XI
        YJ  = YI
        ZJ  = ZI

        J1  = I1
        J2  = I2

        MINJ  = MINI
        MAXJ  = MAXI
C
C        ----- J SHELL
C
        DO KK = 1,NSHEL0A
          KAT = KATM0A(KK)
          LKT = KTYP0A(KK)
          XK  = C(1,KAT)
          YK  = C(2,KAT)
          ZK  = C(3,KAT)

          K1  = KSTRT0A(KK)
          K2  = K1 + KNG0A(KK) - 1

          MINK  = KMIN0A(KK)
          MAXK  = KMAX0A(KK)
          MINKM = MINF(MAX(LKT-1,1))
          MAXKP = MAXF(LKT+1)

          XL   = XK
          YL   = YK
          ZL   = ZK

          L1   = K1
          L2   = K2

          MINL = MINK
          MAXL = MAXK

          RR =((XI-XK)*(XI-XK)+(YI-YK)*(YI-YK)+(ZI-ZK)*(ZI-ZK))

          IGTK = IAT > KAT

          KL = 0
          DO K=MINK,MAXK
            DO L=MINL,MAXL
              KL = KL + 1
            ENDDO
          ENDDO

          D11 = 0.0D+00
          DO IG=I1,I2
            AI = EX0A(IG)
            DO JG=J1,J2
              ZETA= AI + EX0A(JG)
              CSI = COF0A(IG)*COF0A(JG)

              DO KG=K1,K2
                AK = EX0A(KG)
                DO LG=L1,L2
                  ETA = AK+EX0A(LG)
                  CSK = COF0A(KG)*COF0A(LG)

                  GTMP = 0.0D+00
                  CALL RSM_OSINT1(.FALSE.,MINIM,MAXIP,MINJ,MAXJ,
     *                        MINKM,MAXKP,MINL,MAXL,
     *                        ZETA,ETA,XI,YI,ZI,XK,YK,ZK,XI,
     *                        YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,1.0D+00,
     *                        1.0D+00,GTMP)
           
                  DIJKL = 4.0D+00*CSI*CSK
                  CALL RSM_OSDER2BCP(IGTK,AI,AK,DIJKL,GTMP,
     *                       MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                       MINIM,MAXIP,MINKM,MAXKP,
     *                       D11)
C
                ENDDO
              ENDDO
            ENDDO
          ENDDO
C
          IF(KAT > IAT) THEN
            IKAT = KAT*(KAT-1)/2 + IAT
          ELSE
            IKAT = IAT*(IAT-1)/2 + KAT
          ENDIF

          FAC  = TRNV(KK)*TRND(II)
          IF(IAT == KAT) FAC = FAC + FAC

          DO N=1,9
            MM = 0
            VAL2 = 0.0D+00
            DO K=MINK,MAXK
              DO L=MINL,MAXL
                MM = MM + 1

                VAL1 = 0.0D+00
                IJ = 0
                DO I=MINI,MAXI
                  DO J=MINJ,MAXJ
                    IJ = IJ + 1 
           
                    VAL1 = VAL1 + TRN3(J,I)*D11(IJ,MM,N)
                  ENDDO
                ENDDO
                VAL2 = VAL2 + TRN3(L,K)*VAL1
              ENDDO
            ENDDO
            SWRK(N,IKAT) = SWRK(N,IKAT) + VAL2*FAC
          ENDDO
C
C     ----- END OF SHELLS
C
        ENDDO
      ENDDO
C
C     SYMMETRIZE
C
      DO IAT = 1,NAT
        IKAT = ( IAT * (IAT-1) ) / 2 + IAT
        FAC  = ( SWRK(2,IKAT) + SWRK(4,IKAT) ) / 2.0D+00
        SWRK(2,IKAT) = FAC
        SWRK(4,IKAT) = FAC
        FAC  = ( SWRK(3,IKAT) + SWRK(7,IKAT) ) / 2.0D+00
        SWRK(3,IKAT) = FAC
        SWRK(7,IKAT) = FAC
        FAC  = ( SWRK(6,IKAT) + SWRK(8,IKAT) ) / 2.0D+00
        SWRK(6,IKAT) = FAC
        SWRK(8,IKAT) = FAC
      ENDDO

      DO I=1,NN2
        DO J=1,9
          EH(J,I) = EH(J,I) - SWRK(J,I)
        ENDDO
      ENDDO

      DEALLOCATE(SWRK,TRNV,TRND)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_OSDER2BCP
C>
C>    @brief   compute derivatives with Obara-Saika in RSM_MKDXMT2CP
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   IGTK: IAT is greater than KAT, or not
C>             AI: the exponent of I shell
C>             AK: the exponent of K shell
C>             DIJKL: product of normalized factors of ABSs I and K
C>             GTMP: data computed in RSM_OSINT1
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             MINIM: starting counters of the shell, which
C>                    angular momentum is I-1
C>             MAXIP: ending counter of the shell, which
C>                    angular momentum is I+1
C>             MINKM: starting counters of the shell, which
C>                    angular momentum is K-1
C>             MAXKP: ending counter of the shell, which
C>                    angular momentum is K+1
C>             D11: hessian
C>
      SUBROUTINE RSM_OSDER2BCP(IGTK,AI,AK,DIJKL,GTMP,
     *                       MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                       MINIM,MAXIP,MINKM,MAXKP,
     *                       D11)
      IMPLICIT NONE
C
      LOGICAL,          INTENT(IN   ) :: IGTK
      INTEGER,          INTENT(IN   ) :: MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                                   MINL,MAXL, MINIM,MAXIP,MINKM,
     *                                   MAXKP
      DOUBLE PRECISION, INTENT(IN   ) :: AI, AK, DIJKL, GTMP(*)
      DOUBLE PRECISION, INTENT(INOUT) :: D11(36,36,*)

      INTEGER                :: I, J, K, L, IJ, KL, NN, MM, 
     *                          IPX, IPY, IPZ, IMX, IMY, IMZ,
     *                          KPX, KPY, KPZ, KMX, KMY, KMZ
      DOUBLE PRECISION       :: X, Y, Z, RX, RY, RZ, TAI, TAK,
     *                          XX, YX, ZX, XY, YY, ZY, XZ, YZ, ZZ,
     *                          WRK1(20,20,10,10), WRK2X(20), WRK2Y(20),
     *                          WRK2Z(20)
C
      INTEGER                :: LP(3,10), LM(3,10)
      DOUBLE PRECISION       :: RIN(3,10)

      DATA LP/ 2, 3, 4, !  S
     *         5, 8, 9, !  X
     *         8, 6,10, !  Y
     *         9,10, 7, !  Z
     *        11,14,15, !  XX
     *        16,12,17, !  YY
     *        18,19,13, !  ZZ
     *        14,16,20, !  XY
     *        15,20,18, !  XZ
     *        20,17,19/ !  YZ
      DATA LM/ 1, 1, 1, !  S
     *         1, 1, 1, !  X
     *         1, 1, 1, !  Y
     *         1, 1, 1, !  Z
     *         2, 1, 1, !  XX
     *         1, 3, 1, !  YY
     *         1, 1, 4, !  ZZ
     *         3, 2, 1, !  XY
     *         4, 1, 2, !  XZ
     *         1, 4, 3/ !  YZ
      DATA RIN/0.0D+00,0.0D+00,0.0D+00, !S
     *         1.0D+00,0.0D+00,0.0D+00, !X
     *         0.0D+00,1.0D+00,0.0D+00, !Y
     *         0.0D+00,0.0D+00,1.0D+00, !Z
     *         2.0D+00,0.0D+00,0.0D+00, !XX
     *         0.0D+00,2.0D+00,0.0D+00, !YY
     *         0.0D+00,0.0D+00,2.0D+00, !ZZ
     *         1.0D+00,1.0D+00,0.0D+00, !XY
     *         1.0D+00,0.0D+00,1.0D+00, !XZ
     *         0.0D+00,1.0D+00,1.0D+00/ !YZ
C
      TAI = AI + AI
      TAK = AK + AK 

      NN = 0
      DO I=MINIM,MAXIP
        DO J=MINJ,MAXJ
          DO K=MINKM,MAXKP
            DO L=MINL,MAXL
              NN = NN + 1

              WRK1(K,I,L,J) = GTMP(NN)
            ENDDO
          ENDDO
        ENDDO
      ENDDO
C
C     (I',J')
C
      DO J=MINJ,MAXJ
        DO L=MINL,MAXL
          DO I=MINI,MAXI
            IJ = (MAXJ - MINJ + 1)*(I-MINI) + J - MINJ + 1

            IPX = LP(1,I)
            IPY = LP(2,I)
            IPZ = LP(3,I)

            IMX = LM(1,I)
            IMY = LM(2,I)
            IMZ = LM(3,I)

            RX  = RIN(1,I)
            RY  = RIN(2,I)
            RZ  = RIN(3,I)

            DO K=MINKM,MAXKP
              WRK2X(K) = TAI*WRK1(K,IPX,L,J) - RX*WRK1(K,IMX,L,J)
              WRK2Y(K) = TAI*WRK1(K,IPY,L,J) - RY*WRK1(K,IMY,L,J)
              WRK2Z(K) = TAI*WRK1(K,IPZ,L,J) - RZ*WRK1(K,IMZ,L,J)
            ENDDO

            DO K=MINK,MAXK
              KL = (MAXL - MINL + 1)*(K-MINK) + L - MINL + 1

              KPX = LP(1,K)
              KPY = LP(2,K)
              KPZ = LP(3,K)

              KMX = LM(1,K)
              KMY = LM(2,K)
              KMZ = LM(3,K)

              RX  = RIN(1,K)
              RY  = RIN(2,K)
              RZ  = RIN(3,K)             
C
C             (I,K) 
C
              XX = TAK*WRK2X(KPX) - RX*WRK2X(KMX)
              XY = TAK*WRK2X(KPY) - RY*WRK2X(KMY)
              XZ = TAK*WRK2X(KPZ) - RZ*WRK2X(KMZ)

              YX = TAK*WRK2Y(KPX) - RX*WRK2Y(KMX)
              YY = TAK*WRK2Y(KPY) - RY*WRK2Y(KMY)
              YZ = TAK*WRK2Y(KPZ) - RZ*WRK2Y(KMZ)

              ZX = TAK*WRK2Z(KPX) - RX*WRK2Z(KMX)
              ZY = TAK*WRK2Z(KPY) - RY*WRK2Z(KMY)
              ZZ = TAK*WRK2Z(KPZ) - RZ*WRK2Z(KMZ)
C
C             (I > K)
C
              IF(.NOT.IGTK) THEN
                D11(IJ,KL,1) = D11(IJ,KL,1) + XX*DIJKL
                D11(IJ,KL,2) = D11(IJ,KL,2) + YX*DIJKL
                D11(IJ,KL,3) = D11(IJ,KL,3) + ZX*DIJKL
                D11(IJ,KL,4) = D11(IJ,KL,4) + XY*DIJKL
                D11(IJ,KL,5) = D11(IJ,KL,5) + YY*DIJKL
                D11(IJ,KL,6) = D11(IJ,KL,6) + ZY*DIJKL
                D11(IJ,KL,7) = D11(IJ,KL,7) + XZ*DIJKL
                D11(IJ,KL,8) = D11(IJ,KL,8) + YZ*DIJKL
                D11(IJ,KL,9) = D11(IJ,KL,9) + ZZ*DIJKL
              ELSE
                D11(IJ,KL,1) = D11(IJ,KL,1) + XX*DIJKL
                D11(IJ,KL,2) = D11(IJ,KL,2) + XY*DIJKL
                D11(IJ,KL,3) = D11(IJ,KL,3) + XZ*DIJKL
                D11(IJ,KL,4) = D11(IJ,KL,4) + YX*DIJKL
                D11(IJ,KL,5) = D11(IJ,KL,5) + YY*DIJKL
                D11(IJ,KL,6) = D11(IJ,KL,6) + YZ*DIJKL
                D11(IJ,KL,7) = D11(IJ,KL,7) + ZX*DIJKL
                D11(IJ,KL,8) = D11(IJ,KL,8) + ZY*DIJKL
                D11(IJ,KL,9) = D11(IJ,KL,9) + ZZ*DIJKL
              ENDIF
            ENDDO
          ENDDO
        ENDDO
      ENDDO

C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_MKDYMT1CP
C>
C>    @brief   compute the derivative of Y matrix in HESS calculation
C>             (ref: J. Chem. Phys. 155, 204102 (2021).)
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   VPR: electrostatic potential induced by solvent molecules
C>             PA: density matrix
C>             FD: derivative of solvated Fock matrix 
C>             GD: derivative of Delta d matrix (eq 15 in the reference)
C>             EG: gradient
C>             EH: Hessian
C>

      SUBROUTINE RSM_MKDYMT1CP(VPR,PA,FD,GD,EG,EH)
C
      USE RISM_MOD, ONLY : RSM_ISTIEND, GOPARR, NSHEL0A
      USE RSMSED,   ONLY : NUM, C, NAT
      USE RSM_BSMOD,ONLY : NSHELL,KSTART,KATOM,KTYPE,KNG,KLOC,KMIN,KMAX,
     *                     EX,CS,CP,CD,CF,CG,NORM
      USE ABSMOD,   ONLY : KATM0A, KSTRT0A, KNG0A, KMIN0A, KMAX0A, EX0A,
     *                     COF0A, TRN3, NQMT0A, TQ
C
      IMPLICIT NONE
C
      DOUBLE PRECISION, INTENT(IN   ) :: VPR(*), PA(*)
      DOUBLE PRECISION, INTENT(INOUT) :: FD(*),GD(NQMT0A,3,NAT),
     *                                   EG(3,*),EH(9,*)
C
      DOUBLE PRECISION     :: DIJ(225), WRK3 (9,2), WRK4(3),
     *                        WRK2X(225   ),WRK2Y(225   ),WRK2Z(225   ),
     *                        D01X (225,36),D01Y (225,36),D01Z (225,36),
     *                        DSTMP(36,9,2),DFTMP(36,3),DF(3),DS(9,2)
C
      DOUBLE PRECISION, ALLOCATABLE   :: GTMP(:),DWRK(:),TRNV(:),
     *                                   SWRK(:,:),FWRK(:,:),DG(:,:,:)
C
      LOGICAL              :: JGTI
C
      DOUBLE PRECISION, PARAMETER     :: SQRT3=1.73205080756888D+00,
     *                                   SQRT5=2.23606797749979D+00, 
     *                                   SQRT7=2.64575131106459D+00
C
      INTEGER              :: MINF(5), MAXF(5)
      DATA MINF/1,2, 5,11,21/
      DATA MAXF/1,4,10,20,35/
C
      INTEGER              :: LL2, NN, NN2, ISTRT, IEND, NSHTT, NIJ,
     *                        I, J, IJ, K, L, KL, IG, JG, KG, LG, 
     *                        IN, JN, IIAT, JJAT, IJAT, MINIM, MAXIP,
     *                        JFDX, JFDY, JFDZ, MINJM, MAXJP, MINJMM,
     *                        MAXJPP,
     *                        II, IAT, LIT, I1, I2, MINI, MAXI, LOCI,
     *                        JJ, JAT, LJT, J1, J2, MINJ, MAXJ, LOCJ,
     *                        KK, K1, K2, MINK, MAXK, L1, L2, MINL, MAXL
      DOUBLE PRECISION     :: VAL, SAB, DUM, DUM1, DUM2, RR, ARRI,
     *                        XI, YI, ZI, XJ, YJ, ZJ, PX, PY, PZ,
     *                        XK, YK, ZK, XL, YL, ZL, AXI, AYI, AZI,
     *                        CSI, CPI, CDI, CFI, CGI, AI, ZETA, ZETA1,
     *                        CSJ, CPJ, CDJ, CFJ, CGJ, AJ, ETA,
     *                        CSK, DKL, TRNFC, FAC
C
      LL2 = NUM*(NUM+1)/2
      NN2 = NAT*(NAT+1)/2
      ALLOCATE(GTMP(310*NSHEL0A),TRNV(NSHEL0A),DWRK(3*NAT*LL2),
     *         SWRK(9,NN2),FWRK(3,NAT),DG(NSHEL0A,3,NAT))
C
      CALL RSM_ISTIEND(NSHEL0A,ISTRT,IEND,NSHTT)

      CALL VCLR(DWRK ,1,3*NAT*LL2)
      CALL VCLR(SWRK ,1,9*    NN2)
      CALL VCLR(FWRK ,1,3*    NAT)
      CALL VCLR(DG   ,1,3*NAT*NSHEL0A)
C
      DO L=1,NSHEL0A
        VAL = 0.0D+00
        DO K=1,NQMT0A
          VAL = VAL + TQ(L,K)*VPR(K)
        ENDDO
        TRNV(L) = VAL
      ENDDO
C
C     ---- I SHELL -----
C
      DO II = 1,NSHELL
        IAT  = KATOM(II)
        LIT  = KTYPE(II)

        XI   = C(1,IAT)   
        YI   = C(2,IAT)
        ZI   = C(3,IAT)
        I1   = KSTART(II)
        I2   = I1+KNG(II)-1
        MINI = KMIN(II)
        MAXI = KMAX(II)
        MINIM= MINF(MAX(LIT-1,1))
        MAXIP= MAXF(LIT+1)
        LOCI = KLOC(II)-MINI
C
C     ----- J SHELL -----
C
        DO JJ = 1,NSHELL
          JAT   = KATOM(JJ)
          LJT   = KTYPE(JJ)
          JFDX  = 3*LL2*(JAT-1)
          JFDY  = JFDX + LL2
          JFDZ  = JFDY + LL2

          XJ    = C(1,JAT)   
          YJ    = C(2,JAT)
          ZJ    = C(3,JAT)
          J1    = KSTART(JJ)
          J2    = J1+KNG(JJ)-1
          MINJ  = KMIN(JJ)
          MAXJ  = KMAX(JJ)
          MINJM = MINF(MAX(LJT-1,1))
          MAXJP = MAXF(LJT+1)
          MINJMM= MINF(MAX(LJT-2,1))
          MAXJPP= MAXF(LJT+2)
          LOCJ  = KLOC(JJ)-MINJ

          JGTI  = JAT .GT. IAT

          RR = (XI-XJ)**2+(YI-YJ)**2+(ZI-ZJ)**2
C
C         ----- K SHELL
C
          DS = 0.0D+00
          DF = 0.0D+00
          DO KK=ISTRT,IEND
            K    = KATM0A(KK)
            XK   = C(1,K)
            YK   = C(2,K)
            ZK   = C(3,K)
            MINK = KMIN0A(KK)
            MAXK = KMAX0A(KK)

            XL   = XK
            YL   = YK
            ZL   = ZK
            MINL = MINK
            MAXL = MAXK

            K1   = KSTRT0A(KK)
            K2   = K1 + KNG0A(KK) - 1

            L1   = K1
            L2   = K2
C
C           ----- I PRIMITIVE
C
            D01X = 0.0D+00
            D01Y = 0.0D+00
            D01Z = 0.0D+00

            DFTMP = 0.0D+00
            DSTMP = 0.0D+00
            DO IG = I1,I2
              AI   = EX(IG)
              ARRI = AI*RR
              AXI  = AI*XI
              AYI  = AI*YI
              AZI  = AI*ZI
              CSI  = CS(IG)
              CPI  = CP(IG)
              CDI  = CD(IG)
              CFI  = CF(IG)
              CGI  = CG(IG)
C
C           ----- J PRIMITIVE
C
              DO JG = J1,J2
                AJ    = EX(JG)
                ZETA  = AI+AJ
                ZETA1 = 1.0D+00/ZETA
                DUM   = AJ*ARRI*ZETA1
                SAB   = EXP(-DUM)
                CSJ   = CS(JG)
                CPJ   = CP(JG)
                CDJ   = CD(JG)
                CFJ   = CF(JG)
                CGJ   = CG(JG)
                PX    = (AXI+AJ*XJ)*ZETA1
                PY    = (AYI+AJ*YJ)*ZETA1
                PZ    = (AZI+AJ*ZJ)*ZETA1
C
C     ----- DENSITY FACTOR
C
                IJ = 0
                DUM1 = 0.0D+00
                DUM2 = 0.0D+00
                DO I = MINI,MAXI
                  IF (I.EQ.1) DUM1=CSI
                  IF (I.EQ.2) DUM1=CPI
                  IF (I.EQ.5) DUM1=CDI
                  IF ((I.EQ. 8).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.11) DUM1=CFI
                  IF ((I.EQ.14).AND.NORM) DUM1=DUM1*SQRT5
                  IF ((I.EQ.20).AND.NORM) DUM1=DUM1*SQRT3
                  IF (I.EQ.21) DUM1=CGI
                  IF ((I.EQ.24).AND.NORM) DUM1=DUM1*SQRT7
                  IF ((I.EQ.30).AND.NORM) DUM1=DUM1*SQRT5/SQRT3
                  IF ((I.EQ.33).AND.NORM) DUM1=DUM1*SQRT3
                  DO J = MINJ,MAXJ
                    IF (J.EQ.1) THEN
                      DUM2=DUM1*CSJ
                    ELSE IF (J.EQ.2) THEN
                      DUM2=DUM1*CPJ
                    ELSE IF (J.EQ.5) THEN
                      DUM2=DUM1*CDJ
                    ELSE IF ((J.EQ.8).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.11) THEN
                      DUM2=DUM1*CFJ
                    ELSE IF ((J.EQ.14).AND.NORM) THEN
                      DUM2=DUM2*SQRT5
                    ELSE IF ((J.EQ.20).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    ELSE IF (J.EQ.21) THEN
                      DUM2=DUM1*CGJ
                    ELSE IF ((J.EQ.24).AND.NORM) THEN
                      DUM2=DUM2*SQRT7
                    ELSE IF ((J.EQ.30).AND.NORM) THEN
                      DUM2=DUM2*SQRT5/SQRT3
                    ELSE IF ((J.EQ.33).AND.NORM) THEN
                      DUM2=DUM2*SQRT3
                    END IF
                    IJ = IJ + 1
                    DIJ(IJ) = DUM2
                  ENDDO
                ENDDO

                KL = 0
                DO K=MINK,MAXK
                  DO L=MINL,MAXL
                    KL = KL + 1
                  ENDDO
                ENDDO

                DO KG=K1,K2
                  DO LG=L1,L2
                    ETA = EX0A(KG) + EX0A(LG)
                    CSK = COF0A(KG) * COF0A(LG)

                    DKL = CSK

                    GTMP = 0.0D+00

                    CALL RSM_OSINT1(.FALSE.,MINIM,MAXIP,MINJMM,MAXJPP,
     *                          MINK,MAXK,
     *                          MINL,MAXL,ZETA,ETA,PX,PY,PZ,XK,YK,ZK,XI,
     *                          YI,ZI,XJ,YJ,ZJ,XK,YK,ZK,XL,YL,ZL,SAB,
     *                          1.0D+00,GTMP)

!                   print *,II,JJ,KK
                    CALL RSM_OSDER1ACP(JGTI,AI,AJ,PA,DIJ,DKL,GTMP,
     *                        MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                        MINIM,MAXIP,MINJM,MAXJP,MINJMM,MAXJPP,
     *                        LOCI,LOCJ,KL,
     *                        D01X,D01Y,D01Z,DFTMP,DSTMP)
C
C                   ----- END OF PRIMITIVES
C
                  ENDDO
                ENDDO
              ENDDO
            ENDDO

            WRK2X = 0.0D+00
            WRK2Y = 0.0D+00
            WRK2Z = 0.0D+00
            WRK3  = 0.0D+00
            WRK4  = 0.0D+00
            KL = 0
            DO K=MINK,MAXK
              DO L=MINL,MAXL
                KL = KL + 1

                TRNFC = TRN3(L,K)
                DO I=1,IJ
                  WRK2X(I) = WRK2X(I) + TRNFC*D01X(I,KL)
                  WRK2Y(I) = WRK2Y(I) + TRNFC*D01Y(I,KL)
                  WRK2Z(I) = WRK2Z(I) + TRNFC*D01Z(I,KL)
                ENDDO

                DO I=1,2
                  DO J=1,9
                    WRK3(J,I) = WRK3(J,I) + TRNFC*DSTMP(KL,J,I)
!                     print *,j,i,DSTMP(KL,J,I)
                  ENDDO
                ENDDO

                DO I=1,3
                  WRK4(I) = WRK4(I) + TRNFC*DFTMP(KL,I)
                ENDDO
              ENDDO
            ENDDO

            NN = 0
            DO I=MINI,MAXI
              IN = LOCI + I
              DO J=MINJ,MAXJ
                JN = LOCJ + J
                NN = NN + 1

                IF(IN < JN) THEN
                  NIJ = JN * (JN-1)/2 + IN
                ELSE
                  NIJ = IN * (IN-1)/2 + JN
                ENDIF

                FAC = TRNV(KK)
                IF(IN == JN) FAC = FAC + FAC

                DWRK(JFDX+NIJ) = DWRK(JFDX+NIJ) + WRK2X(NN)*FAC
                DWRK(JFDY+NIJ) = DWRK(JFDY+NIJ) + WRK2Y(NN)*FAC
                DWRK(JFDZ+NIJ) = DWRK(JFDZ+NIJ) + WRK2Z(NN)*FAC
              ENDDO
            ENDDO

            DO I=1,2
              DO J=1,9
                DS(J,I) = DS(J,I) + WRK3(J,I)*TRNV(KK)
              ENDDO
            ENDDO

!           print *,ds(1,1),ds(1,2)

            DO I=1,3
              DF(I) = DF(I) + WRK4(I)*TRNV(KK)
              DG(KK,I,JAT) = DG(KK,I,JAT) + WRK4(I)
            ENDDO
          ENDDO
C
C         END OF K SHELL
C
          FAC = 1.0D+00
          IF(IAT .EQ. JAT) FAC = 2.0D+00

          IF(JAT <= IAT) THEN
            JJAT = JAT*(JAT-1)/2 + JAT
            IJAT = IAT*(IAT-1)/2 + JAT
          ELSE
            JJAT = JAT*(JAT-1)/2 + JAT
            IJAT = JAT*(JAT-1)/2 + IAT
          ENDIF

          DO I = 1,3
            FWRK(I,JAT) = FWRK(I,JAT) + DF(I)
          ENDDO

          DO I = 1,9
            SWRK(I,JJAT) = SWRK(I,JJAT) + DS(I,1)
            SWRK(I,IJAT) = SWRK(I,IJAT) + DS(I,2) * FAC

!           print *,JAT,IAT,DS(I,2)
          ENDDO
C
        ENDDO
      ENDDO

      IF(GOPARR) THEN
        CALL RSM_GSUMF( 9999,DG  ,3*NAT*NSHEL0A)
        CALL RSM_GSUMF(10000,DWRK,3*NAT*LL2)
        CALL RSM_GSUMF(10001,FWRK,3*    NAT)
        CALL RSM_GSUMF(10002,SWRK,9*    NN2)
      ENDIF
C
C     SYMMETRIZE
C
      DO IAT = 1,NAT
        IIAT = ( IAT * (IAT-1) ) / 2 + IAT
        FAC  = ( SWRK(2,IIAT) + SWRK(4,IIAT) ) / 2.0D+00
        SWRK(2,IIAT) = FAC
        SWRK(4,IIAT) = FAC
        FAC  = ( SWRK(3,IIAT) + SWRK(7,IIAT) ) / 2.0D+00
        SWRK(3,IIAT) = FAC
        SWRK(7,IIAT) = FAC
        FAC  = ( SWRK(6,IIAT) + SWRK(8,IIAT) ) / 2.0D+00
        SWRK(6,IIAT) = FAC
        SWRK(8,IIAT) = FAC
      ENDDO
C
C
C
      DO I=1,NAT
        DO J=1,3
          DO K=1,NQMT0A
            VAL = 0.0D+00
            DO L=1,NSHEL0A
              VAL = VAL + TQ(L,K)*DG(L,J,I)
            ENDDO

            GD(K,J,I) = GD(K,J,I) + VAL
          ENDDO
        ENDDO
      ENDDO
C
      DO I=1,3*NAT*LL2
        FD(I) = FD(I) + DWRK(I)
      ENDDO

      DO I=1,NAT
        DO J=1,3
          EG(J,I) = EG(J,I) + FWRK(J,I)
        ENDDO
      ENDDO

      DO I=1,NN2
        DO J=1,9
          EH(J,I) = EH(J,I) + SWRK(J,I)
        ENDDO
      ENDDO
C
      DEALLOCATE(GTMP,TRNV,DWRK,SWRK,FWRK,DG)
C
      RETURN
      END
C*MODULE RSM_SDDINT  *DECK RSM_OSDER1ACP
C>
C>    @brief   compute derivatives with Obara-Saika in RSM_MKDYMT1CP
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   JGTI: JAT is greater than IAT, or not
C>             AI: the exponent of I shell
C>             AJ: the exponent of J shell
C>             DAB: density matrix
C>             DIJ: product of normalized factors of shells I and J
C>             DKL: product of normalized factors of shells K and L
C>             GTMP: data computed in RSM_OSINT1
C>             MINI, MINJ, MINK, MINL: starting counters of shells
C>             MAXI, MAXJ, MAXK, MAXL: ending counter of shells
C>             MINIM: starting counters of the shell, which
C>                    angular momentum is I-1
C>             MAXIP: ending counter of the shell, which
C>                    angular momentum is I+1
C>             MINJM: starting counters of the shell, which
C>                    angular momentum is J-1
C>             MAXJP: ending counter of the shell, which
C>                    angular momentum is J+1
C>             MINJMM: starting counters of the shell, which
C>                    angular momentum is J-2
C>             MAXJPP: ending counter of the shell, which
C>                    angular momentum is J+2
C>             LOCI: location of the basis function in shell I
C>             LOCJ: location of the basis function in shell J
C>             KL: total number of K-L pairs of ABSs
C>             D01X: derivatives with respect X coordinate
C>             D01Y: derivatives with respect Y coordinate
C>             D01Z: derivatives with respect Z coordinate
C>             DF: gradient
C>             DS: hessian
C>

      SUBROUTINE RSM_OSDER1ACP(JGTI,AI,AJ,DAB,DIJ,DKL,GTMP,
     *                        MINI,MAXI,MINJ,MAXJ,MINK,MAXK,MINL,MAXL,
     *                        MINIM,MAXIP,MINJM,MAXJP,MINJMM,MAXJPP,
     *                        LOCI,LOCJ,KL,
     *                        D01X,D01Y,D01Z,DF,DS)
      IMPLICIT NONE
C
      LOGICAL,          INTENT(IN   ) :: JGTI
      INTEGER,          INTENT(IN   ) :: MINI,MAXI,MINJ,MAXJ,MINK,MAXK,
     *                                   MINL,MAXL,MINIM,MAXIP,MINJM,
     *                                   MAXJP,MINJMM,MAXJPP,
     *                                   LOCI,LOCJ,KL
      DOUBLE PRECISION, INTENT(IN   ) :: AI, AJ, DAB(*),DIJ(*), DKL, 
     *                                   GTMP(196000)
      DOUBLE PRECISION, INTENT(INOUT) :: D01X(225,*),D01Y(225,*),
     *                                   D01Z(225,*),DF(36,3),DS(36,9,2)
C
      DOUBLE PRECISION      :: WRK1(84,84,36), 
     *                         WRK2X(35,35), WRK2Y(35,35), WRK2Z(35,35),
     *                         WRK3X(35), WRK3Y(35), WRK3Z(35)
C
      INTEGER               :: JP(3,56), JM(3,56)
      DOUBLE PRECISION      :: RIN(3,56)

      DATA JP/ 2, 3, 4,
     *         5, 8, 9,
     *         8, 6,10,
     *         9,10, 7,
     *        11,14,15,
     *        16,12,17,
     *        18,19,13,
     *        14,16,20,
     *        15,20,18,
     *        20,17,19,
     *        21,24,25,
     *        26,22,27,
     *        28,29,23,
     *        24,30,33,
     *        25,33,31,
     *        30,26,34,
     *        34,27,32,
     *        31,35,28,
     *        35,32,29,
     *        33,34,35,
     *        36,39,40,
     *        41,37,42,
     *        43,44,38,
     *        39,45,51,
     *        40,51,46,
     *        47,41,52,
     *        52,42,48,
     *        49,53,43,
     *        53,50,44,
     *        45,47,54,
     *        46,55,49,
     *        56,48,50,
     *        51,54,55,
     *        54,52,56,
     *        55,56,53,
     *        57,60,61,
     *        62,58,63,
     *        64,65,59,
     *        60,66,72,
     *        61,72,67,
     *        68,62,73,
     *        73,63,69,
     *        70,74,64,
     *        74,71,65,
     *        66,75,78,
     *        67,79,76,
     *        75,68,80,
     *        81,69,77,
     *        76,82,70,
     *        83,77,71,
     *        72,78,79,
     *        80,73,81,
     *        82,83,74,
     *        78,80,84,
     *        79,84,82,
     *        84,81,83/ 
      DATA JM/ 1, 1, 1,
     *         1, 1, 1,
     *         1, 1, 1,
     *         1, 1, 1,
     *         2, 1, 1,
     *         1, 3, 1,
     *         1, 1, 4,
     *         3, 2, 1,
     *         4, 1, 2,
     *         1, 4, 3,
     *         5, 1, 1,
     *         1, 6, 1,
     *         1, 1, 7,
     *         8, 5, 1,
     *         9, 1, 5,
     *         6, 8, 1,
     *         1,10, 6,
     *         7, 1, 9,
     *         1, 7,10,
     *        10, 9, 8,
     *        11, 1, 1,
     *         1,12, 1,
     *         1, 1,13,
     *        14,11, 1,
     *        15, 1,11,
     *        12,16, 1,
     *         1,17,12,
     *        13, 1,18,
     *         1,13,19,
     *        16,14, 1,
     *        18, 1,15,
     *         1,19,17,
     *        20,15,14,
     *        17,20,16,
     *        19,18,20,
     *        21, 1, 1,
     *         1,22, 1,
     *         1, 1,23,
     *        24,21, 1,
     *        25, 1,21,
     *        22,26, 1,
     *         1,27,22,
     *        23, 1,28,
     *         1,23,29,
     *        30,24, 1,
     *        31, 1,25,
     *        26,30, 1,
     *         1,32,27,
     *        28, 1,31,
     *         1,29,32,
     *        33,25,24,
     *        27,34,26,
     *        29,28,35,
     *        34,33,30,
     *        35,31,33,
     *        32,35,34/
      DATA RIN/0.0D+00,0.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,1.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,1.0D+00,
     *         2.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,0.0D+00,
     *         1.0D+00,0.0D+00,1.0D+00,
     *         0.0D+00,1.0D+00,1.0D+00,
     *         3.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,3.0D+00,
     *         2.0D+00,1.0D+00,0.0D+00,
     *         2.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,2.0D+00,0.0D+00,
     *         0.0D+00,2.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,2.0D+00,
     *         0.0D+00,1.0D+00,2.0D+00,
     *         1.0D+00,1.0D+00,1.0D+00,
     *         4.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,4.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,4.0D+00,
     *         3.0D+00,1.0D+00,0.0D+00,
     *         3.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,3.0D+00,
     *         0.0D+00,1.0D+00,3.0D+00,
     *         2.0D+00,2.0D+00,0.0D+00,
     *         2.0D+00,0.0D+00,2.0D+00,
     *         0.0D+00,2.0D+00,2.0D+00,
     *         2.0D+00,1.0D+00,1.0D+00,
     *         1.0D+00,2.0D+00,1.0D+00,
     *         1.0D+00,1.0D+00,2.0D+00,
     *         5.0D+00,0.0D+00,0.0D+00,
     *         0.0D+00,5.0D+00,0.0D+00,
     *         0.0D+00,0.0D+00,5.0D+00,
     *         4.0D+00,1.0D+00,0.0D+00,
     *         4.0D+00,0.0D+00,1.0D+00,
     *         1.0D+00,4.0D+00,0.0D+00,
     *         0.0D+00,4.0D+00,1.0D+00,
     *         1.0D+00,0.0D+00,4.0D+00,
     *         0.0D+00,1.0D+00,4.0D+00,
     *         3.0D+00,2.0D+00,0.0D+00,
     *         3.0D+00,0.0D+00,2.0D+00,
     *         2.0D+00,3.0D+00,0.0D+00,
     *         0.0D+00,3.0D+00,2.0D+00,
     *         2.0D+00,0.0D+00,3.0D+00,
     *         0.0D+00,2.0D+00,3.0D+00,
     *         3.0D+00,1.0D+00,1.0D+00,
     *         1.0D+00,3.0D+00,1.0D+00,
     *         1.0D+00,1.0D+00,3.0D+00,
     *         2.0D+00,2.0D+00,1.0D+00,
     *         2.0D+00,1.0D+00,2.0D+00,
     *         1.0D+00,2.0D+00,2.0D+00/
C
      INTEGER :: I, J, IJ, K, L, NN, MM, IN, JN, IJN,
     *           JPX, JPY, JPZ, JMX, JMY, JMZ,
     *           IPX, IPY, IPZ, IMX, IMY, IMZ
      DOUBLE PRECISION :: TAI,TAJ, DX,DY,DZ, DENSITY0,DENSITY, RX,RY,RZ,
     *                    X,Y,Z, DXX,DYX,DZX, DXY,DYY,DZY, DXZ,DYZ,DZZ,
     *                    XX, XY, XZ, YX, YY, YZ, ZX, ZY, ZZ
C
      TAI = AI+AI
      TAJ = AJ+AJ
      NN = 0
      DO I=MINIM,MAXIP
        DO J=MINJMM,MAXJPP
          MM = 0
          DO K=MINK,MAXK
            DO L=MINL,MAXL
              NN = NN + 1
              MM = MM + 1

              WRK1(J,I,MM) = GTMP(NN)
            ENDDO
          ENDDO
        ENDDO
      ENDDO

      DO K=1,KL
C
C       (I,J')
C
        DX = 0.0D+00
        DY = 0.0D+00
        DZ = 0.0D+00

        IJ = 0
        DO I=MINI,MAXI
          IN = LOCI + I
          DO J=MINJ,MAXJ
            JN = LOCJ + J
            IJ = IJ + 1

            IF(JN > IN) THEN
              IJN = JN*(JN-1)/2 + IN
            ELSE
              IJN = IN*(IN-1)/2 + JN
            ENDIF

            DENSITY0= DIJ(IJ)*DKL
            DENSITY = (DENSITY0+DENSITY0)*DAB(IJN)

            JPX = JP(1,J)
            JPY = JP(2,J)
            JPZ = JP(3,J)

            JMX = JM(1,J)
            JMY = JM(2,J)
            JMZ = JM(3,J)

            RX  = RIN(1,J)
            RY  = RIN(2,J)
            RZ  = RIN(3,J)
        
            X   = TAJ*WRK1(JPX,I,K) - RX*WRK1(JMX,I,K)
            Y   = TAJ*WRK1(JPY,I,K) - RY*WRK1(JMY,I,K)
            Z   = TAJ*WRK1(JPZ,I,K) - RZ*WRK1(JMZ,I,K)

            D01X(IJ,K) = D01X(IJ,K) + X*DENSITY0
            D01Y(IJ,K) = D01Y(IJ,K) + Y*DENSITY0
            D01Z(IJ,K) = D01Z(IJ,K) + Z*DENSITY0

            DX         = DX + X*DENSITY
            DY         = DY + Y*DENSITY
            DZ         = DZ + Z*DENSITY
          ENDDO
        ENDDO

        DF(K,1) = DF(K,1) + DX
        DF(K,2) = DF(K,2) + DY
        DF(K,3) = DF(K,3) + DZ
C
C       (I',J')
C
        DXX = 0.0D+00
        DYX = 0.0D+00
        DZX = 0.0D+00
        DXY = 0.0D+00
        DYY = 0.0D+00
        DZY = 0.0D+00
        DXZ = 0.0D+00
        DYZ = 0.0D+00
        DZZ = 0.0D+00
        DO J=MINJM,MAXJP
          DO I=MINI,MAXI
            IPX = JP(1,I)
            IPY = JP(2,I)
            IPZ = JP(3,I)

            IMX = JM(1,I)
            IMY = JM(2,I)
            IMZ = JM(3,I)

            RX  = RIN(1,I)
            RY  = RIN(2,I)
            RZ  = RIN(3,I)

            WRK2X(J,I) = TAI*WRK1(J,IPX,K) - RX*WRK1(J,IMX,K)
            WRK2Y(J,I) = TAI*WRK1(J,IPY,K) - RY*WRK1(J,IMY,K)
            WRK2Z(J,I) = TAI*WRK1(J,IPZ,K) - RZ*WRK1(J,IMZ,K)
          ENDDO
        ENDDO
  
        IJ = 0
        DO I=MINI,MAXI
          IN = LOCI + I
          DO J=MINJ,MAXJ
            JN = LOCJ + J

            IJ = IJ + 1
           
            IF(JN > IN) THEN
              IJN = JN*(JN-1)/2 + IN
            ELSE
              IJN = IN*(IN-1)/2 + JN
            ENDIF

            DENSITY = DIJ(IJ)*DAB(IJN)*DKL

            JPX = JP(1,J)
            JPY = JP(2,J)
            JPZ = JP(3,J)

            JMX = JM(1,J)
            JMY = JM(2,J)
            JMZ = JM(3,J)

            RX  = RIN(1,J)
            RY  = RIN(2,J)
            RZ  = RIN(3,J)
C
C           XX, XY, XZ (I , J)
C
            XX = TAJ*WRK2X(JPX,I) - RX*WRK2X(JMX,I)
            XY = TAJ*WRK2X(JPY,I) - RY*WRK2X(JMY,I)
            XZ = TAJ*WRK2X(JPZ,I) - RZ*WRK2X(JMZ,I)
C
C           YX, YY, YZ
C
            YX = TAJ*WRK2Y(JPX,I) - RX*WRK2Y(JMX,I)
            YY = TAJ*WRK2Y(JPY,I) - RY*WRK2Y(JMY,I)
            YZ = TAJ*WRK2Y(JPZ,I) - RZ*WRK2Y(JMZ,I)
C
C           ZX, ZY, ZZ
C
            ZX = TAJ*WRK2Z(JPX,I) - RX*WRK2Z(JMX,I)
            ZY = TAJ*WRK2Z(JPY,I) - RY*WRK2Z(JMY,I)
            ZZ = TAJ*WRK2Z(JPZ,I) - RZ*WRK2Z(JMZ,I)
C
            IF(.NOT.JGTI) THEN
              DXX = DXX + XX*DENSITY
              DYX = DYX + XY*DENSITY
              DZX = DZX + XZ*DENSITY
              DXY = DXY + YX*DENSITY
              DYY = DYY + YY*DENSITY
              DZY = DZY + YZ*DENSITY
              DXZ = DXZ + ZX*DENSITY
              DYZ = DYZ + ZY*DENSITY
              DZZ = DZZ + ZZ*DENSITY
            ELSE
              DXX = DXX + XX*DENSITY
              DYX = DYX + YX*DENSITY
              DZX = DZX + ZX*DENSITY
              DXY = DXY + XY*DENSITY
              DYY = DYY + YY*DENSITY
              DZY = DZY + ZY*DENSITY
              DXZ = DXZ + XZ*DENSITY
              DYZ = DYZ + YZ*DENSITY
              DZZ = DZZ + ZZ*DENSITY
            ENDIF
          ENDDO
        ENDDO

        DS(K,1,2) = DS(K,1,2) + DXX
        DS(K,2,2) = DS(K,2,2) + DYX
        DS(K,3,2) = DS(K,3,2) + DZX
        DS(K,4,2) = DS(K,4,2) + DXY
        DS(K,5,2) = DS(K,5,2) + DYY
        DS(K,6,2) = DS(K,6,2) + DZY
        DS(K,7,2) = DS(K,7,2) + DXZ
        DS(K,8,2) = DS(K,8,2) + DYZ
        DS(K,9,2) = DS(K,9,2) + DZZ
C
C       (I,J'')
C
        DXX = 0.0D+00
        DYX = 0.0D+00
        DZX = 0.0D+00
        DXY = 0.0D+00
        DYY = 0.0D+00
        DZY = 0.0D+00
        DXZ = 0.0D+00
        DYZ = 0.0D+00
        DZZ = 0.0D+00
        IJ = 0 
        DO I=MINI,MAXI
          IN = LOCI + I
          DO J=MINJM,MAXJP
            JPX = JP(1,J)
            JPY = JP(2,J)
            JPZ = JP(3,J)

            JMX = JM(1,J)
            JMY = JM(2,J)
            JMZ = JM(3,J)

            RX  = RIN(1,J)
            RY  = RIN(2,J)
            RZ  = RIN(3,J)

            WRK3X(J) = TAJ*WRK1(JPX,I,K) - RX*WRK1(JMX,I,K)
            WRK3Y(J) = TAJ*WRK1(JPY,I,K) - RY*WRK1(JMY,I,K)
            WRK3Z(J) = TAJ*WRK1(JPZ,I,K) - RZ*WRK1(JMZ,I,K)
          ENDDO

          DO J=MINJ,MAXJ
            JN = LOCJ + J
            IJ = IJ + 1

            IF(JN > IN) THEN
              IJN = JN*(JN-1)/2 + IN
            ELSE
              IJN = IN*(IN-1)/2 + JN
            ENDIF

            DENSITY = (DIJ(IJ)+DIJ(IJ))*DAB(IJN)*DKL

            JPX = JP(1,J)
            JPY = JP(2,J)
            JPZ = JP(3,J)

            JMX = JM(1,J)
            JMY = JM(2,J)
            JMZ = JM(3,J)

            RX  = RIN(1,J)
            RY  = RIN(2,J)
            RZ  = RIN(3,J)
C
C           XX, XY, XZ
C
            XX = TAJ*WRK3X(JPX) - RX*WRK3X(JMX)
            XY = TAJ*WRK3X(JPY) - RY*WRK3X(JMY)
            XZ = TAJ*WRK3X(JPZ) - RZ*WRK3X(JMZ)
C
C           YX, YY, YZ
C
            YX = TAJ*WRK3Y(JPX) - RX*WRK3Y(JMX)
            YY = TAJ*WRK3Y(JPY) - RY*WRK3Y(JMY)
            YZ = TAJ*WRK3Y(JPZ) - RZ*WRK3Y(JMZ)
C
C           ZX, ZY, ZZ
C
            ZX = TAJ*WRK3Z(JPX) - RX*WRK3Z(JMX)
            ZY = TAJ*WRK3Z(JPY) - RY*WRK3Z(JMY)
            ZZ = TAJ*WRK3Z(JPZ) - RZ*WRK3Z(JMZ)

            DXX = DXX + XX*DENSITY
            DYX = DYX + YX*DENSITY
            DZX = DZX + ZX*DENSITY
            DXY = DXY + XY*DENSITY
            DYY = DYY + YY*DENSITY
            DZY = DZY + ZY*DENSITY
            DXZ = DXZ + XZ*DENSITY
            DYZ = DYZ + YZ*DENSITY
            DZZ = DZZ + ZZ*DENSITY
          ENDDO
        ENDDO

        DS(K,1,1) = DS(K,1,1) + DXX
        DS(K,2,1) = DS(K,2,1) + DYX
        DS(K,3,1) = DS(K,3,1) + DZX
        DS(K,4,1) = DS(K,4,1) + DXY
        DS(K,5,1) = DS(K,5,1) + DYY
        DS(K,6,1) = DS(K,6,1) + DZY
        DS(K,7,1) = DS(K,7,1) + DXZ
        DS(K,8,1) = DS(K,8,1) + DYZ
        DS(K,9,1) = DS(K,9,1) + DZZ
      ENDDO
C
      RETURN
      END

C*MODULE RSM_BOYSMOD  *DECK RSM_FM
C>
C>    @brief   compute boys function 
C>
C>    @author  Daisuke Yokogawa
C>
C>    @param   X: variable
C>             NP1: max N (+1)
C>             FF: boys function
C>

      SUBROUTINE RSM_FFUNC(X,NP1,FF)

      IMPLICIT NONE

      DOUBLE PRECISION, INTENT(IN   ) :: X
      INTEGER,          INTENT(IN   ) :: NP1
      DOUBLE PRECISION, INTENT(  OUT) :: FF(1:NP1)

      DOUBLE PRECISION, PARAMETER     :: PID4 = 0.78539816339744831D+00

      INTEGER                :: N, M, J
      DOUBLE PRECISION       :: XX, FAC, TERMO, TERMN, VAL, EP, DELJ

      N = NP1 - 1

      XX = X + X

      EP = 0.0D+00
      IF(X <= 180.0D+00) EP = EXP(-X)

      IF(X > 30.0D+00) THEN
        FAC   = 1.0D+00
        TERMO = 1.0D+00/XX
        VAL   = TERMO
        DO 
          FAC = FAC - 2.0D+00
          TERMN = FAC*TERMO/XX

          IF ( TERMN > TERMO ) EXIT
          TERMO = TERMN
          VAL = VAL + TERMO
        ENDDO

        FF(1) = SQRT(PID4/X) - EP*VAL
C
C       upward recursion
C
        FAC = 1.0D+00
        DO M=1,N
          FF(M+1) = (FAC*FF(M) - EP)/XX
          FAC = FAC + 2.0D+00
        ENDDO 
      ELSE
        J = MAX(INT(X - N + 0.5D+00), 0)

        TERMO = 1.0D+00
        FAC   = REAL(N,8) + 0.5D+00
        VAL   = 1.0D+00
        DO M=1,J
          FAC = FAC + 1.0D+00
          TERMO = TERMO*X/FAC

          VAL   = VAL + TERMO
        ENDDO

        DO 
          FAC = FAC + 1.0D+00
          TERMO = TERMO*X/FAC

          IF(TERMO < VAL*1.0D-25) EXIT
          VAL   = VAL + TERMO
        ENDDO

        FF(NP1) = VAL*EP/REAL(N+N+1,8)
C
C       downward recursion
C
        FAC = REAL(N,8) + REAL(N,8) - 1.0D+00
        DO M=N,1,-1
          FF(M) = (XX*FF(M+1) + EP)/FAC
          FAC = FAC - 2.0D+00
        ENDDO

      ENDIF

      END SUBROUTINE
